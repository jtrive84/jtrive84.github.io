<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-02-01">
<meta name="description" content="Aggregation with data.table">

<title>Aggregation with data.table – The Pleasure of Finding Things Out: A blog by James Triveri</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">The Pleasure of Finding Things Out: A blog by James Triveri</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jtrive84/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jamestriveri/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Aggregation with data.table</h1>
                  <div>
        <div class="description">
          Aggregation with data.table
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 1, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>data.table is a highly optimizedlibrary which improves upon R’s standard data.frame via the data.table object. data.tables can be used in any scenario that accepts a data.frame, and thus can be used as a replacement for the standard data.frame is all scenarios.</p>
<p>Due to the highly optimized nature of data.table, aggregate operations are much faster compared with standard R builtins like <code>aggregate</code>. However, the syntax takes a little getting used to. In this article, we’ll demonstrate how to perform various common aggregate operations using the data.table library.</p>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>Throughout this article, we’ll work with a simulated loss frequency dataset:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"data.table"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">516</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>DT0 <span class="ot">=</span> <span class="fu">CJ</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">district=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span> ,<span class="dv">3</span> ,<span class="dv">4</span>), <span class="at">group=</span><span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>),  </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">age=</span><span class="fu">c</span>(<span class="st">"&lt;25"</span>, <span class="st">"25-34"</span>, <span class="st">"35-49"</span>, <span class="st">"&gt;50"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>DT0[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">claims=</span><span class="fu">rpois</span>(<span class="fu">nrow</span>(DT), <span class="dv">100</span>), </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">holders=</span><span class="fu">sample</span>(<span class="dv">1000</span><span class="sc">:</span><span class="dv">5000</span>, <span class="at">size=</span><span class="fu">nrow</span>(DT), <span class="at">replace=</span><span class="cn">FALSE</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    )]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Table of adjustment factors. </span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>DT1 <span class="ot">=</span> <span class="fu">data.table</span>(</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">age=</span><span class="fu">c</span>(<span class="st">"&lt;25"</span>, <span class="st">"25-34"</span>, <span class="st">"35-49"</span>, <span class="st">"&gt;50"</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">adj=</span><span class="fu">c</span>(<span class="fl">1.50</span>, <span class="fl">1.075</span>, .<span class="dv">85</span>, .<span class="dv">975</span>),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors=</span><span class="cn">FALSE</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>DT <span class="ot">=</span> DT1[DT0, on<span class="ot">=</span><span class="st">"age"</span>]</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>DT[,claims<span class="sc">:</span><span class="er">=</span><span class="fu">as.integer</span>(claims <span class="sc">*</span> adj)]</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>DT[,adj<span class="sc">:</span><span class="er">=</span><span class="cn">NULL</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Taking a look at the first few records yields:</p>
<pre><code>     age district group claims holders
1: 25-34        1     A     95    4359
2: 35-49        1     A     92    3764
3:   &lt;25        1     A    157    4613
4:   &gt;50        1     A    111    2529
5: 25-34        1     B     90    2105
6: 35-49        1     B     97    3379</code></pre>
</section>
<section id="aggregate-operations" class="level3">
<h3 class="anchored" data-anchor-id="aggregate-operations">Aggregate Operations</h3>
<p>Before proceeding, we should highlight data.table’s general calling convention, that when understood, can be used to translate data.table expressions of arbitrary complexity into 3 steps:</p>
<blockquote class="blockquote">
<p><strong><code>DT[i, j, by]</code></strong></p>
</blockquote>
<p>Which translates to:</p>
<blockquote class="blockquote">
<p>Take <strong><code>DT</code></strong>, subset rows using <strong><code>i</code></strong>, then calculate <strong><code>j</code></strong> grouped by <strong><code>by</code></strong>.</p>
</blockquote>
<p>This can be represented in a diagram as follows:</p>
<pre><code>DT[ i, j, by ] # + extra arguments
    |  |  |
    |  |   -------&gt; grouped by what?
    |   -------&gt; what to do?
     ---&gt; on which rows?</code></pre>
<p>This may not be immediately clear, but should start to make sense as we look at examples.</p>
</section>
<section id="returning-a-single-value-from-a-single-column" class="level3">
<h3 class="anchored" data-anchor-id="returning-a-single-value-from-a-single-column">Returning a Single Value from a Single Column</h3>
<p>Referring to <code>DT</code> from above, the total number of policyholders can be determined as:</p>
<pre><code>&gt; DT[,sum(holders)]
[1] 190885</code></pre>
<p>To compute the total number of policyholders and claims, run:</p>
<pre><code>&gt; DT[,.(holders=sum(holders), claims=sum(claims))]
   holders claims
1:  190885   7018</code></pre>
<p>This returns a 1-row data.table with the total number of holders and claims. To change fieldnames in the resulting table, change the name on the left-hand side for the desired field within the <code>sum</code> expression:</p>
<pre><code>&gt; DT[,.(total_holders=sum(holders), total_claims=sum(claims))]
   total_holders total_claims
1:        190885         7018 </code></pre>
</section>
<section id="assigning-an-aggregate-to-each-row-of-an-existing-table" class="level3">
<h3 class="anchored" data-anchor-id="assigning-an-aggregate-to-each-row-of-an-existing-table">Assigning an Aggregate to Each Row of an Existing Table</h3>
<p>It may be necessary to assign an aggregate value from a table to each record in the same table. This can be accomplished using the <code>:=</code> operator. Note that when computing aggregate operations that utilize <code>:=</code>, the number of rows in the resulting table will not change. Next we assign the total number of claims to each row in DT in a column identified as total_claims:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DT[,total_claims<span class="sc">:</span><span class="er">=</span><span class="fu">sum</span>(claims)]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">head</span>(DT)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>     age district group claims holders total_claims</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>     A     <span class="dv">95</span>    <span class="dv">4359</span>         <span class="dv">7018</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>     A     <span class="dv">92</span>    <span class="dv">3764</span>         <span class="dv">7018</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">1</span>     A    <span class="dv">157</span>    <span class="dv">4613</span>         <span class="dv">7018</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">1</span>     A    <span class="dv">111</span>    <span class="dv">2529</span>         <span class="dv">7018</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>     B     <span class="dv">90</span>    <span class="dv">2105</span>         <span class="dv">7018</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>     B     <span class="dv">97</span>    <span class="dv">3379</span>         <span class="dv">7018</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we want to aggregate two or more columns, it is necessary to use a slight variation of the <code>:=</code> operator. Next we include total_claims and total_holders:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DT[, <span class="st">":="</span> (<span class="at">total_claims=</span><span class="fu">sum</span>(claims), <span class="at">total_holders=</span><span class="fu">sum</span>(holders))]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">head</span>(DT)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>     age district group claims holders total_claims total_holders</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>     A     <span class="dv">95</span>    <span class="dv">4359</span>         <span class="dv">7018</span>        <span class="dv">190885</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>     A     <span class="dv">92</span>    <span class="dv">3764</span>         <span class="dv">7018</span>        <span class="dv">190885</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">1</span>     A    <span class="dv">157</span>    <span class="dv">4613</span>         <span class="dv">7018</span>        <span class="dv">190885</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">1</span>     A    <span class="dv">111</span>    <span class="dv">2529</span>         <span class="dv">7018</span>        <span class="dv">190885</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>     B     <span class="dv">90</span>    <span class="dv">2105</span>         <span class="dv">7018</span>        <span class="dv">190885</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>     B     <span class="dv">97</span>    <span class="dv">3379</span>         <span class="dv">7018</span>        <span class="dv">190885</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This differs from the standard syntax in two ways: First, the <code>:=</code> operator is specified upfront, and is surrounded by quotes (<code>":="</code>). Second, when specifying the columns to aggregate, we use <code>=</code>, not <code>:=</code>, since this is already specified upfront. It is also possible to use the modified syntax for adding a single column. The following expressions are identical:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>DT[,total_claims<span class="sc">:</span><span class="er">=</span><span class="fu">sum</span>(claims)]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>DT[,<span class="st">":="</span> (<span class="at">total_claims=</span><span class="fu">sum</span>(claims))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="aggregate-operations-by-group" class="level3">
<h3 class="anchored" data-anchor-id="aggregate-operations-by-group">Aggregate Operations by Group</h3>
<p>To perform aggregate operations by group, the syntax introduced in the previous examples remains unchanged: The only difference is the addition of the <code>by</code> keyword.</p>
<p>In DT, there are four distinct levels in each of age, district and group:</p>
<pre><code>&gt; table(DT$age)

  &lt;25   &gt;50 25-34 35-49 
   16    16    16    16 </code></pre>
<pre><code>&gt; table(DT$district)

 1  2  3  4 
16 16 16 16 </code></pre>
<pre><code>&gt; table(DT$district)

 A  B  C  D 
16 16 16 16  </code></pre>
<p>To calculate the total number of claims by each level in age, run:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DT[,<span class="fu">sum</span>(claims), by<span class="ot">=</span>age]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>     age   V1</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span> <span class="dv">25-34</span> <span class="dv">1643</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span><span class="sc">:</span> <span class="dv">35-49</span> <span class="dv">1363</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span> <span class="dv">2410</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span> <span class="dv">1602</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This returns total number of claims in a single unnamed column (identified as V1 by default). In order to preserve column names, we use the syntax from before, updated with <code>by</code>. In what follows, we compute the total number of claims and policyholders by age while preserving column names:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DT[,.(<span class="at">claims=</span><span class="fu">sum</span>(claims), <span class="at">holders=</span><span class="fu">sum</span>(holders)), by<span class="ot">=</span><span class="st">"age"</span>]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>     age claims holders</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">:</span> <span class="dv">25-34</span>   <span class="dv">1643</span>   <span class="dv">42109</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span><span class="sc">:</span> <span class="dv">35-49</span>   <span class="dv">1363</span>   <span class="dv">52062</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>   <span class="dv">2410</span>   <span class="dv">48932</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>   <span class="dv">1602</span>   <span class="dv">47782</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When it is necessary to aggregate by two or more columns, we supply a vector of column names over which to aggregate. To determine the total number of claims and policyholders by age and district, do:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DT[,.(<span class="at">claims=</span><span class="fu">sum</span>(claims), <span class="at">holders=</span><span class="fu">sum</span>(holders)), by<span class="ot">=</span><span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"district"</span>)]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>      age district claims holders</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>    <span class="dv">384</span>   <span class="dv">10080</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>    <span class="dv">345</span>   <span class="dv">13576</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">1</span>    <span class="dv">649</span>   <span class="dv">13665</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">1</span>    <span class="dv">423</span>   <span class="dv">10747</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">2</span>    <span class="dv">422</span>   <span class="dv">12495</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">2</span>    <span class="dv">343</span>   <span class="dv">13462</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">2</span>    <span class="dv">587</span>   <span class="dv">11348</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">8</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">2</span>    <span class="dv">424</span>   <span class="dv">11888</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">3</span>    <span class="dv">420</span>    <span class="dv">8101</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">3</span>    <span class="dv">330</span>   <span class="dv">14933</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="dv">11</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">3</span>    <span class="dv">582</span>   <span class="dv">13167</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="dv">12</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">3</span>    <span class="dv">385</span>   <span class="dv">13730</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="dv">13</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">4</span>    <span class="dv">417</span>   <span class="dv">11433</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="dv">14</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">4</span>    <span class="dv">345</span>   <span class="dv">10091</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">4</span>    <span class="dv">592</span>   <span class="dv">10752</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="dv">16</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">4</span>    <span class="dv">370</span>   <span class="dv">11417</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="assigning-aggregate-values-by-group-to-each-row-in-existing-table" class="level3">
<h3 class="anchored" data-anchor-id="assigning-aggregate-values-by-group-to-each-row-in-existing-table">Assigning Aggregate Values by Group to Each Row in Existing Table</h3>
<p>As before, aggrergate operations by group can be assigned to an existing table. Next we assign the average number of claims and policyholders by age to each record in the original dataset (note that I’ve removed total_claims and total_holders to simplify viewing the tables. It is fine to keep them in if you’re following along):</p>
<pre><code>&gt; DT[,":="(avg_nbr_claims=mean(claims), avg_nbr_holders=mean(holders)), by="age"]
&gt; head(DT)
     age district group claims holders avg_nbr_claims avg_nbr_holders
1: 25-34        1     A     95    4359       102.6875        2631.812
2: 35-49        1     A     92    3764        85.1875        3253.875
3:   &lt;25        1     A    157    4613       150.6250        3058.250
4:   &gt;50        1     A    111    2529       100.1250        2986.375
5: 25-34        1     B     90    2105       102.6875        2631.812
6: 35-49        1     B     97    3379        85.1875        3253.875</code></pre>
<p>The average number of claims and policyholders by district and group can be computed as:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">head</span>(DT, <span class="dv">25</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>      age district group claims holders avg_nbr_claims avg_nbr_holders</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>     A     <span class="dv">95</span>    <span class="dv">4359</span>         <span class="fl">113.75</span>         <span class="fl">3816.25</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>     A     <span class="dv">92</span>    <span class="dv">3764</span>         <span class="fl">113.75</span>         <span class="fl">3816.25</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">1</span>     A    <span class="dv">157</span>    <span class="dv">4613</span>         <span class="fl">113.75</span>         <span class="fl">3816.25</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">1</span>     A    <span class="dv">111</span>    <span class="dv">2529</span>         <span class="fl">113.75</span>         <span class="fl">3816.25</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>     B     <span class="dv">90</span>    <span class="dv">2105</span>         <span class="fl">112.75</span>         <span class="fl">2277.50</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>     B     <span class="dv">97</span>    <span class="dv">3379</span>         <span class="fl">112.75</span>         <span class="fl">2277.50</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">1</span>     B    <span class="dv">160</span>    <span class="dv">1359</span>         <span class="fl">112.75</span>         <span class="fl">2277.50</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">8</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">1</span>     B    <span class="dv">104</span>    <span class="dv">2267</span>         <span class="fl">112.75</span>         <span class="fl">2277.50</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>     C     <span class="dv">92</span>    <span class="dv">1942</span>         <span class="fl">111.75</span>         <span class="fl">2598.25</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>     C     <span class="dv">68</span>    <span class="dv">2765</span>         <span class="fl">111.75</span>         <span class="fl">2598.25</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="dv">11</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">1</span>     C    <span class="dv">178</span>    <span class="dv">4626</span>         <span class="fl">111.75</span>         <span class="fl">2598.25</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="dv">12</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">1</span>     C    <span class="dv">109</span>    <span class="dv">1060</span>         <span class="fl">111.75</span>         <span class="fl">2598.25</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="dv">13</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>     D    <span class="dv">107</span>    <span class="dv">1674</span>         <span class="fl">112.00</span>         <span class="fl">3325.00</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="dv">14</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>     D     <span class="dv">88</span>    <span class="dv">3668</span>         <span class="fl">112.00</span>         <span class="fl">3325.00</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">1</span>     D    <span class="dv">154</span>    <span class="dv">3067</span>         <span class="fl">112.00</span>         <span class="fl">3325.00</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="dv">16</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">1</span>     D     <span class="dv">99</span>    <span class="dv">4891</span>         <span class="fl">112.00</span>         <span class="fl">3325.00</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="dv">17</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">2</span>     A     <span class="dv">96</span>    <span class="dv">4765</span>         <span class="fl">111.75</span>         <span class="fl">2748.75</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="dv">18</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">2</span>     A     <span class="dv">90</span>    <span class="dv">1526</span>         <span class="fl">111.75</span>         <span class="fl">2748.75</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="dv">19</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">2</span>     A    <span class="dv">144</span>    <span class="dv">2877</span>         <span class="fl">111.75</span>         <span class="fl">2748.75</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="dv">20</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">2</span>     A    <span class="dv">117</span>    <span class="dv">1827</span>         <span class="fl">111.75</span>         <span class="fl">2748.75</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="dv">21</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">2</span>     B    <span class="dv">118</span>    <span class="dv">2059</span>         <span class="fl">117.75</span>         <span class="fl">2778.00</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="dv">22</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">2</span>     B     <span class="dv">89</span>    <span class="dv">3323</span>         <span class="fl">117.75</span>         <span class="fl">2778.00</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="dv">23</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">2</span>     B    <span class="dv">148</span>    <span class="dv">2687</span>         <span class="fl">117.75</span>         <span class="fl">2778.00</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="dv">24</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">2</span>     B    <span class="dv">116</span>    <span class="dv">3043</span>         <span class="fl">117.75</span>         <span class="fl">2778.00</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="dv">25</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">2</span>     C    <span class="dv">105</span>    <span class="dv">3863</span>         <span class="fl">110.50</span>         <span class="fl">3931.00</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>      age district group claims holders avg_nbr_claims avg_nbr_holders</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="alternative-aggregation-specification" class="level3">
<h3 class="anchored" data-anchor-id="alternative-aggregation-specification">Alternative Aggregation Specification</h3>
<p>I will briefly discuss an alternative aggregation approach that greatly simplifies performing aggregate operations on large tables.</p>
<p>It’s hard to visualize with our example, but imagine having a table with 10’s or 100’s of columns. Performing aggregate operations as demonstrated would quickly become untenable. To address this, we can take advantage of R’s <em>special symbols</em>. We use <code>.SD</code> as a placeholder for the columns to aggregate, then pass a vector of these column names to <code>.SDcols</code>. <code>.SD</code> by default gets assigned all columns except the columns mentioned in <code>by=</code>. For example, aggregating claims and holders by age and district can be accomplished as follows:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> aggColumns <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"claims"</span>, <span class="st">"holders"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> keyColumns <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"district"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DT[,<span class="fu">lapply</span>(.SD, sum, <span class="at">na.rm=</span><span class="cn">TRUE</span>), by<span class="ot">=</span>keyColumns, .SDcols<span class="ot">=</span>aggColumns]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>      age district claims holders</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">1</span>    <span class="dv">384</span>   <span class="dv">10080</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">1</span>    <span class="dv">345</span>   <span class="dv">13576</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">1</span>    <span class="dv">649</span>   <span class="dv">13665</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">1</span>    <span class="dv">423</span>   <span class="dv">10747</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">2</span>    <span class="dv">422</span>   <span class="dv">12495</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">2</span>    <span class="dv">343</span>   <span class="dv">13462</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">2</span>    <span class="dv">587</span>   <span class="dv">11348</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a> <span class="dv">8</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">2</span>    <span class="dv">424</span>   <span class="dv">11888</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">3</span>    <span class="dv">420</span>    <span class="dv">8101</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">3</span>    <span class="dv">330</span>   <span class="dv">14933</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="dv">11</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">3</span>    <span class="dv">582</span>   <span class="dv">13167</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="dv">12</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">3</span>    <span class="dv">385</span>   <span class="dv">13730</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="dv">13</span><span class="sc">:</span> <span class="dv">25-34</span>        <span class="dv">4</span>    <span class="dv">417</span>   <span class="dv">11433</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="dv">14</span><span class="sc">:</span> <span class="dv">35-49</span>        <span class="dv">4</span>    <span class="dv">345</span>   <span class="dv">10091</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="dv">15</span><span class="sc">:</span>   <span class="er">&lt;</span><span class="dv">25</span>        <span class="dv">4</span>    <span class="dv">592</span>   <span class="dv">10752</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="dv">16</span><span class="sc">:</span>   <span class="er">&gt;</span><span class="dv">50</span>        <span class="dv">4</span>    <span class="dv">370</span>   <span class="dv">11417</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using this approach, we can write programs that assign which columns to aggregate dynamically at the point of execution.</p>
<section id="summary" class="level4">
<h4 class="anchored" data-anchor-id="summary">Summary</h4>
<p>A few things to keep in mind when performing aggregate operations in data.table:</p>
<ul>
<li><p><code>.SD</code> by default gets assigned all columns except the columns mentioned in <code>by=</code>.</p></li>
<li><p><code>.SDcols</code> represents the fields that should be aggregated (columns must be numeric).</p></li>
<li><p><code>by=</code>is similiar to SQL <code>GROUP BY</code>. Specifies the keys over which data should be aggregated.</p></li>
<li><p>If you keep the <code>:=</code> operator, the results will not be aggregated. Instead the aggregate amount of the target column will be appended to each record in the original data.table.</p></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.jtrive\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>