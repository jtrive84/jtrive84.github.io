<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-01-25">
<meta name="description" content="The bootstrap chain ladder from scratch using polars">

<title>The Bootstrap Chain Ladder from Scratch using Polars – The Pleasure of Finding Things Out: A blog by James Triveri</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">The Pleasure of Finding Things Out: A blog by James Triveri</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jtrive84/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jamestriveri/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://python-bloggers.com/"> <i class="bi bi-p-square" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">The Bootstrap Chain Ladder from Scratch using Polars</h1>
                  <div>
        <div class="description">
          The bootstrap chain ladder from scratch using polars
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">Actuarial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 25, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In an earlier <a href="https://www.jtrive.com/posts/boostrap-chainladder-python/bootstrap-chainladder-python.html">post</a>, I provided a step-by-step guide on performing the bootstrap chain ladder using Pandas. This method involves repeatedly resampling residuals from the original chain ladder model to generate a series of simulated datasets, each replicating the original data’s claims development patterns (for more background, refer to the linked article).</p>
<p>Here we again walkthrough the bootstrap chain ladder step-by-step, this time using Polars, a high-performance DataFrame library built in Rust specifically designed for efficient data processing with large datasets. Unlike Pandas which is single-threaded, Polars leverages multi-core processors resulting in faster execution for many tasks. Although not required for our work in this setting, Polars can also handle datasets larger than available memory, spilling to disk when necessary. In Pandas, we can only process datasets having size less than or equal to available system memory.</p>
<p>Although Polars offers clear advantages over Pandas in many scenarios, this particular case isn’t one of them. Polars eliminates the concept of an index, which is a core feature of Pandas. But indices are especially valuable in this context for calculating age-to-age factors, identifying values along the latest diagonal, and squaring triangles. Additionally, while some insurers may store tens or hundreds of millions of claim records in their data warehouses, losses are typically aggregated by origin and development period ahead of a reserving analysis, resulting in datasets greatly reduced in size vs.&nbsp;transactional claim data. As a consequence, reserving actuaries typically don’t work with datasets large enough to necessitate parallel processing or out-of-core computation.</p>
<p>Translating the original Pandas bootstrap chain ladder code to Polars provided a good opportunity to showcase the library’s core features. However, many operations felt much less intuitive compared to their Pandas counterparts. Even so, I see this post as a valuable reference for specific Polars operations that I’ll likely use again in the future.</p>
<p>The steps to perform the bootstrap chain ladder:</p>
<ol type="1">
<li><p>Transform loss data into cumulative triangle representation.</p></li>
<li><p>Calculate all-year volume weighted age-to-age factors.</p></li>
<li><p>Calculate the cumulative fitted triangle by applying backwards recursion, beginning with the observed cumulative losses from the latest diagonal.</p></li>
<li><p>Calculate the unscaled Pearson residuals, <span class="math inline">\(r_{p}\)</span>, degrees of freedom <span class="math inline">\(DF\)</span> and scale parameter <span class="math inline">\(\phi\)</span>.</p></li>
<li><p>Calculate the adjusted Pearson residuals, defined as <span class="math inline">\(r_{p}^{{adj}} = \sqrt{\frac{n}{DF}} \times r_{p}\)</span>.</p></li>
<li><p>For each bootstrap sample (1…1000):</p>
<ol type="i">
<li><p>Generate a sample from the adjusted Pearson residuals <span class="math inline">\(r_{p}^{{adj}}\)</span> with replacement.</p></li>
<li><p>Using the sampled adjusted Pearson residuals and fitted incremental triangle <span class="math inline">\(m\)</span>, construct the triangle of sampled incremental losses <span class="math inline">\(I_{i} = m + \hat{r}_{p}^{adj} \sqrt{m}\)</span>, where <span class="math inline">\(\hat{r}_{p}^{adj}\)</span> represents a sample with replacement from the adjusted Pearson residuals and <span class="math inline">\(m\)</span> the fitted incremental triangle.</p></li>
<li><p>Create a cumulative triangle using the result from ii., and project future losses using the chain ladder method.</p></li>
<li><p>Incorporate process variance by simulating each future projected incremental loss from a gamma distribution parameterized with mean equal to the projected loss value and variance the loss value times <span class="math inline">\(\phi\)</span>.</p></li>
<li><p>Cumulate the incremental losses, then compute the total needed reserve as the ultimate projected value minus the latest cumulative loss amount by origin period.</p></li>
</ol></li>
<li><p>Compute desired quantiles of interest from predictive distribution of bootstrap samples.</p></li>
</ol>
<p><br></p>
<p>In what follows each step is demonstrated, along with exhibits to visually assess the distribution of future losses.</p>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext watermark</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>, precision<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.precision"</span>, <span class="dv">5</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>pd.options.mode.chained_assignment <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="va">None</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(action<span class="op">=</span><span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>pl.Config(tbl_rows<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>pl.Config(float_precision<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>pl.Config(tbl_cols<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>watermark <span class="op">--</span>python <span class="op">--</span>conda <span class="op">--</span>hostname <span class="op">--</span>machine <span class="op">--</span>iversions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Python implementation: CPython
Python version       : 3.12.8
IPython version      : 8.31.0

conda environment: polars

Compiler    : MSC v.1942 64 bit (AMD64)
OS          : Windows
Release     : 11
Machine     : AMD64
Processor   : Intel64 Family 6 Model 170 Stepping 4, GenuineIntel
CPU cores   : 22
Architecture: 64bit

Hostname: JTRIZPC11

matplotlib: 3.10.0
pandas    : 2.2.3
polars    : 1.20.0
numpy     : 2.2.2
</code></pre>
</div>
</div>
<p>Start by loading the data from GitHub:</p>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load RAA dataset. </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> pl.read_csv(<span class="st">"https://gist.githubusercontent.com/jtrive84/976c80786a6e97cce7483e306562f85b/raw/06a5c8b1f823fbe2b6da15f90a672517fa5b4571/RAA.csv"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> dfraa.sort(by<span class="op">=</span>[<span class="st">"ORIGIN"</span>, <span class="st">"DEV"</span>])</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Original incremental loss data:"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Subtract 1980 from ORIGIN.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> dfraa.with_columns(pl.col(<span class="st">"ORIGIN"</span>).sub(<span class="dv">1980</span>).alias(<span class="st">"ORIGIN"</span>))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>dfraa.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original incremental loss data:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 3)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ORIGIN</th>
<th data-quarto-table-cell-role="th">DEV</th>
<th data-quarto-table-cell-role="th">VALUE</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>i64</th>
<th>i64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>5012</td>
</tr>
<tr class="even">
<td>1</td>
<td>2</td>
<td>3257</td>
</tr>
<tr class="odd">
<td>1</td>
<td>3</td>
<td>2638</td>
</tr>
<tr class="even">
<td>1</td>
<td>4</td>
<td>898</td>
</tr>
<tr class="odd">
<td>1</td>
<td>5</td>
<td>1734</td>
</tr>
<tr class="even">
<td>1</td>
<td>6</td>
<td>2642</td>
</tr>
<tr class="odd">
<td>1</td>
<td>7</td>
<td>1828</td>
</tr>
<tr class="even">
<td>1</td>
<td>8</td>
<td>599</td>
</tr>
<tr class="odd">
<td>1</td>
<td>9</td>
<td>54</td>
</tr>
<tr class="even">
<td>1</td>
<td>10</td>
<td>172</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>A number of functions are defined that will be used throughout the remainder of the article. Note that the implementations differ from the Pandas version: <code>to_cum</code> and <code>to_incr</code> accept an optional <code>as_tri</code> argument, which when set to <code>True</code> transforms the table of losses into a DataFrame formatted as a runoff triangle:</p>
<ul>
<li><p><code>to_cum</code>: Accepts an incremental loss DataFrame and returns a cumulative loss DataFrame, optionally structured as a runoff triangle.</p></li>
<li><p><code>to_incr</code>: Accepts a cumulative loss DataFrame and returns an incremental loss DataFrame, optionally structured as a runoff triangle.</p></li>
<li><p><code>get_a2a_factors</code>: Accepts a cumulative triangle and returns the all-year volume weighted age-to-age factors.</p></li>
<li><p><code>get_latest</code>: Accepts a triangle and returns the value at the latest development period by origin.</p></li>
<li><p><code>square_tri</code>: Accepts a cumulative triangle and set of age-to-age factors and projects future losses, populating the lower-right of the original cumulative triangle.</p></li>
</ul>
<p><br></p>
<p>For <code>get_a2a_factors</code>, <code>get_latest</code> and <code>square_tri</code>, a few simplifying assumptions have been made:</p>
<ol type="1">
<li>The triangles under consideration have an equal number of development and origin periods.</li>
<li>Development periods are sequential starting with 1.</li>
<li>No tail factor is included.</li>
</ol>
<div id="cell-6" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_tri(df: pl.DataFrame) <span class="op">-&gt;</span> pl.DataFrame:</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Return DataFrame structured as runoff triangle.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">        df: pd.DataFrame</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">            Loss data with columns ORIGIN, DEV and VALUE.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">        pl.DataFrame</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.pivot(index<span class="op">=</span><span class="st">"ORIGIN"</span>, on<span class="op">=</span><span class="st">"DEV"</span>, values<span class="op">=</span><span class="st">"VALUE"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_table(tri: pl.DataFrame) <span class="op">-&gt;</span> pl.DataFrame:</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Accepts a DataFrame structured as a triangle and returns the tabular </span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">    representation having columns ORIGIN, DEV and VALUE.</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">        df: pd.DataFrame</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">            Loss data structures as a runoff triangle.</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co">        pl.DataFrame</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> tri.unpivot(tri.columns[<span class="dv">1</span>:], index<span class="op">=</span>[<span class="st">"ORIGIN"</span>], variable_name<span class="op">=</span><span class="st">"DEV"</span>, value_name<span class="op">=</span><span class="st">"VALUE"</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.with_columns(pl.col(<span class="st">"DEV"</span>).cast(pl.Int32).alias(<span class="st">"DEV"</span>))</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort([<span class="st">"ORIGIN"</span>, <span class="st">"DEV"</span>])</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_cum(df: pl.DataFrame, as_tri: <span class="bu">bool</span><span class="op">=</span><span class="va">False</span>) <span class="op">-&gt;</span> pl.DataFrame:</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Accepts a DataFrame of incremental losses and returns a DataFrame</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="co">    of cumulative losses. Optionally return DataFrame as cumulative </span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="co">    triangle.</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="co">        df : pl.DataFrame</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="co">            Incremental losses.</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="co">        as_tri: bool</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="co">            Should DataFrame be returned as a triangle.</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="co">        pl.DataFrame</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    dfc <span class="op">=</span> df.with_columns(</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">"VALUE"</span>).cum_sum().over(<span class="st">"ORIGIN"</span>).alias(<span class="st">"VALUE"</span>)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> as_tri:</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> to_tri(dfc)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dfc</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_incr(df: pl.DataFrame, as_tri: <span class="bu">bool</span><span class="op">=</span><span class="va">False</span>) <span class="op">-&gt;</span> pl.DataFrame:</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a><span class="co">    Accepts a DataFrame with cumulative losses and de-cumulates.</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="co">        ctri : pl.DataFrame</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a><span class="co">            Cumulative losses.</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a><span class="co">        as_tri : bool</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="co">            Should DataFrame be returned as a triangle.</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a><span class="co">        pl.DataFrame  </span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get values at first development period.</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    first_devp_values <span class="op">=</span> df.<span class="bu">filter</span>(pl.col(<span class="st">"DEV"</span>)<span class="op">==</span><span class="dv">1</span>).select(<span class="st">"VALUE"</span>).to_numpy().flatten()</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute difference of cumulative losses by each origin period.</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.with_columns(VALUE<span class="op">=</span>(pl.col(<span class="st">"VALUE"</span>).diff()).over(<span class="st">"ORIGIN"</span>))</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> as_tri:</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert to triangle.</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        tri <span class="op">=</span> to_tri(df)</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set first development period to first_devp_values. </span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>        tri <span class="op">=</span> tri.with_columns(pl.Series(<span class="st">"1"</span>, first_devp_values))</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tri</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_a2a_factors(tri: pl.DataFrame) <span class="op">-&gt;</span> <span class="bu">list</span>[<span class="bu">tuple</span>[<span class="bu">str</span>, <span class="bu">float</span>]]:</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate all-year volume weighted age-to-age factors. </span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a><span class="co">        tri: pl.DataFrame</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a><span class="co">            Cumulative triangle.</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a><span class="co">        List of (age-to-age header, age-to-age factor).</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    max_origin <span class="op">=</span> ctri0[<span class="st">"ORIGIN"</span>].<span class="bu">max</span>()</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    all_devps <span class="op">=</span> tri.columns[<span class="dv">1</span>:]</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    dps0, dps1 <span class="op">=</span> all_devps[:<span class="op">-</span><span class="dv">1</span>], all_devps[<span class="dv">1</span>:]</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    a2a_headers <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>ii<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>jj<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> ii, jj <span class="kw">in</span> <span class="bu">zip</span>(dps0, dps1)]</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    a2a <span class="op">=</span> []</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> dp0, dp1 <span class="kw">in</span> <span class="bu">zip</span>(<span class="bu">reversed</span>(dps0), <span class="bu">reversed</span>(dps1)):</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>        v1 <span class="op">=</span> tri.select(<span class="bu">str</span>(dp0)).to_numpy().flatten()[:(max_origin <span class="op">-</span> <span class="bu">int</span>(dp1) <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>        v2 <span class="op">=</span> tri.select(<span class="bu">str</span>(dp1)).to_numpy().flatten()[:(max_origin <span class="op">-</span> <span class="bu">int</span>(dp1) <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>        a2a.append((np.nansum(v2) <span class="op">/</span> np.nansum(v1)).item())</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">zip</span>(a2a_headers, a2a[::<span class="op">-</span><span class="dv">1</span>]))</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_latest(tri: pl.DataFrame) <span class="op">-&gt;</span> <span class="bu">list</span>[<span class="bu">tuple</span>[<span class="bu">str</span>, <span class="bu">float</span>]]:</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a><span class="co">    Return the value at the latest development period by origin. </span></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a><span class="co">        tri : pl.DataFrame</span></span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a><span class="co">            Cumulative or incremental triangle.</span></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a><span class="co">        list of (origin, latest) tuples.</span></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"ORIGIN"</span> <span class="kw">in</span> tri.columns:</span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>        tri <span class="op">=</span> tri.drop(<span class="st">"ORIGIN"</span>)</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>    nbr_devps <span class="op">=</span> tri.width</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> [tri[ii, nbr_devps <span class="op">-</span> ii <span class="op">-</span> <span class="dv">1</span>] <span class="cf">for</span> ii <span class="kw">in</span> <span class="bu">range</span>(nbr_devps)]</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="bu">zip</span>(tri.columns, latest))</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> square_tri(tri: pl.DataFrame, a2a: <span class="bu">list</span>[<span class="bu">tuple</span>[<span class="bu">str</span>, <span class="bu">float</span>]]) <span class="op">-&gt;</span> pl.DataFrame:</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a><span class="co">    Project future losses for `tri` using `a2a`.</span></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a><span class="co">        tri : pl.DataFrame</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a><span class="co">            Cumulative triangle.</span></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a><span class="co">        a2a: list</span></span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a><span class="co">            Age-to-age factors.</span></span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a><span class="co">    pl.DataFrame</span></span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a><span class="co">        Original triangle with projected future losses. </span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"ORIGIN"</span> <span class="kw">in</span> tri.columns:</span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>        sqrd <span class="op">=</span> tri.drop(<span class="st">"ORIGIN"</span>)</span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>        sqrd <span class="op">=</span> tri</span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>    _, a2a_values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>a2a)</span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>    nbr_devps <span class="op">=</span> sqrd.width</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps):</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps <span class="op">-</span> r_idx, nbr_devps):</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>            sqrd[r_idx, <span class="bu">str</span>(c_idx <span class="op">+</span> <span class="dv">1</span>)] <span class="op">=</span>  sqrd[r_idx, <span class="bu">str</span>(c_idx)] <span class="op">*</span> a2a_values[c_idx <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>    sqrd <span class="op">=</span> sqrd.with_row_index(<span class="st">"ORIGIN"</span>, offset<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sqrd</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Create an incremental loss triangle, passing <code>dfraa</code> into <code>to_tri</code>:</p>
<div id="cell-8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>tri0 <span class="op">=</span> to_tri(dfraa)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Original incremental loss triangle:"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>tri0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original incremental loss triangle:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 11)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ORIGIN</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>5012</td>
<td>3257</td>
<td>2638</td>
<td>898</td>
<td>1734</td>
<td>2642</td>
<td>1828</td>
<td>599</td>
<td>54</td>
<td>172</td>
</tr>
<tr class="even">
<td>2</td>
<td>106</td>
<td>4179</td>
<td>1111</td>
<td>5270</td>
<td>3116</td>
<td>1817</td>
<td>-103</td>
<td>673</td>
<td>535</td>
<td>null</td>
</tr>
<tr class="odd">
<td>3</td>
<td>3410</td>
<td>5582</td>
<td>4881</td>
<td>2268</td>
<td>2594</td>
<td>3479</td>
<td>649</td>
<td>603</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>4</td>
<td>5655</td>
<td>5900</td>
<td>4211</td>
<td>5500</td>
<td>2159</td>
<td>2658</td>
<td>984</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>5</td>
<td>1092</td>
<td>8473</td>
<td>6271</td>
<td>6333</td>
<td>3786</td>
<td>225</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>6</td>
<td>1513</td>
<td>4932</td>
<td>5257</td>
<td>1233</td>
<td>2917</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>7</td>
<td>557</td>
<td>3463</td>
<td>6926</td>
<td>1368</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>8</td>
<td>1351</td>
<td>5596</td>
<td>6165</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>9</td>
<td>3133</td>
<td>2262</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>10</td>
<td>2063</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>Next we create a cumulative loss triangle using <code>to_cum</code> with <code>as_tri = True</code>:</p>
<div id="cell-10" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ctri0 <span class="op">=</span> to_cum(dfraa, as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Original cumulative loss triangle:"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>ctri0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original cumulative loss triangle:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 11)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ORIGIN</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>5012</td>
<td>8269</td>
<td>10907</td>
<td>11805</td>
<td>13539</td>
<td>16181</td>
<td>18009</td>
<td>18608</td>
<td>18662</td>
<td>18834</td>
</tr>
<tr class="even">
<td>2</td>
<td>106</td>
<td>4285</td>
<td>5396</td>
<td>10666</td>
<td>13782</td>
<td>15599</td>
<td>15496</td>
<td>16169</td>
<td>16704</td>
<td>null</td>
</tr>
<tr class="odd">
<td>3</td>
<td>3410</td>
<td>8992</td>
<td>13873</td>
<td>16141</td>
<td>18735</td>
<td>22214</td>
<td>22863</td>
<td>23466</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>4</td>
<td>5655</td>
<td>11555</td>
<td>15766</td>
<td>21266</td>
<td>23425</td>
<td>26083</td>
<td>27067</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>5</td>
<td>1092</td>
<td>9565</td>
<td>15836</td>
<td>22169</td>
<td>25955</td>
<td>26180</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>6</td>
<td>1513</td>
<td>6445</td>
<td>11702</td>
<td>12935</td>
<td>15852</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>7</td>
<td>557</td>
<td>4020</td>
<td>10946</td>
<td>12314</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>8</td>
<td>1351</td>
<td>6947</td>
<td>13112</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>9</td>
<td>3133</td>
<td>5395</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>10</td>
<td>2063</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>Calculate the all-year volume weighted age-to-age factors</p>
<p><span class="math display">\[
\begin{aligned}
  f_{k} &amp;= \frac{\sum_{i=1}^{n-k}
C_{i,k+1}}{\sum_{i=1}^{n-k}C_{i,k}}
\end{aligned},
\]</span></p>
<p>for development period <span class="math inline">\(i\)</span>.</p>
<div id="cell-12" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>a2a <span class="op">=</span> get_a2a_factors(ctri0)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All-year volume weighted age-to-age factors:"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>a2a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>All-year volume weighted age-to-age factors:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>[('1-2', 2.9993586513353794),
 ('2-3', 1.6235227537534538),
 ('3-4', 1.2708881150356526),
 ('4-5', 1.1716746330883747),
 ('5-6', 1.113384886206463),
 ('6-7', 1.0419346379110106),
 ('7-8', 1.033263553789384),
 ('8-9', 1.0169364810075625),
 ('9-10', 1.0092165898617511)]</code></pre>
</div>
</div>
<p><br></p>
<p>Although not required here, age-to-ultimate factors can be obtained as follows:</p>
<div id="cell-14" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>h, v <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>a2a)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>a2u <span class="op">=</span> np.cumprod(v[::<span class="op">-</span><span class="dv">1</span>])[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Age-to-ultimate factors:"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">zip</span>(h, a2u.tolist()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Age-to-ultimate factors:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>[('1-2', 8.920233896752476),
 ('2-3', 2.9740470992960426),
 ('3-4', 1.8318481169544962),
 ('4-5', 1.441392121998959),
 ('5-6', 1.2301982831186211),
 ('6-7', 1.104917354599779),
 ('7-8', 1.0604478576650866),
 ('8-9', 1.0263091674684617),
 ('9-10', 1.0092165898617511)]</code></pre>
</div>
</div>
<p><br></p>
<p>Calculate the cumulative fitted triangle by applying backwards recursion, beginning with the observed cumulative losses from the latest diagonal.</p>
<div id="cell-16" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>nbr_devps <span class="op">=</span> ctri0.width <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>a2a_headers, a2a_values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>a2a)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create empty triangle with same shape as ctri0. </span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>ctri <span class="op">=</span> pl.DataFrame(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    {<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>: [np.nan] <span class="op">*</span> nbr_devps <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)}</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>).with_row_index(<span class="st">"ORIGIN"</span>, offset<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r_idx <span class="kw">in</span> <span class="bu">range</span>(ctri[<span class="st">"ORIGIN"</span>].shape[<span class="dv">0</span>]):</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine latest development period.</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    latest_devp <span class="op">=</span> nbr_devps <span class="op">-</span> r_idx</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set latest diagonal of tri to same value as in tri0.</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    ctri[r_idx, <span class="bu">str</span>(latest_devp)] <span class="op">=</span> ctri0[r_idx, <span class="bu">str</span>(latest_devp)] </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use backward recursion to un-develop triangle using a2a_values. </span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> devp <span class="kw">in</span> <span class="bu">range</span>(latest_devp <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        ctri[r_idx, <span class="bu">str</span>(devp)] <span class="op">=</span> (ctri[r_idx, <span class="bu">str</span>(devp <span class="op">+</span> <span class="dv">1</span>)] <span class="op">/</span> a2a_values[devp <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fitted cumulative triangle:"</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>ctri</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitted cumulative triangle:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 11)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ORIGIN</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>u32</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>2111.3796</td>
<td>6332.7847</td>
<td>10281.4201</td>
<td>13066.5346</td>
<td>15309.7271</td>
<td>17045.6188</td>
<td>17760.4206</td>
<td>18351.1953</td>
<td>18662.0000</td>
<td>18834.0000</td>
</tr>
<tr class="even">
<td>2</td>
<td>1889.8556</td>
<td>5668.3547</td>
<td>9202.7029</td>
<td>11695.6057</td>
<td>13703.4445</td>
<td>15257.2080</td>
<td>15897.0135</td>
<td>16425.8047</td>
<td>16704.0000</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>3</td>
<td>2699.8587</td>
<td>8097.8445</td>
<td>13147.0348</td>
<td>16708.4103</td>
<td>19576.8205</td>
<td>21796.5360</td>
<td>22710.5659</td>
<td>23466.0000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>4</td>
<td>3217.7567</td>
<td>9651.2063</td>
<td>15668.9531</td>
<td>19913.4862</td>
<td>23332.1267</td>
<td>25977.6372</td>
<td>27067.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>5</td>
<td>3242.8226</td>
<td>9726.3881</td>
<td>15791.0124</td>
<td>20068.6100</td>
<td>23513.8813</td>
<td>26180.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>6</td>
<td>2186.1650</td>
<td>6557.0929</td>
<td>10645.5896</td>
<td>13529.3532</td>
<td>15852.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>7</td>
<td>1989.7800</td>
<td>5968.0637</td>
<td>9689.2872</td>
<td>12314.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>8</td>
<td>2692.6640</td>
<td>8076.2650</td>
<td>13112.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>9</td>
<td>1798.7179</td>
<td>5395.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>10</td>
<td>2063.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>Calculate the unscaled Pearson residuals, <span class="math inline">\(r_{p}\)</span>, degrees of freedom <span class="math inline">\(DF\)</span> and scale parameter <span class="math inline">\(\phi\)</span>.</p>
<p>The unscaled Pearson residuals are defined as</p>
<p><span class="math display">\[
r_{p} = \frac{I - m}{\sqrt{m}},
\]</span></p>
<p>where <span class="math inline">\(I\)</span> represents actual incremental losses and <span class="math inline">\(m\)</span> fitted incremental losses.</p>
<p>Polars doesn’t have an equivalent to Pandas <code>df.diff(axis=1)</code>, so the implementation of <code>to_incr</code> is a little more involved than what we saw last post. First, the actual triangle on incremental losses:</p>
<div id="cell-18" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Actual incremental triangle tri:"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>tri0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Actual incremental triangle tri:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 11)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ORIGIN</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
<th>i64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>5012</td>
<td>3257</td>
<td>2638</td>
<td>898</td>
<td>1734</td>
<td>2642</td>
<td>1828</td>
<td>599</td>
<td>54</td>
<td>172</td>
</tr>
<tr class="even">
<td>2</td>
<td>106</td>
<td>4179</td>
<td>1111</td>
<td>5270</td>
<td>3116</td>
<td>1817</td>
<td>-103</td>
<td>673</td>
<td>535</td>
<td>null</td>
</tr>
<tr class="odd">
<td>3</td>
<td>3410</td>
<td>5582</td>
<td>4881</td>
<td>2268</td>
<td>2594</td>
<td>3479</td>
<td>649</td>
<td>603</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>4</td>
<td>5655</td>
<td>5900</td>
<td>4211</td>
<td>5500</td>
<td>2159</td>
<td>2658</td>
<td>984</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>5</td>
<td>1092</td>
<td>8473</td>
<td>6271</td>
<td>6333</td>
<td>3786</td>
<td>225</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>6</td>
<td>1513</td>
<td>4932</td>
<td>5257</td>
<td>1233</td>
<td>2917</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>7</td>
<td>557</td>
<td>3463</td>
<td>6926</td>
<td>1368</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>8</td>
<td>1351</td>
<td>5596</td>
<td>6165</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>9</td>
<td>3133</td>
<td>2262</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>10</td>
<td>2063</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>And the fitted incremental triangle:</p>
<div id="cell-20" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted incremental triangle.</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>tri <span class="op">=</span> to_incr(to_table(ctri), as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fitted incremental triangle tri:"</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>tri</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitted incremental triangle tri:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 11)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ORIGIN</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>u32</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>2111.3796</td>
<td>4221.4051</td>
<td>3948.6354</td>
<td>2785.1145</td>
<td>2243.1925</td>
<td>1735.8917</td>
<td>714.8019</td>
<td>590.7747</td>
<td>310.8047</td>
<td>172.0000</td>
</tr>
<tr class="even">
<td>2</td>
<td>1889.8556</td>
<td>3778.4991</td>
<td>3534.3481</td>
<td>2492.9028</td>
<td>2007.8388</td>
<td>1553.7635</td>
<td>639.8055</td>
<td>528.7912</td>
<td>278.1953</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>3</td>
<td>2699.8587</td>
<td>5397.9858</td>
<td>5049.1903</td>
<td>3561.3755</td>
<td>2868.4102</td>
<td>2219.7156</td>
<td>914.0298</td>
<td>755.4341</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>4</td>
<td>3217.7567</td>
<td>6433.4496</td>
<td>6017.7467</td>
<td>4244.5332</td>
<td>3418.6404</td>
<td>2645.5105</td>
<td>1089.3628</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>5</td>
<td>3242.8226</td>
<td>6483.5655</td>
<td>6064.6243</td>
<td>4277.5976</td>
<td>3445.2713</td>
<td>2666.1187</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>6</td>
<td>2186.1650</td>
<td>4370.9279</td>
<td>4088.4966</td>
<td>2883.7637</td>
<td>2322.6468</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>7</td>
<td>1989.7800</td>
<td>3978.2838</td>
<td>3721.2235</td>
<td>2624.7128</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>8</td>
<td>2692.6640</td>
<td>5383.6010</td>
<td>5035.7350</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>9</td>
<td>1798.7179</td>
<td>3596.2821</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>10</td>
<td>2063.0000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>The unscaled Pearson residuals are then calculated element-wise:</p>
<div id="cell-22" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>numer <span class="op">=</span> tri0.select(tri0.columns[<span class="dv">1</span>:]) <span class="op">-</span> tri.select(tri.columns[<span class="dv">1</span>:]) </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>denom <span class="op">=</span> tri.select(pl.col(tri0.columns[<span class="dv">1</span>:]).<span class="bu">abs</span>().sqrt())</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>r_us <span class="op">=</span> numer <span class="op">/</span> denom</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unscaled Pearson residuals:"</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>r_us</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unscaled Pearson residuals:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 10)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>63.1259</td>
<td>-14.8433</td>
<td>-20.8573</td>
<td>-35.7583</td>
<td>-10.7510</td>
<td>21.7480</td>
<td>41.6370</td>
<td>0.3384</td>
<td>-14.5666</td>
<td>0.0000</td>
</tr>
<tr class="even">
<td>-41.0341</td>
<td>6.5154</td>
<td>-40.7625</td>
<td>55.6209</td>
<td>24.7308</td>
<td>6.6781</td>
<td>-29.3664</td>
<td>6.2712</td>
<td>15.3967</td>
<td>null</td>
</tr>
<tr class="odd">
<td>13.6670</td>
<td>2.5046</td>
<td>-2.3670</td>
<td>-21.6728</td>
<td>-5.1237</td>
<td>26.7285</td>
<td>-8.7663</td>
<td>-5.5461</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>42.9657</td>
<td>-6.6508</td>
<td>-23.2906</td>
<td>19.2704</td>
<td>-21.5437</td>
<td>0.2428</td>
<td>-3.1923</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>-37.7697</td>
<td>24.7072</td>
<td>2.6501</td>
<td>31.4266</td>
<td>5.8049</td>
<td>-47.2769</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>-14.3973</td>
<td>8.4866</td>
<td>18.2746</td>
<td>-30.7401</td>
<td>12.3326</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>-32.1201</td>
<td>-8.1696</td>
<td>52.5357</td>
<td>-24.5299</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>-25.8555</td>
<td>2.8948</td>
<td>15.9135</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>31.4605</td>
<td>-22.2495</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>0.0000</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p><span class="math inline">\(DF = n - p\)</span>, where <span class="math inline">\(n\)</span> is the number of populated cells in the original triangle and <span class="math inline">\(p\)</span> the number of parameters in the chain ladder model (10 for origin period and 9 for development period):</p>
<div id="cell-24" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> tri0.count().<span class="bu">sum</span>().to_numpy().flatten()[<span class="dv">1</span>:].<span class="bu">sum</span>().item()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> tri0.height <span class="op">+</span> tri0.width <span class="op">-</span> <span class="dv">2</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>DF <span class="op">=</span> n <span class="op">-</span> p</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Degrees of freedom: </span><span class="sc">{</span>DF<span class="sc">}</span><span class="ss">."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Degrees of freedom: 36.</code></pre>
</div>
</div>
<p><br></p>
<p>The scale parameter <span class="math inline">\(\phi\)</span> is the sum of the squared unscaled Pearson residuals over the degrees of freedom:</p>
<div id="cell-26" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> r_us.with_columns(pl.<span class="bu">all</span>().<span class="bu">pow</span>(<span class="dv">2</span>)).<span class="bu">sum</span>().to_numpy().flatten().<span class="bu">sum</span>().item() <span class="op">/</span> DF</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Scale parameter: </span><span class="sc">{</span>phi<span class="sc">:.3f}</span><span class="ss">."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Scale parameter: 983.635.</code></pre>
</div>
</div>
<p><br></p>
<p>Calculate the adjusted Pearson residuals, <span class="math inline">\(r_{p}^{{adj}}\)</span>, defined as:</p>
<p><span class="math display">\[
r_{p}^{{adj}} = \sqrt{\frac{n}{DF}} \times r_{p}
\]</span></p>
<div id="cell-28" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>r_adj <span class="op">=</span> np.sqrt(n <span class="op">/</span> DF).item() <span class="op">*</span> r_us  </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Adjusted Pearson residuals:"</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>r_adj</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Adjusted Pearson residuals:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 10)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>78.0257</td>
<td>-18.3468</td>
<td>-25.7803</td>
<td>-44.1984</td>
<td>-13.2886</td>
<td>26.8812</td>
<td>51.4647</td>
<td>0.4183</td>
<td>-18.0048</td>
<td>0.0000</td>
</tr>
<tr class="even">
<td>-50.7196</td>
<td>8.0533</td>
<td>-50.3838</td>
<td>68.7493</td>
<td>30.5681</td>
<td>8.2544</td>
<td>-36.2979</td>
<td>7.7514</td>
<td>19.0308</td>
<td>null</td>
</tr>
<tr class="odd">
<td>16.8929</td>
<td>3.0957</td>
<td>-2.9256</td>
<td>-26.7883</td>
<td>-6.3330</td>
<td>33.0374</td>
<td>-10.8354</td>
<td>-6.8551</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>53.1071</td>
<td>-8.2206</td>
<td>-28.7879</td>
<td>23.8188</td>
<td>-26.6287</td>
<td>0.3001</td>
<td>-3.9458</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>-46.6845</td>
<td>30.5389</td>
<td>3.2756</td>
<td>38.8443</td>
<td>7.1751</td>
<td>-58.4358</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>-17.7955</td>
<td>10.4897</td>
<td>22.5880</td>
<td>-37.9958</td>
<td>15.2434</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>-39.7015</td>
<td>-10.0978</td>
<td>64.9359</td>
<td>-30.3197</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>-31.9582</td>
<td>3.5780</td>
<td>19.6696</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>38.8863</td>
<td>-27.5012</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="even">
<td>0.0000</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>(From this point each subsequent step is repeated up to the desired number of bootstrap samples.)</p>
<p>Generate a sample from the adjusted Pearson residuals with replacement:</p>
<div id="cell-30" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Set random seed for reproducibility.</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span><span class="dv">516</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Represent adjusted residuals as Numpy array with nans and 0s removed.</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> r_adj[:<span class="op">-</span><span class="dv">1</span>, :<span class="op">-</span><span class="dv">1</span>].to_numpy().flatten()</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> r[np.logical_and(<span class="op">~</span>np.isnan(r), r <span class="op">!=</span> <span class="dv">0</span>)] </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample tri0.shape[0] * tri0.shape[1] values at each iteration, but only</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># keep values in upper left portion of triangle. Use mask to determine </span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co"># which values to retain.</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> <span class="op">~</span>np.isnan(tri[:,<span class="dv">1</span>:])</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample with replacement from adjusted residuals. </span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>s_r <span class="op">=</span> rng.choice(r, size<span class="op">=</span>mask.shape, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co"># # Replace 0s with nans.</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>s_r <span class="op">=</span> mask <span class="op">*</span> s_r</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>s_r[s_r<span class="op">==</span><span class="dv">0</span>] <span class="op">=</span> np.nan</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>s_r <span class="op">=</span> pl.from_numpy(s_r, schema<span class="op">=</span>[<span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)])</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sample with replacement from adjusted Pearson residuals:"</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>s_r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample with replacement from adjusted Pearson residuals:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 10)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>-50.3838</td>
<td>-13.2886</td>
<td>7.1751</td>
<td>30.5389</td>
<td>26.8812</td>
<td>-18.3468</td>
<td>-58.4358</td>
<td>33.0374</td>
<td>10.4897</td>
<td>7.1751</td>
</tr>
<tr class="even">
<td>-10.0978</td>
<td>8.2544</td>
<td>-26.7883</td>
<td>0.4183</td>
<td>78.0257</td>
<td>-58.4358</td>
<td>38.8443</td>
<td>-30.3197</td>
<td>19.6696</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>-27.5012</td>
<td>38.8443</td>
<td>-58.4358</td>
<td>-6.3330</td>
<td>7.1751</td>
<td>-27.5012</td>
<td>0.4183</td>
<td>-50.7196</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>-44.1984</td>
<td>8.0533</td>
<td>-37.9958</td>
<td>-27.5012</td>
<td>38.8443</td>
<td>-25.7803</td>
<td>-30.3197</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>19.0308</td>
<td>-3.9458</td>
<td>-26.7883</td>
<td>-2.9256</td>
<td>38.8863</td>
<td>7.7514</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>30.5681</td>
<td>-27.5012</td>
<td>26.8812</td>
<td>8.2544</td>
<td>38.8443</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>-39.7015</td>
<td>-17.7955</td>
<td>-18.3468</td>
<td>-10.8354</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>22.5880</td>
<td>-18.0048</td>
<td>3.0957</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>-25.7803</td>
<td>-26.7883</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>0.4183</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>Using the sampled adjusted Pearson residuals and fitted incremental triangle <span class="math inline">\(m\)</span>, construct the triangle of sampled incremental losses <span class="math inline">\({I_{i}}\)</span>:</p>
<p><span class="math display">\[
I_{i} = m + \hat{r}_{p}^{adj} \sqrt{m},
\]</span></p>
<p>where <span class="math inline">\(\hat{r}_{p}^{adj}\)</span> represents a sample with replacement from the adjusted Pearson residuals and <span class="math inline">\(m\)</span> the fitted incremental triangle:</p>
<div id="cell-32" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>tri_ii <span class="op">=</span> tri[:,<span class="dv">1</span>:] <span class="op">+</span> s_r <span class="op">*</span> tri.select(pl.col(tri.columns[<span class="dv">1</span>:]).sqrt())</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>tri_ii <span class="op">=</span> tri_ii.with_row_index(<span class="st">"ORIGIN"</span>, offset<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Triangle of sampled incremental loss tri_ii:"</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>tri_ii</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Triangle of sampled incremental loss tri_ii:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 11)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ORIGIN</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>u32</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>-203.7452</td>
<td>3358.0144</td>
<td>4399.5047</td>
<td>4396.7778</td>
<td>3516.3502</td>
<td>971.4887</td>
<td>-847.5257</td>
<td>1393.7759</td>
<td>495.7340</td>
<td>266.1004</td>
</tr>
<tr class="even">
<td>2</td>
<td>1450.8774</td>
<td>4285.8909</td>
<td>1941.7709</td>
<td>2513.7873</td>
<td>5504.0870</td>
<td>-749.6490</td>
<td>1622.3472</td>
<td>-168.4248</td>
<td>606.2675</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1270.8943</td>
<td>8251.9128</td>
<td>896.8769</td>
<td>3183.4392</td>
<td>3252.6902</td>
<td>924.0302</td>
<td>926.6758</td>
<td>-638.6012</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>4</td>
<td>710.5888</td>
<td>7079.3951</td>
<td>3070.2582</td>
<td>2452.8309</td>
<td>5689.8317</td>
<td>1319.5115</td>
<td>88.6453</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>5</td>
<td>4326.5491</td>
<td>6165.8502</td>
<td>3978.4635</td>
<td>4086.2513</td>
<td>5727.7564</td>
<td>3066.3579</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>6</td>
<td>3615.4212</td>
<td>2552.7444</td>
<td>5807.3180</td>
<td>3327.0288</td>
<td>4194.7016</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>7</td>
<td>218.8165</td>
<td>2855.8569</td>
<td>2602.0332</td>
<td>2069.5944</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>8</td>
<td>3864.7765</td>
<td>4062.5315</td>
<td>5255.4183</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td>9</td>
<td>705.3407</td>
<td>1989.8118</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td>10</td>
<td>2081.9985</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>Create a cumulative triangle, and project future losses using the chain ladder method:</p>
<div id="cell-34" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create cumulative triangle from sampled incremental losses.</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>ctri_ii <span class="op">=</span> to_cum(to_table(tri_ii), as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get age-to-age factors for sampled cumulative triangle.</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>a2a_ii <span class="op">=</span> get_a2a_factors(ctri_ii)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Square ctri_ii, populating the lower-right side using a2a_ii.</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>ctri_ii_sqrd <span class="op">=</span> square_tri(ctri_ii, a2a_ii)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Completed sampled triangle ctri_ii_sqrd:"</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>ctri_ii_sqrd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Completed sampled triangle ctri_ii_sqrd:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 11)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ORIGIN</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>u32</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>-203.7452</td>
<td>3154.2692</td>
<td>7553.7739</td>
<td>11950.5517</td>
<td>15466.9019</td>
<td>16438.3906</td>
<td>15590.8649</td>
<td>16984.6408</td>
<td>17480.3748</td>
<td>17746.4752</td>
</tr>
<tr class="even">
<td>2</td>
<td>1450.8774</td>
<td>5736.7683</td>
<td>7678.5392</td>
<td>10192.3265</td>
<td>15696.4135</td>
<td>14946.7645</td>
<td>16569.1116</td>
<td>16400.6868</td>
<td>17006.9544</td>
<td>17265.8480</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1270.8943</td>
<td>9522.8071</td>
<td>10419.6840</td>
<td>13603.1232</td>
<td>16855.8134</td>
<td>17779.8436</td>
<td>18706.5194</td>
<td>18067.9182</td>
<td>18664.3141</td>
<td>18948.4374</td>
</tr>
<tr class="even">
<td>4</td>
<td>710.5888</td>
<td>7789.9839</td>
<td>10860.2421</td>
<td>13313.0730</td>
<td>19002.9047</td>
<td>20322.4162</td>
<td>20411.0615</td>
<td>20646.5050</td>
<td>21328.0164</td>
<td>21652.6887</td>
</tr>
<tr class="odd">
<td>5</td>
<td>4326.5491</td>
<td>10492.3993</td>
<td>14470.8628</td>
<td>18557.1141</td>
<td>24284.8704</td>
<td>27351.2284</td>
<td>28055.8538</td>
<td>28379.4807</td>
<td>29316.2465</td>
<td>29762.5220</td>
</tr>
<tr class="even">
<td>6</td>
<td>3615.4212</td>
<td>6168.1656</td>
<td>11975.4836</td>
<td>15302.5124</td>
<td>19497.2140</td>
<td>20678.4336</td>
<td>21211.1538</td>
<td>21455.8265</td>
<td>22164.0523</td>
<td>22501.4514</td>
</tr>
<tr class="odd">
<td>7</td>
<td>218.8165</td>
<td>3074.6735</td>
<td>5676.7067</td>
<td>7746.3011</td>
<td>10351.3688</td>
<td>10978.4964</td>
<td>11261.3256</td>
<td>11391.2261</td>
<td>11767.2341</td>
<td>11946.3644</td>
</tr>
<tr class="even">
<td>8</td>
<td>3864.7765</td>
<td>7927.3080</td>
<td>13182.7263</td>
<td>17413.9552</td>
<td>23270.2385</td>
<td>24680.0431</td>
<td>25315.8531</td>
<td>25607.8739</td>
<td>26453.1529</td>
<td>26855.8442</td>
</tr>
<tr class="odd">
<td>9</td>
<td>705.3407</td>
<td>2695.1525</td>
<td>4093.6863</td>
<td>5407.6272</td>
<td>7226.2030</td>
<td>7663.9954</td>
<td>7861.4361</td>
<td>7952.1185</td>
<td>8214.6065</td>
<td>8339.6559</td>
</tr>
<tr class="even">
<td>10</td>
<td>2081.9985</td>
<td>7378.7321</td>
<td>11207.6084</td>
<td>14804.8883</td>
<td>19783.7469</td>
<td>20982.3259</td>
<td>21522.8749</td>
<td>21771.1433</td>
<td>22489.7774</td>
<td>22832.1349</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>So far we’ve accounted for parameter variance, but not process variance. In order to obtain the full prediction error, we need to incorporate process variance into our estimates. This is accomplished by simulating incremental projected losses from a gamma distribution. For each cell in the lower right of the completed triangle, we randomly sample from a gamma distribution with mean equal to the projected incremental loss in that cell, and variance equal to the value in that cell times <span class="math inline">\(\phi\)</span>. For example, consider the following squared incremental triangle:</p>
<pre><code>      1  2  3  4  5  6  7  8  9  10
1991  84 27  6  6  3  0  2 -1 -0  2
1992 109 33  7  2  4  4  1 -1  1  2
1993  86 28  8  4  3  2 -0  1  0  2
1994 113 32  1  4  3  2 -1 -0  0  2
1995  86 26  6  3  2  2  0 -0  0  2
1996 107 39  7  4  4  2  1 -0  0  2
1997  72 26  2  3  2  2  0 -0  0  1
1998  77 21  3  3  2  2  0 -0  0  1
1999  74 28  4  3  2  2  0 -0  0  1
2000  54 17  3  2  2  1  0 -0  0  1</code></pre>
<p><br></p>
<p>Values to the right of the main diagonal represent projected future losses. For the loss at origin = 2000 and development period = 2, the projected incremental loss is 17. We would therefore sample from a gamma distribution parameterized as follows:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.random <span class="im">import</span> gamma</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Computed above. </span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> <span class="fl">.798</span> </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Value at intersection of origin=2000 and development period = 2.</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> <span class="dv">17</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine shape and scale from mean and variance.</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>shape <span class="op">=</span> mu<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> (phi <span class="op">*</span> mu)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>scale <span class="op">=</span> (phi <span class="op">*</span> mu) <span class="op">/</span> mu</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate sample from gamma distribution.</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>rng.gamma(shape<span class="op">=</span>shape, scale<span class="op">=</span>scale, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># array([19.29149])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<p>We take advantage of the fact that for the gamma distribution, the shape parameter <span class="math inline">\(\alpha = E[X]^{2} / \mathrm{Var}[X]\)</span> and scale <span class="math inline">\(\theta = \mathrm{Var}[X] / E[X]\)</span>. In essence, we are simulating future incremental losses from a series a gamma distributions, each with parameterization based on the chain ladder-derived future incremental losses. To handle cases in which a projected incremental loss might be negative, we take the absolute value of the projected loss when determining <span class="math inline">\(\alpha_{ij}\)</span> and <span class="math inline">\(\theta_{ij}\)</span> for origin period <span class="math inline">\(i\)</span>, development period <span class="math inline">\(j\)</span>, where <span class="math inline">\(2 \leq i \leq n\)</span> and <span class="math inline">\(j \geq n - i + 2\)</span>.</p>
<div id="cell-36" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">Incorporation of process variance. </span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.random <span class="im">import</span> gamma</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get sampled squared incremental triangle.</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>tri_ii_sqrd <span class="op">=</span> to_incr(to_table(ctri_ii_sqrd), as_tri<span class="op">=</span><span class="va">True</span>).drop(<span class="st">"ORIGIN"</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps):</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> c_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps <span class="op">-</span> r_idx, nbr_devps):</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get mean and variance using incremental loss value.</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> np.<span class="bu">abs</span>(tri_ii_sqrd[r_idx, <span class="bu">str</span>(c_idx)])</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> m <span class="op">*</span> phi</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine shape and scale parameters. </span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>        shape <span class="op">=</span> m<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> v</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> v <span class="op">/</span> m</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update value at [r_idx, c_idx] with sample from gamma distribution.</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>        tri_ii_sqrd[r_idx, <span class="bu">str</span>(c_idx)] <span class="op">=</span> rng.gamma(shape<span class="op">=</span>shape, scale<span class="op">=</span>scale, size<span class="op">=</span><span class="dv">1</span>).item()</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sampled incremental triangle w/ process variance:"</span>)</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>tri_ii_sqrd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sampled incremental triangle w/ process variance:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 10)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
<tr class="odd">
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
<th>f64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>-203.7452</td>
<td>3358.0144</td>
<td>4399.5047</td>
<td>4396.7778</td>
<td>3516.3502</td>
<td>971.4887</td>
<td>-847.5257</td>
<td>1393.7759</td>
<td>495.7340</td>
<td>266.1004</td>
</tr>
<tr class="even">
<td>1450.8774</td>
<td>4285.8909</td>
<td>1941.7709</td>
<td>2513.7873</td>
<td>5504.0870</td>
<td>-749.6490</td>
<td>1622.3472</td>
<td>-168.4248</td>
<td>5.6818</td>
<td>258.8936</td>
</tr>
<tr class="odd">
<td>1270.8943</td>
<td>8251.9128</td>
<td>896.8769</td>
<td>3183.4392</td>
<td>3252.6902</td>
<td>924.0302</td>
<td>926.6758</td>
<td>261.2162</td>
<td>45.4568</td>
<td>284.1233</td>
</tr>
<tr class="even">
<td>710.5888</td>
<td>7079.3951</td>
<td>3070.2582</td>
<td>2452.8309</td>
<td>5689.8317</td>
<td>1319.5115</td>
<td>0.0000</td>
<td>1187.7049</td>
<td>138.5052</td>
<td>324.6723</td>
</tr>
<tr class="odd">
<td>4326.5491</td>
<td>6165.8502</td>
<td>3978.4635</td>
<td>4086.2513</td>
<td>5727.7564</td>
<td>2287.3879</td>
<td>375.7417</td>
<td>20.5246</td>
<td>624.2870</td>
<td>446.2756</td>
</tr>
<tr class="even">
<td>3615.4212</td>
<td>2552.7444</td>
<td>5807.3180</td>
<td>3327.0288</td>
<td>3960.9182</td>
<td>218.8131</td>
<td>10.1640</td>
<td>14.2730</td>
<td>306.6162</td>
<td>337.3991</td>
</tr>
<tr class="odd">
<td>218.8165</td>
<td>2855.8569</td>
<td>2602.0332</td>
<td>1195.7353</td>
<td>962.9821</td>
<td>160.2781</td>
<td>418.3009</td>
<td>0.0000</td>
<td>14.9545</td>
<td>179.1303</td>
</tr>
<tr class="even">
<td>3864.7765</td>
<td>4062.5315</td>
<td>8917.8595</td>
<td>1226.2463</td>
<td>3936.2469</td>
<td>2824.7474</td>
<td>827.3206</td>
<td>4.3581</td>
<td>84.7208</td>
<td>402.6913</td>
</tr>
<tr class="odd">
<td>705.3407</td>
<td>1146.8776</td>
<td>1215.0414</td>
<td>619.7826</td>
<td>3797.3911</td>
<td>796.3057</td>
<td>8.3274</td>
<td>2.0791</td>
<td>0.2504</td>
<td>125.0494</td>
</tr>
<tr class="even">
<td>2713.2565</td>
<td>3260.8427</td>
<td>1892.6994</td>
<td>2777.3152</td>
<td>1124.3156</td>
<td>720.6907</td>
<td>10.0764</td>
<td>7.8274</td>
<td>299.7176</td>
<td>342.3576</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><br></p>
<p>From this point, we proceed exactly as if performing a standard chain ladder analysis: Cumulate incremental losses, then compute the total needed reserve as the ultimate projected value minus the latest cumulative loss amount by origin period. In the next cell we convert <code>latest_values</code> to a numpy array to simplify differencing with ultimates, but this can also be computed element-wise in a list comprehension:</p>
<div id="cell-38" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>tri_ii_sqrd <span class="op">=</span> tri_ii_sqrd.with_row_index(<span class="st">"ORIGIN"</span>, offset<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>ctri_ii_sqrd <span class="op">=</span> to_cum(to_table(tri_ii_sqrd), as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>latest_origin, latest_values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>get_latest(ctri_ii_sqrd))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>latest_values <span class="op">=</span> np.asarray(latest_values)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>ultimates <span class="op">=</span> ctri_ii_sqrd[:, <span class="op">-</span><span class="dv">1</span>].to_numpy().flatten()</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>ibnr <span class="op">=</span> (ultimates <span class="op">-</span> latest_values).tolist()</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"IBNR:"</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>ibnr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IBNR:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>[0.0,
 258.89359253426665,
 329.5800615108092,
 1650.8823904054043,
 1466.8288652047886,
 887.2653700652991,
 1735.6459265833819,
 9306.331478679494,
 6564.227039438123,
 10435.842507396274]</code></pre>
</div>
</div>
<p>The preceding steps are repeated for the desired number of bootstrap samples, resulting in the predictive distribution of total needed reserve by origin period and in aggregate.</p>
<p><br></p>
<section id="bringing-it-all-together" class="level3">
<h3 class="anchored" data-anchor-id="bringing-it-all-together">Bringing it All Together</h3>
<p>The steps outlined above are combined in the next cell to run 1000 bootstrap iterations, generating the predictive distribution of reserves. We also present code to visualize the predictive distribution by origin period and in aggregate.</p>
<div id="cell-40" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.random <span class="im">import</span> gamma</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>, precision<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>pl.Config(tbl_rows<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>pl.Config(float_precision<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>pl.Config(tbl_cols<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Set random seed for reproducibility.</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span><span class="dv">516</span>)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of bootstrap samples.</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>nbr_samples <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tabular incremental losses. Convert to incremental triangle. </span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> pl.read_csv(<span class="st">"https://gist.githubusercontent.com/jtrive84/976c80786a6e97cce7483e306562f85b/raw/06a5c8b1f823fbe2b6da15f90a672517fa5b4571/RAA.csv"</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> dfraa.sort(by<span class="op">=</span>[<span class="st">"ORIGIN"</span>, <span class="st">"DEV"</span>])</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> dfraa.with_columns(pl.col(<span class="st">"ORIGIN"</span>).sub(<span class="dv">1980</span>).alias(<span class="st">"ORIGIN"</span>))</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>tri0 <span class="op">=</span> to_tri(dfraa)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>nbr_devps <span class="op">=</span> tri0.width <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> <span class="op">~</span>np.isnan(tri0[:,<span class="dv">1</span>:])</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create cumulative triangle from original losses.</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>ctri0 <span class="op">=</span> to_cum(dfraa, as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="co"># All-year volume-weighted age-to-age factors.</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>a2a <span class="op">=</span> get_a2a_factors(ctri0)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative fitted triangle via backwards recursion.</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>a2a_headers, a2a_values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>a2a)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create empty triangle with same shape as ctri0. </span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>ctri <span class="op">=</span> pl.DataFrame(</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    {<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>: [np.nan] <span class="op">*</span> nbr_devps <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)}</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>).with_row_index(<span class="st">"ORIGIN"</span>, offset<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r_idx <span class="kw">in</span> <span class="bu">range</span>(ctri[<span class="st">"ORIGIN"</span>].shape[<span class="dv">0</span>]):</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine latest development period.</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    latest_devp <span class="op">=</span> nbr_devps <span class="op">-</span> r_idx</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set latest diagonal of tri to same value as in tri0.</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    ctri[r_idx, <span class="bu">str</span>(latest_devp)] <span class="op">=</span> ctri0[r_idx, <span class="bu">str</span>(latest_devp)] </span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use backward recursion to un-develop triangle using a2a_values. </span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> devp <span class="kw">in</span> <span class="bu">range</span>(latest_devp <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>        ctri[r_idx, <span class="bu">str</span>(devp)] <span class="op">=</span> (ctri[r_idx, <span class="bu">str</span>(devp <span class="op">+</span> <span class="dv">1</span>)] <span class="op">/</span> a2a_values[devp <span class="op">-</span> <span class="dv">1</span>])</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Incremental fitted triangle.</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>tri <span class="op">=</span> to_incr(to_table(ctri), as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Unscaled Pearson residuals.</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>numer <span class="op">=</span> tri0.select(tri0.columns[<span class="dv">1</span>:]) <span class="op">-</span> tri.select(tri.columns[<span class="dv">1</span>:]) </span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>denom <span class="op">=</span> tri.select(pl.col(tri0.columns[<span class="dv">1</span>:]).<span class="bu">abs</span>().sqrt())</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>r_us <span class="op">=</span> numer <span class="op">/</span> denom</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Degrees of freedom.</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> tri0.count().<span class="bu">sum</span>().to_numpy().flatten()[<span class="dv">1</span>:].<span class="bu">sum</span>().item()</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> tri0.height <span class="op">+</span> tri0.width <span class="op">-</span> <span class="dv">2</span></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>DF <span class="op">=</span> n <span class="op">-</span> p</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale parameter.</span></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> r_us.with_columns(pl.<span class="bu">all</span>().<span class="bu">pow</span>(<span class="dv">2</span>)).<span class="bu">sum</span>().to_numpy().flatten().<span class="bu">sum</span>().item() <span class="op">/</span> DF</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjusted Pearson residuals.</span></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>r_adj <span class="op">=</span> np.sqrt(n <span class="op">/</span> DF).item() <span class="op">*</span> r_us  </span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sampling distribution from adjusted Pearson residuals. Remove</span></span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a><span class="co"># nans and 0s. </span></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> r_adj[:<span class="op">-</span><span class="dv">1</span>, :<span class="op">-</span><span class="dv">1</span>].to_numpy().flatten()</span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> r[np.logical_and(<span class="op">~</span>np.isnan(r), r <span class="op">!=</span> <span class="dv">0</span>)] </span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample tri0.width * tri0.height values at each iteration, but only</span></span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a><span class="co"># keep values in upper left portion of triangle. Use mask to determine </span></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a><span class="co"># which values to retain.</span></span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>sqrd_ctris <span class="op">=</span> []</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii <span class="kw">in</span> <span class="bu">range</span>(nbr_samples):</span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample with replacement from adjusted residuals. </span></span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>    s_r <span class="op">=</span> rng.choice(r, size<span class="op">=</span>mask.shape, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>    s_r <span class="op">=</span> mask <span class="op">*</span> s_r</span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>    s_r[s_r<span class="op">==</span><span class="dv">0</span>] <span class="op">=</span> np.nan</span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>    s_r <span class="op">=</span> pl.from_numpy(s_r, schema<span class="op">=</span>[<span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)])</span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sampled incremental triangle.</span></span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>    tri_ii <span class="op">=</span> tri[:,<span class="dv">1</span>:] <span class="op">+</span> s_r <span class="op">*</span> tri.select(pl.col(tri.columns[<span class="dv">1</span>:]).sqrt())</span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>    tri_ii <span class="op">=</span> tri_ii.with_row_index(<span class="st">"ORIGIN"</span>, offset<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sampled cumulative triangle.</span></span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>    ctri_ii <span class="op">=</span> to_cum(to_table(tri_ii), as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Age-to-age factors for sampled cumulative triangle.</span></span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>    a2a_ii <span class="op">=</span> get_a2a_factors(ctri_ii)</span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sampled squared cumulative triangle.</span></span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a>    ctri_ii_sqrd <span class="op">=</span> square_tri(ctri_ii, a2a_ii)</span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sampled squared incremental triangle.</span></span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a>    tri_ii_sqrd <span class="op">=</span> to_incr(to_table(ctri_ii_sqrd), as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Incorporate process variance.</span></span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps):</span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps <span class="op">-</span> r_idx, nbr_devps):</span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get mean and variance using incremental loss value.</span></span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>            m <span class="op">=</span> np.<span class="bu">abs</span>(tri_ii_sqrd[r_idx, <span class="bu">str</span>(c_idx)])</span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a>            v <span class="op">=</span> m <span class="op">*</span> phi</span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Determine shape and scale parameters. </span></span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>            shape <span class="op">=</span> m<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> v</span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a>            scale <span class="op">=</span> v <span class="op">/</span> m</span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update value at [r_idx, c_idx] with sample from gamma distribution.</span></span>
<span id="cb43-116"><a href="#cb43-116" aria-hidden="true" tabindex="-1"></a>            tri_ii_sqrd[r_idx, <span class="bu">str</span>(c_idx)] <span class="op">=</span> rng.gamma(shape<span class="op">=</span>shape, scale<span class="op">=</span>scale, size<span class="op">=</span><span class="dv">1</span>).item()</span>
<span id="cb43-117"><a href="#cb43-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a>    ctri_ii_sqrd2 <span class="op">=</span> to_cum(to_table(tri_ii_sqrd), as_tri<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep Sampled squared triangle.</span></span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a>    sqrd_ctris.append(ctri_ii_sqrd2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Obtain the predictive distribution of reserves and ultimates from <code>sqrd_ctris</code>. Each triangle in <code>sqrd_ctris</code> is converted to a Pandas DataFrame to keep the visualization code consistent with the prior post:</p>
<div id="cell-42" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>ultimates, reserves <span class="op">=</span> [], []</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii, ctri <span class="kw">in</span> <span class="bu">enumerate</span>(sqrd_ctris):</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    latest_origin, latest_values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>get_latest(ctri))</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    ctri <span class="op">=</span> ctri.to_pandas().set_index(<span class="st">"ORIGIN"</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> pd.Series(</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>latest_values, index<span class="op">=</span>[<span class="bu">int</span>(ii) <span class="cf">for</span> ii <span class="kw">in</span> latest_origin]</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    ult <span class="op">=</span> (</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        ctri.iloc[:, <span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        .rename({<span class="st">"ORIGIN"</span>: <span class="st">"origin"</span>, <span class="st">"10"</span>: <span class="st">"ult"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    ult[<span class="st">"n"</span>] <span class="op">=</span> ii</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    ultimates.append(ult)</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    ibnr <span class="op">=</span> (</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>        (ctri.iloc[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> latest).astype(<span class="bu">float</span>)</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        .rename({<span class="st">"ORIGIN"</span>: <span class="st">"origin"</span>, <span class="dv">0</span>: <span class="st">"ibnr"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>    ibnr[<span class="st">"n"</span>] <span class="op">=</span> ii</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>    reserves.append(ibnr)</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>dfults <span class="op">=</span> pd.concat(ultimates).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>dfibnr <span class="op">=</span> pd.concat(reserves).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Using <code>dfults</code> and <code>dfibnr</code>, we create a summary of mean ultimate, mean IBNR, standard error of IBNR as well as 75th and 95th percentiles of the predictive distribution of reserves:</p>
<div id="cell-44" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Latest cumulative loss amount by origin.</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>latest_origin, latest_values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>get_latest(ctri0))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>latest <span class="op">=</span> (</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    pd.Series(data<span class="op">=</span>latest_values, index<span class="op">=</span>[<span class="bu">int</span>(ii) <span class="cf">for</span> ii <span class="kw">in</span> latest_origin])</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"index"</span>: <span class="st">"origin"</span>, <span class="dv">0</span>: <span class="st">"latest"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean ultimate by origin.</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>ult_mean <span class="op">=</span> (</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    dfults.groupby(<span class="st">"origin"</span>)[<span class="st">"ult"</span>].mean()</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ult"</span>: <span class="st">"ult_mean"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>ibnr_mean <span class="op">=</span>  (</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    dfibnr.groupby(<span class="st">"origin"</span>)[<span class="st">"ibnr"</span>].mean()</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ibnr"</span>: <span class="st">"ibnr_mean"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard error of reserve distribution by origin. </span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>ibnr_se <span class="op">=</span> (</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    dfibnr.groupby(<span class="st">"origin"</span>)[<span class="st">"ibnr"</span>].std(ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ibnr"</span>: <span class="st">"ibnr_se"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 75th percentile of reserve distribution by origin. </span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>ibnr_75 <span class="op">=</span> (</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    dfibnr.groupby(<span class="st">"origin"</span>)[<span class="st">"ibnr"</span>].quantile(<span class="fl">.75</span>)</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ibnr"</span>: <span class="st">"ibnr_75th"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile of reserve distribution by origin. </span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>ibnr_95 <span class="op">=</span> (</span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>    dfibnr.groupby(<span class="st">"origin"</span>)[<span class="st">"ibnr"</span>].quantile(<span class="fl">.95</span>)</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ibnr"</span>: <span class="st">"ibnr_95th"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into a single DataFrame.</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>bcl_summary <span class="op">=</span> <span class="bu">reduce</span>(</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> df1, df2: df1.merge(df2, on<span class="op">=</span><span class="st">"origin"</span>, how<span class="op">=</span><span class="st">"left"</span>),</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>    (latest, ult_mean, ibnr_mean, ibnr_se, ibnr_75, ibnr_95)</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Set ult_mean for earliest origin period to latest.</span></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>bcl_summary.at[<span class="dv">0</span>, <span class="st">"ult_mean"</span>] <span class="op">=</span> bcl_summary.at[<span class="dv">0</span>, <span class="st">"latest"</span>]</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Boostrap chain ladder summary by origin:"</span>)</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>bcl_summary.<span class="bu">round</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Boostrap chain ladder summary by origin:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">origin</th>
<th data-quarto-table-cell-role="th">latest</th>
<th data-quarto-table-cell-role="th">ult_mean</th>
<th data-quarto-table-cell-role="th">ibnr_mean</th>
<th data-quarto-table-cell-role="th">ibnr_se</th>
<th data-quarto-table-cell-role="th">ibnr_75th</th>
<th data-quarto-table-cell-role="th">ibnr_95th</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>18834</td>
<td>18834.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>16704</td>
<td>17002.0</td>
<td>165.0</td>
<td>430.0</td>
<td>385.0</td>
<td>940.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>23466</td>
<td>24436.0</td>
<td>753.0</td>
<td>1056.0</td>
<td>1228.0</td>
<td>2719.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>27067</td>
<td>29034.0</td>
<td>1916.0</td>
<td>1714.0</td>
<td>2824.0</td>
<td>5079.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>26180</td>
<td>29014.0</td>
<td>2915.0</td>
<td>2085.0</td>
<td>4023.0</td>
<td>6865.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>6</td>
<td>15852</td>
<td>19656.0</td>
<td>3896.0</td>
<td>2452.0</td>
<td>5218.0</td>
<td>8692.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>7</td>
<td>12314</td>
<td>18031.0</td>
<td>5681.0</td>
<td>3066.0</td>
<td>7513.0</td>
<td>11501.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>8</td>
<td>13112</td>
<td>24818.0</td>
<td>11551.0</td>
<td>5142.0</td>
<td>14783.0</td>
<td>21143.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>9</td>
<td>5395</td>
<td>16291.0</td>
<td>10951.0</td>
<td>6283.0</td>
<td>14557.0</td>
<td>22634.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>10</td>
<td>2063</td>
<td>20003.0</td>
<td>17958.0</td>
<td>13786.0</td>
<td>25409.0</td>
<td>43653.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>While results by origin can be useful, typically actuaries are more interested in the aggregate view. To get aggregate results, we first group by simulation number, then proceed as in the prior cell:</p>
<div id="cell-46" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate bootstrap chain ladder results.</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>agg_ults <span class="op">=</span> dfults.groupby(<span class="st">"n"</span>)[<span class="st">"ult"</span>].<span class="bu">sum</span>()</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>agg_ibnr <span class="op">=</span> dfibnr.groupby(<span class="st">"n"</span>)[<span class="st">"ibnr"</span>].<span class="bu">sum</span>()</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>dsumm <span class="op">=</span> {</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latest"</span>: [latest[<span class="st">"latest"</span>].<span class="bu">sum</span>().item()],</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ult_mean"</span>: [agg_ults.mean().item()],</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ibnr_mean"</span>: [agg_ibnr.mean().item()],</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ibnr_se"</span>: [agg_ibnr.std(ddof<span class="op">=</span><span class="dv">1</span>).item()],</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ibnr_75th"</span>: [agg_ibnr.quantile(<span class="fl">.75</span>).item()],</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ibnr_95th"</span>: [agg_ibnr.quantile(<span class="fl">.95</span>).item()]</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>bcl_summary_total <span class="op">=</span> pd.DataFrame().from_dict(dsumm, orient<span class="op">=</span><span class="st">"columns"</span>)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>bcl_summary_total.index <span class="op">=</span> [<span class="st">"total"</span>]</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Boostrap chain ladder summary in total:"</span>)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>bcl_summary_total.<span class="bu">round</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Boostrap chain ladder summary in total:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">latest</th>
<th data-quarto-table-cell-role="th">ult_mean</th>
<th data-quarto-table-cell-role="th">ibnr_mean</th>
<th data-quarto-table-cell-role="th">ibnr_se</th>
<th data-quarto-table-cell-role="th">ibnr_75th</th>
<th data-quarto-table-cell-role="th">ibnr_95th</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">total</td>
<td>160987</td>
<td>217184.0</td>
<td>55787.0</td>
<td>18960.0</td>
<td>66239.0</td>
<td>88935.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
</section>
<section id="visualizing-bootstrap-chain-ladder-results" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-bootstrap-chain-ladder-results">Visualizing Bootstrap Chain Ladder Results</h2>
<p>We can visualize actuals and predictions together by origin out to ultimate with 90% prediction intervals for each forecast period. Starting with <code>sqrd_tris</code>, we transform the data to make it easier for plotting:</p>
<div id="cell-48" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>dflist <span class="op">=</span> []</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tri <span class="kw">in</span> sqrd_ctris:</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    dftri <span class="op">=</span> (</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        tri.to_pandas().set_index(<span class="st">"ORIGIN"</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>        .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        .rename({<span class="st">"ORIGIN"</span>: <span class="st">"origin"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        .melt(id_vars<span class="op">=</span><span class="st">"origin"</span>, var_name<span class="op">=</span><span class="st">"dev"</span>, value_name<span class="op">=</span><span class="st">"bcl_value"</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    dflist.append(dftri)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.concat(dflist)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"dev"</span>] <span class="op">=</span> df[<span class="st">"dev"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sort_values([<span class="st">"origin"</span>, <span class="st">"dev"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute mean, 5th and 95th percentile of prediction interval for each forecast period.</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"origin"</span>, <span class="st">"dev"</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">"bcl_value"</span>]</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    .agg({</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bcl_mean"</span>: <span class="kw">lambda</span> v: v.mean(), </span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bcl_95th"</span>: <span class="kw">lambda</span> v: v.quantile(<span class="fl">.95</span>),</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bcl_5th"</span>: <span class="kw">lambda</span> v: v.quantile(<span class="fl">.05</span>)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach actual values from original cumulative triangle.</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>dfctri0 <span class="op">=</span> (</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>    ctri0.to_pandas().set_index(<span class="st">"ORIGIN"</span>)</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ORIGIN"</span>: <span class="st">"origin"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>    .melt(id_vars<span class="op">=</span><span class="st">"origin"</span>, var_name<span class="op">=</span><span class="st">"dev"</span>, value_name<span class="op">=</span><span class="st">"actual_value"</span>)</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>dfctri0[<span class="st">"dev"</span>] <span class="op">=</span> dfctri0[<span class="st">"dev"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.merge(dfctri0, on<span class="op">=</span>[<span class="st">"origin"</span>, <span class="st">"dev"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="co"># If actual_value is nan, then dev is a prediction for that origin. Otherwise</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a><span class="co"># it is an actual value. </span></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"actual_devp_ind"</span>] <span class="op">=</span> df[<span class="st">"actual_value"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> v: <span class="dv">1</span> <span class="cf">if</span> <span class="kw">not</span> np.isnan(v) <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"value"</span>] <span class="op">=</span> df.<span class="bu">apply</span>(<span class="kw">lambda</span> r: r.bcl_mean <span class="cf">if</span> r.actual_devp_ind<span class="op">==</span><span class="dv">0</span> <span class="cf">else</span> r.actual_value, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>df.tail(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">origin</th>
<th data-quarto-table-cell-role="th">dev</th>
<th data-quarto-table-cell-role="th">bcl_mean</th>
<th data-quarto-table-cell-role="th">bcl_95th</th>
<th data-quarto-table-cell-role="th">bcl_5th</th>
<th data-quarto-table-cell-role="th">actual_value</th>
<th data-quarto-table-cell-role="th">actual_devp_ind</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">90</td>
<td>10</td>
<td>1</td>
<td>2044.92690</td>
<td>5819.41104</td>
<td>2.74973</td>
<td>2063.0</td>
<td>1</td>
<td>2063.00000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">91</td>
<td>10</td>
<td>2</td>
<td>6523.89949</td>
<td>16103.08545</td>
<td>101.75998</td>
<td>NaN</td>
<td>0</td>
<td>6523.89949</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92</td>
<td>10</td>
<td>3</td>
<td>10661.43665</td>
<td>25982.44515</td>
<td>319.20599</td>
<td>NaN</td>
<td>0</td>
<td>10661.43665</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93</td>
<td>10</td>
<td>4</td>
<td>13682.08149</td>
<td>32977.99907</td>
<td>611.55764</td>
<td>NaN</td>
<td>0</td>
<td>13682.08149</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">94</td>
<td>10</td>
<td>5</td>
<td>16092.90839</td>
<td>38453.69231</td>
<td>799.41542</td>
<td>NaN</td>
<td>0</td>
<td>16092.90839</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">95</td>
<td>10</td>
<td>6</td>
<td>17973.94826</td>
<td>42833.83253</td>
<td>934.59346</td>
<td>NaN</td>
<td>0</td>
<td>17973.94826</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">96</td>
<td>10</td>
<td>7</td>
<td>18718.07392</td>
<td>45366.39099</td>
<td>1007.06181</td>
<td>NaN</td>
<td>0</td>
<td>18718.07392</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">97</td>
<td>10</td>
<td>8</td>
<td>19360.64161</td>
<td>46870.52200</td>
<td>1052.26676</td>
<td>NaN</td>
<td>0</td>
<td>19360.64161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">98</td>
<td>10</td>
<td>9</td>
<td>19813.97172</td>
<td>47265.73702</td>
<td>1067.22772</td>
<td>NaN</td>
<td>0</td>
<td>19813.97172</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">99</td>
<td>10</td>
<td>10</td>
<td>20003.07058</td>
<td>47960.10396</td>
<td>1225.34543</td>
<td>NaN</td>
<td>0</td>
<td>20003.07058</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>Actuals with forecasts by origin year with 90% prediction intervals:</p>
<div id="cell-50" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> MaxNLocator</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>fill_color <span class="op">=</span> <span class="st">"#FFC04C"</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume 9 origin periods (no distribution of fully-developed oldest origin period)</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> [(<span class="dv">0</span>, <span class="dv">0</span>), (<span class="dv">0</span>, <span class="dv">1</span>), (<span class="dv">0</span>, <span class="dv">2</span>), (<span class="dv">1</span>, <span class="dv">0</span>), (<span class="dv">1</span>, <span class="dv">1</span>), (<span class="dv">1</span>, <span class="dv">2</span>), (<span class="dv">2</span>, <span class="dv">0</span>), (<span class="dv">2</span>, <span class="dv">1</span>), (<span class="dv">2</span>, <span class="dv">2</span>)]</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>origin_periods <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), tight_layout<span class="op">=</span><span class="va">True</span>, sharex<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ii, jj), origin <span class="kw">in</span> <span class="bu">zip</span>(indices, origin_periods):</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    dforigin <span class="op">=</span> df[df.origin<span class="op">==</span>origin]</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_title(<span class="ss">f"</span><span class="sc">{</span>origin<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get last actual development period for origin.</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    last_actual_devp <span class="op">=</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">1</span>].dev.<span class="bu">max</span>()</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Actual values.</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    act_dev <span class="op">=</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">1</span>].dev.tolist()</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>    act_val <span class="op">=</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">1</span>].value.tolist()</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predicted values.</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    pred_dev <span class="op">=</span> [last_actual_devp] <span class="op">+</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">0</span>].dev.tolist()</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    pred_val <span class="op">=</span> [act_val[<span class="op">-</span><span class="dv">1</span>]] <span class="op">+</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">0</span>].value.tolist()</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5th and 95th percentiles.</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    pred_5th <span class="op">=</span> [act_val[<span class="op">-</span><span class="dv">1</span>]] <span class="op">+</span>  dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">0</span>].bcl_5th.tolist()</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    pred_95th <span class="op">=</span> [act_val[<span class="op">-</span><span class="dv">1</span>]] <span class="op">+</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">0</span>].bcl_95th.tolist()</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].plot(</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>        pred_dev, pred_val, <span class="st">"o"</span>, markersize<span class="op">=</span><span class="dv">7</span>, color<span class="op">=</span><span class="st">"#1d2951"</span>, markerfacecolor<span class="op">=</span><span class="st">"#FFFFFF"</span>, </span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>        markeredgecolor<span class="op">=</span><span class="st">"#1d2951"</span>, markeredgewidth<span class="op">=</span><span class="fl">.35</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">1.</span>, label<span class="op">=</span><span class="st">"predicted"</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].plot(</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>        act_dev, act_val, <span class="st">"o"</span>, markersize<span class="op">=</span><span class="dv">7</span>, color<span class="op">=</span><span class="st">"#1d2951"</span>, markerfacecolor<span class="op">=</span><span class="st">"#1d2951"</span>, </span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>         markeredgecolor<span class="op">=</span><span class="st">"#1d2951"</span>, markeredgewidth<span class="op">=</span><span class="fl">.35</span>, linestyle<span class="op">=</span><span class="st">"-"</span>, linewidth<span class="op">=</span><span class="fl">1.</span>, label<span class="op">=</span><span class="st">"actual"</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].plot(</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>        pred_dev, pred_95th, color<span class="op">=</span><span class="st">"#000000"</span>, linestyle<span class="op">=</span><span class="st">":"</span>,  <span class="co"># color="#FFFFB2",</span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">.75</span>, label<span class="op">=</span><span class="st">"95th percentile"</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].plot(</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>        pred_dev, pred_5th, color<span class="op">=</span><span class="st">"#000000"</span>, linestyle<span class="op">=</span><span class="st">"-."</span>,  <span class="co"># color="#FFFFB2",</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">.75</span>, label<span class="op">=</span><span class="st">"5th percentile"</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].fill_between(pred_dev, pred_5th, pred_95th, color<span class="op">=</span>fill_color, alpha<span class="op">=</span><span class="fl">.50</span>)</span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].xaxis.set_major_formatter(mpl.ticker.StrMethodFormatter(<span class="st">"</span><span class="sc">{x:,.0f}</span><span class="st">"</span>))</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].get_yaxis().set_major_formatter(mpl.ticker.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="bu">format</span>(<span class="bu">int</span>(x), <span class="st">','</span>)))</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].xaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].yaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].grid(<span class="va">True</span>)   </span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_axisbelow(<span class="va">True</span>) </span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].legend(loc<span class="op">=</span><span class="st">"upper left"</span>, fancybox<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="dv">1</span>, fontsize<span class="op">=</span><span class="st">"x-small"</span>)</span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Bootstrap chain ladder forecasts with 90% prediction interval"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bootstrap-chainladder-polars_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>As expected, the prediction intervals grow wider for origin periods with fewer development periods of actual data to account for the greater uncertainty in ultimate projections.</p>
<p>Second, an exhibit with a separate histogram per facet can be used to visualize the distribution of IBNR generated by the bootstrap chain ladder:</p>
<div id="cell-52" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Color for each histogram.</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>hist_color <span class="op">=</span> <span class="st">"#5473ff"</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume 9 origin periods (no distribution of fully-developed oldest origin period)</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> [(<span class="dv">0</span>, <span class="dv">0</span>), (<span class="dv">0</span>, <span class="dv">1</span>), (<span class="dv">0</span>, <span class="dv">2</span>), (<span class="dv">1</span>, <span class="dv">0</span>), (<span class="dv">1</span>, <span class="dv">1</span>), (<span class="dv">1</span>, <span class="dv">2</span>), (<span class="dv">2</span>, <span class="dv">0</span>), (<span class="dv">2</span>, <span class="dv">1</span>), (<span class="dv">2</span>, <span class="dv">2</span>)]</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>origin_periods <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>), tight_layout<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ii, jj), origin <span class="kw">in</span> <span class="bu">zip</span>(indices, origin_periods):</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_title(<span class="bu">str</span>(origin), fontsize<span class="op">=</span><span class="dv">8</span>, weight<span class="op">=</span><span class="st">"normal"</span>)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].hist(</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>        dfibnr[dfibnr.origin<span class="op">==</span>origin].ibnr, <span class="dv">20</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>hist_color, edgecolor<span class="op">=</span><span class="st">"#FFFFFF"</span>, linewidth<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax[ii, jj].yaxis.set_major_formatter(mpl.ticker.StrMethodFormatter("{x:,.0f}"))</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_yticklabels([])</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].xaxis.set_major_formatter(mpl.ticker.StrMethodFormatter(<span class="st">"</span><span class="sc">{x:,.0f}</span><span class="st">"</span>))</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"minor"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"minor"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].xaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].yaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].grid(<span class="va">True</span>)   </span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_axisbelow(<span class="va">True</span>) </span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Boostrap chain ladder: IBNR by origin"</span>, fontsize<span class="op">=</span><span class="dv">9</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bootstrap-chainladder-polars_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>Finally, we can create a similar exhibit for the aggregate distribution of IBNR, with vertical lines added at the 50th, 75th, 95th and 99th percentile of total needed reserve:</p>
<div id="cell-54" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>hist_color <span class="op">=</span> <span class="st">"#5473ff"</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>dfibnr_total <span class="op">=</span> dfibnr.groupby(<span class="st">"n"</span>, as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">"ibnr"</span>].<span class="bu">sum</span>()</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>ibnr_total <span class="op">=</span> dfibnr_total[<span class="st">"ibnr"</span>].values</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>ibnr_50 <span class="op">=</span> np.quantile(ibnr_total, <span class="fl">.50</span>).item()</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>ibnr_75 <span class="op">=</span> np.quantile(ibnr_total, <span class="fl">.75</span>).item()</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>ibnr_95 <span class="op">=</span> np.quantile(ibnr_total, <span class="fl">.95</span>).item()</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>ibnr_99 <span class="op">=</span> np.quantile(ibnr_total, <span class="fl">.99</span>).item()</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">7.5</span>, <span class="fl">5.25</span>), tight_layout<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Bootstrap chain ladder: total IBNR"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>ax.hist(</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    ibnr_total, <span class="dv">27</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span>hist_color, </span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">"#FFFFFF"</span>, linewidth<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 50th percentile.</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>ax.axvline(ibnr_50, color<span class="op">=</span><span class="st">"#000000"</span>, linewidth<span class="op">=</span><span class="fl">1.25</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>ax.annotate(</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r"$p_</span><span class="sc">{{</span><span class="vs">50</span><span class="sc">}}</span><span class="vs"> = </span><span class="sc">{:,.0f}</span><span class="vs">$"</span>.<span class="bu">format</span>(ibnr_50), xycoords<span class="op">=</span><span class="st">"data"</span>, xy<span class="op">=</span>(ibnr_50, <span class="fl">2e-5</span>),</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">90</span>, weight<span class="op">=</span><span class="st">"normal"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    textcoords<span class="op">=</span><span class="st">"offset pixels"</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 75th percentile.</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>ax.axvline(ibnr_75, color<span class="op">=</span><span class="st">"#000000"</span>, linewidth<span class="op">=</span><span class="fl">1.25</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>ax.annotate(</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r"$p_</span><span class="sc">{{</span><span class="vs">75</span><span class="sc">}}</span><span class="vs"> = </span><span class="sc">{:,.0f}</span><span class="vs">$"</span>.<span class="bu">format</span>(ibnr_75), xycoords<span class="op">=</span><span class="st">"data"</span>, xy<span class="op">=</span>(ibnr_75, <span class="fl">2e-5</span>),</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">90</span>, weight<span class="op">=</span><span class="st">"normal"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    textcoords<span class="op">=</span><span class="st">"offset pixels"</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile.</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>ax.axvline(ibnr_95, color<span class="op">=</span><span class="st">"#000000"</span>, linewidth<span class="op">=</span><span class="fl">1.25</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>ax.annotate(</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r"$p_</span><span class="sc">{{</span><span class="vs">95</span><span class="sc">}}</span><span class="vs"> = </span><span class="sc">{:,.0f}</span><span class="vs">$"</span>.<span class="bu">format</span>(ibnr_95), xycoords<span class="op">=</span><span class="st">"data"</span>, xy<span class="op">=</span>(ibnr_95, <span class="fl">2e-5</span>),</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">90</span>, weight<span class="op">=</span><span class="st">"normal"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>    textcoords<span class="op">=</span><span class="st">"offset pixels"</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 99th percentile.</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>ax.axvline(ibnr_99, color<span class="op">=</span><span class="st">"#000000"</span>, linewidth<span class="op">=</span><span class="fl">1.25</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>ax.annotate(</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r"$p_</span><span class="sc">{{</span><span class="vs">99</span><span class="sc">}}</span><span class="vs"> = </span><span class="sc">{:,.0f}</span><span class="vs">$"</span>.<span class="bu">format</span>(ibnr_99), xycoords<span class="op">=</span><span class="st">"data"</span>, xy<span class="op">=</span>(ibnr_99, <span class="fl">2e-5</span>),</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">90</span>, weight<span class="op">=</span><span class="st">"normal"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>    textcoords<span class="op">=</span><span class="st">"offset pixels"</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ax[ii, jj].yaxis.set_major_formatter(mpl.ticker.StrMethodFormatter("{x:,.0f}"))</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels([])</span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_formatter(mpl.ticker.StrMethodFormatter(<span class="st">"</span><span class="sc">{x:,.0f}</span><span class="st">"</span>))</span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a><span class="co"># ax.tick_params(axis="x", which="minor", direction='in', labelsize=8)</span></span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ax.tick_params(axis="y", which="minor", direction='in', labelsize=8)</span></span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>)   </span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>ax.set_axisbelow(<span class="va">True</span>) </span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bootstrap-chainladder-polars_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.jtrive\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>