<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Modeling Count Data with GLMs – The Pleasure of Finding Things Out: A blog by James Triveri</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">The Pleasure of Finding Things Out: A blog by James Triveri</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jtrive84/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jamestriveri/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://python-bloggers.com/"> <i class="bi bi-p-square" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Modeling Count Data with GLMs</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>A walk through fitting a Generalized Linear Model to data with a count response, and demonstrate that a custom implemented solution generates identical estimates to those by the primary statistical modeling library in Python statsmodels <a href="https://www.statsmodels.org/dev/index.html">statsmodels</a>.</p>
<p>In practice, we do not know the values of the proposed model’s parameters, but we do know the data. We use the likelihood function to observe how the function changes for different parameter values while holding the data fixed. We can make use of this to judge which values of the parameters lead to greater relative chances for the sample to occur. Larger values of the likelihood correspond to values of the parameters that are relatively better supported by the data[2]. In short, <em>the underlying goal of a likelihood is to determine which parameters make the given data most likely</em>.</p>
<p>The joint density of <span class="math inline">\(n\)</span> independently distributed observations <span class="math inline">\(\mathbf{y} = (y_{1}, \cdots, y_{n})^{T}\)</span> is given by:</p>
<p><span class="math display">\[
f(\mathbf{y}|\mathbf{\beta}) = \prod_{i=1}^{n} f_{i}(y_{i}|\mathbf{\beta})
\]</span></p>
<p>When this expression is interpreted as a function of unknown <span class="math inline">\(\beta\)</span> given known data <span class="math inline">\(y\)</span>, we obtain the likelihood function:</p>
<p><span class="math display">\[
L(\mathbf{\beta}|\mathbf{y}) = \prod_{i=1}^{n} f_{i}(y_{i}|\mathbf{\beta})
\]</span></p>
<p>Solving the likelihood equation can be difficult. This can be partially alleviated by logging the likelihood expression, arriving at an expression for the log-likelihood:</p>
<p><span class="math display">\[
\mathcal{L}(\mathbf{\beta}|\mathbf{y}) = \sum_{i=1}^{n} f_{i}(y_{i}|\mathbf{\beta})
\]</span></p>
<p><br></p>
<section id="poisson-estimating-equations" class="level3">
<h3 class="anchored" data-anchor-id="poisson-estimating-equations">Poisson Estimating Equations</h3>
<p>A linear model can be fit by solving closed form equations. In the case of the Gaussian, we can maximize the log-likelihood and find an analytical solution directly. Unfortunately, that cannot be done with most Generalized Linear Models including Poisson regression. Instead, an iterative approach such as Iterative Reweighted Least Squares is used. The model is fit based on one-term Taylor linearization of the log-likelihood function identified as the working response. Given an initial estimate of the parameters <span class="math inline">\(\hat{\beta}\)</span>, we calculate the estimated linear predictor <span class="math inline">\(Ln(\hat{\mu}_{i}) = \hat{\eta}_{i} = x_{i}^{T}\beta\)</span>, which is then used to obtain the fitted values <span class="math inline">\(\hat{\mu}_{i} = g^{-1}(\hat{\eta}_{i}) = exp(\hat{\eta}_{i})\)</span>. This process continues until the change in deviance between iterations falls below a predefined threshold. <br></p>
<p>Recall that the Poisson probability density function with mean <span class="math inline">\(\mu\)</span> is defined as:</p>
<p><span class="math display">\[
f(y) = \frac{\mu^{y} e^{-\mu}}{y!}
\]</span> <br></p>
<p>For a dataset with <span class="math inline">\(n\)</span> observations assumed to follow a Poisson distribution, with each observation having mean parameter <span class="math inline">\(\mu_{i}\)</span>, the likelihood is given by</p>
<p><span class="math display">\[
L = \prod_{i=1}^{n} \frac{\mu_{i}^{y}e^{-\mu_{i}}}{y_{i}!},
\]</span></p>
<p>and similarly the log-likelihood as:</p>
<p><span class="math display">\[
\mathcal{L} = \sum_{i=1}^{n} y_{i} Ln(\mu_{i}) - \mu_{i} - Ln(y_{i}!)
\]</span></p>
<p>Every GLM has an associated <a href="https://en.wikipedia.org/wiki/Generalized_linear_model#Link_function">link function</a>, which specifies the relationship between the linear predictor and the mean of the distribution function. Each member of the exponential family (Gaussian, Binomial, Poisson, Gamma, Inverse Gaussian, Negative Binomial) has an associated canonical link, which, for the Poisson GLM is the <em>log link</em> (in GLM literature, the linear predictor is commonly represented by <span class="math inline">\(\eta_{i}\)</span> for models with canonical link):</p>
<p><span class="math display">\[
Ln(\mu_{i}) = \eta_{i} = x_{i}^{T}\beta
\]</span></p>
<p><br></p>
<p>Then the <em>inverse link</em> is the transformation required to obtain the mean. For Poisson model, this is the exponential function:</p>
<p><span class="math display">\[
\mu_{i} = e^{\eta_{i}} = e^{x_{i}^{T}\beta}
\]</span></p>
<p>We can substitute this expression for <span class="math inline">\(\mu_{i}\)</span> into the Poisson log-likelihood equation, resulting in:</p>
<p><span class="math display">\[
\mathcal{L} = \sum_{i=1}^{n} \big(y_{i} (x_{i}^{T}\beta)  - exp(x_{i}^{T}\beta) - Ln(y_{i}!)\big)
\]</span></p>
<p>The gradient vector, or <em>score</em> is the first derivative of the log-likelihood function with respect to <span class="math inline">\(\beta\)</span>:</p>
<p><span class="math display">\[
\frac{\partial \mathcal{L}}{\partial \beta} = \sum_{i=1}^{n} \big((y_{i} - exp(x_{i}^{T}\beta))x_{i}\big)
\]</span> <br></p>
<p>The Hessian matrix is calculated as the second derivative of the log-likelihood function and is negative definite for <span class="math inline">\(\beta\)</span>. It can be expressed as:</p>
<p><span class="math display">\[
\frac{\partial^{2} \mathcal{L}}{\partial \beta \partial \beta^{T}} = -\sum_{i=1}^{n} \big(exp(x_{i}^{T}\beta)\big)x_{i}x_{j}^{T}
\]</span></p>
<p>Estimation of the maximum likelihood covariance matrix is based on the negative inverse of the Hessian, <span class="math inline">\(\Sigma\)</span>:</p>
<p><span class="math display">\[
\sum = -H^{-1} = \Bigg[\sum_{i=1}^{n} \big(exp(x_{i}^{T}\beta)\big)x_{i}x_{j}^{T} \Bigg]^{-1}
\]</span> <br></p>
<p>This is obtained from the last iteration of the estimation procedure.<br>
The square roots of the diagonal elements of <span class="math inline">\(\Sigma\)</span> are the values of parameter standard errors.</p>
</section>
<section id="symbol-map" class="level1">
<h1>Symbol Map</h1>
<ul>
<li><span class="math inline">\(n\)</span>: Number of dataset records<br>
<br></li>
<li><span class="math inline">\(p\)</span>: Number of model parameters excluding intercept (<span class="math inline">\(p + 1\)</span> <em>including</em> intercept)<br>
<br><br>
</li>
<li><span class="math inline">\(X\)</span>: Model matrix<br>
<br></li>
<li><span class="math inline">\(y\)</span>: Dataset response<br>
<br><br>
</li>
<li><span class="math inline">\(L = \prod_{i=1}^{n} \frac{\mu_{i}^{y}e^{-\mu_{i}}}{y_{i}!},\)</span>: Poisson likelihood<br>
<br><br>
</li>
<li><span class="math inline">\(\mathcal{L} = \sum_{i=1}^{n} \big(y_{i} (x_{i}^{T}\beta)  - exp(x_{i}^{T}\beta) - Ln(y_{i}!)\big)\)</span>: Poisson log-likelihood<br>
<br><br>
</li>
<li><span class="math inline">\(\beta = (\beta_{0}, \cdots, \beta_{p})^{T}\)</span>: Estimated model parameters<br>
<br><br>
</li>
<li><span class="math inline">\(g(\mu_{i})\)</span>: Link function. For Poisson GLM, <span class="math inline">\(g(\mu_{i}) = Ln(\mu_{i})\)</span>.<br>
<br><br>
</li>
<li><span class="math inline">\(g'(\mu_{i}) = 1/\mu_{i}\)</span><br>
<br><br>
</li>
<li><span class="math inline">\(\eta = \mathbf{X\beta}\)</span>: Model linear predictor. Same as <span class="math inline">\(g(\mu_{i})\)</span>.<br>
<br><br>
</li>
<li><span class="math inline">\(\mu_{i} = g^{-1}(\eta_{i}) = g^{-1}(x_{i}^{T}\beta)\)</span>: Inverse link or mean function. For Poisson GLM, <span class="math inline">\(\mu_{i} = exp(\eta_{i}) = exp(x_{i}^{T}\beta)\)</span>)<br>
<br><br>
</li>
<li><span class="math inline">\(\frac{\partial \mathcal{L}}{\partial \beta} = U\)</span>: Gradient vector or score<br>
<br><br>
</li>
<li><span class="math inline">\(\frac{\partial^{2} \mathcal{L}}{\partial \beta \partial \beta^{T}}\)</span>: Hessian matrix<br>
<br><br>
</li>
<li><span class="math inline">\(\mathcal{I} =  -E\Big[\frac{\partial^{2} \mathcal{L}}{\partial \beta \partial \beta^{T}} \Big] = X^{T}WX\)</span>: Expected information matrix. For GLMs with canonical link, observed and expected information are the same.<br>
<br><br>
</li>
<li><span class="math inline">\(w_{ii} = \frac{1}{var(Y_{i})}\big(\frac{\partial \mu_{i}}{\partial \eta_{i}}\big)^{2}\)</span><br>
<br><br>
</li>
<li><span class="math inline">\(W\)</span>: <span class="math inline">\(n\)</span>-by-<span class="math inline">\(n\)</span> diagonal matrix of weights with <span class="math inline">\(i^{th}\)</span> element equal to <span class="math inline">\(\mu_{i}\)</span><br>
<br><br>
</li>
<li><span class="math inline">\(\sum = -H^{-1} = \mathcal{I}^{-1}\)</span>: Variance-covariance matrix<br>
<br><br>
</li>
<li><span class="math inline">\(\beta_{r+1} = \beta_{r} - H^{-1}U\)</span>: Newton-Raphson parameter update step<br>
<br></li>
<li><span class="math inline">\(\beta_{r+1} = [X^{T}WX]^{-1}X^{T}Wz\)</span>, where <span class="math inline">\(z = X\beta_{r} + W^{-1}(y - \mu)\)</span>: IRLS update expression<br>
<br><br>
</li>
<li><span class="math inline">\(z_{i} = \hat{\eta}_{i} + (y_{i} - \hat{\mu}_{i})g'(\mu)\)</span>: Working response, a one-term linearization of the log-likelihood function<br>
<br><br>
</li>
<li><span class="math inline">\(\sum_{i=1}^{n}\big(y_{i} - exp(x_{i}^{T}\beta)\big)x_{i}^{T} = 0\)</span>: Poisson estimating equation<br>
<br><br>
</li>
<li>The likelihood of the saturated model is 1. <br></li>
<li>The log-likelihhod of the saturated model is 0. <br></li>
</ul>
<p>Fisher scoring has the advantage that it produces the asymptotic covariance matrix as a by-product.</p>
<p>The log mean is the natural parameter for the Poisson distribution, and the log link is the canonical link for a Poisson GLM. A 1-unit increase in <span class="math inline">\(x_{j}\)</span> has a multiplicative impact of <span class="math inline">\(e^{\beta_{j}}\)</span>. The mean at <span class="math inline">\(x_{j} + 1\)</span> equals the mean at <span class="math inline">\(x_{j}\)</span> multiplied by <span class="math inline">\(e^{\beta_{j}}\)</span>.<br>
<br> Linear regression models are found by minimizing the sum of squared residuals. Poisson regression models are found by minimizing the sum of squared residual deviances, which is equivalent to maximizing the loglikelihood of the data given the model.</p>
<section id="model-assessment" class="level3">
<h3 class="anchored" data-anchor-id="model-assessment">Model Assessment</h3>
<p><strong>Deviance</strong>: Measures how well the model fits the data. Is -2 * loglikelihood of the dataset given the model.<br>
<strong>Deviance Residuals</strong>: Array of -2 * loglikelihood for each data point.</p>
<p>Null Deviance = 2(LL(Saturated Model) - LL(Null Model)) on df = df_Sat - df_Null</p>
<p>Residual Deviance = 2(LL(Saturated Model) - LL(Proposed Model)) df = df_Sat - df_Proposed</p>
<p>The Saturated Model is a model that assumes each data point has its own parameters (which means there are <span class="math inline">\(n\)</span> parameters to estimate.)</p>
<p>The Null Model assumes the exact “opposite”, in that is assumes one parameter for all of the data points, which means the model only estimates one parameter.</p>
<p>The Proposed Model assumes you can explain your data points with <span class="math inline">\(p\)</span> parameters + an intercept term, so you have <span class="math inline">\(p+1\)</span> parameters.</p>
<p>If your Null Deviance is really small, it means that the Null Model explains the data pretty well. Likewise with your Residual Deviance. The null deviance shows how well the response is predicted by the model with nothing but an intercept.</p>
<p>What does really small mean? If your model is “good” then your Deviance is approx Chi^2 with (df_sat - df_model) degrees of freedom.</p>
<p>If you want to compare you Null model with your Proposed model, then you can look at</p>
<p>(Null Deviance - Residual Deviance) approx Chi^2 with df Proposed - df Null = (n-(p+1))-(n-1)=p</p>
<ul>
<li>degrees of freedom = no. of observations – no. of predictors<br>
<br><br>
</li>
<li>Deviance of saturated model is 0, loglikelihood of saturated model will be the maximal attained value.</li>
</ul>
<p><br></p>
<p>The difference between the null deviance and the model’s deviance is distributed as a chi-squared with degrees of freedom equal to the null df minus the model’s df. For your model, that would be:</p>
<p>1-pchisq(256600 - 237230, df=(671266 - 671263))</p>
<p>By default, pchisq() gives the proportion of the distribution to the left of the value. To get the proportion more extreme than your difference, you can specify lower.tail = FALSE or subtract the result from 1 (as you and I have done).</p>
<p>Q-What hypothesis exactly are you testing with the statement 1-pchisq(256600 - 237230, df=(671266 - 671263))?</p>
<p>you are checking if the deviance changed more than might be expected by chance. Ie, you are testing if the model as a whole is better than the null model. It is analogous to the global F test in a linear model.</p>
<p>Q-The null hypothesis is ‘the model as a whole is better than the null model’, and you have rejected the null hypothesis, which means the model is poor?</p>
<p>no the null hypothesis is: <strong>the model as a whole is no better than the null model</strong>. Since this has been rejected, we conclude that the data are not consistent with the null model. NB, this does not necessarily mean that our model is ‘good’ or ‘correct’</p>
<p>Deviance is the likelihood ratio statistic comparing the saturated model to the model under consideration:</p>
<p><span class="math display">\[
D = 2\big(\mathcal{L}(\beta_{max}) - \mathcal{L}(\beta)\big)
\]</span></p>
<p><span class="math inline">\(D\)</span> is approx chi-square with <span class="math inline">\(m-p\)</span> degrees of freedom, with expected value <span class="math inline">\(m-p\)</span>. A value much greater than <span class="math inline">\(m-p\)</span> indicates a poor fitting model.</p>
<p>Log-likelihood ratio statistic:</p>
<p><span class="math display">\[
\begin{align}
LRT&amp;=2\big(\mathcal{L}(\beta_{unconstrained}) - \mathcal{L}(\beta_{constrained})\big) \\
   &amp;=D_{constrained} - D_{unconstrained} \sim\chi^{2}_{q}
\end{align}
\]</span></p>
<p>Where <span class="math inline">\(q\)</span> represents the number of parameters in the unconstrained model not present in the constrained model.</p>
<p>LRT Null hypothesis: <span class="math inline">\(H_{0}\)</span>: Parameters in unconstrained model equal 0.</p>
<p>We can compare the loglikelihoods of the models and select the model with the highest. But it would not be right to compare unadjusted loglikelihoods, because loglikelihood cannot decrease, and usually increases with the addition of variables, no matter how irrelevant they may be. We must charge a penalty for adding variables.</p>
<p><strong>AIC Akaike Information Criterion</strong></p>
<p><span class="math display">\[
AIC = -2\mathcal{L} + 2q
\]</span></p>
<p>Where <span class="math inline">\(q\)</span> is the number of model parameters.</p>
<p>The lower the AIC, the better the model.</p>
<p><strong>Bayesian Information Criterion</strong></p>
<p><span class="math display">\[
BIC = -2\mathcal{L} + qLn(n)
\]</span></p>
<p>Where <span class="math inline">\(n\)</span> represents the number of observations, not the number of groups.</p>
<p>In summary, for penalized loglikelihood tests, the improvement in loglikelihood for a model with <span class="math inline">\(q\)</span> additional parameters must be at least <span class="math inline">\(2q\)</span> for AIC or <span class="math inline">\(qLn(n)\)</span> for BIC.</p>
</section>
<section id="irls-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="irls-algorithm">IRLS Algorithm</h2>
<p><span class="math inline">\(X\)</span> is the n-by-p design matrix<br>
<span class="math inline">\(y\)</span> is a n-by-1 vector representing the response<br>
<span class="math inline">\(\text{offset}\)</span> is a n-by-1 vector representing the exposure<br>
<span class="math inline">\(\mu\)</span> is a n-by-1 vector representing the mean of each observation<br>
<span class="math inline">\(\eta\)</span> is a n-by-1 vector representing the linear predictor/component, <span class="math inline">\(\eta = Ln(\mu)\)</span><br>
<span class="math inline">\(W\)</span> is a n-by-n diagonal matrix with each value equal to <span class="math inline">\(\mu\)</span> (weight matrix)<br>
<span class="math inline">\(z\)</span> is a n-by-1 vector representing the working response<br>
<span class="math inline">\(\epsilon\)</span> represents the change in deviance below which iteration will terminate<br>
<br></p>
<section id="pseudocode" class="level4">
<h4 class="anchored" data-anchor-id="pseudocode">Pseudocode</h4>
<ul>
<li><span class="math inline">\(\text{deviance} = 0\)</span><br>
</li>
<li><span class="math inline">\(\mu = \text{mean(y)}\)</span><br>
</li>
<li><span class="math inline">\(\eta = Ln(\mu)\)</span><br>
</li>
<li><span class="math inline">\(epsilon = .0001\)</span><br>
</li>
<li><span class="math inline">\(\Delta \text{deviance}\)</span> = <span class="math inline">\(\mathrm{Inf}\)</span> <br></li>
</ul>
<p><strong>WHILE</strong> <span class="math inline">\(|\Delta \text{deviance}| \gt \epsilon\)</span>:</p>
<p><span class="math inline">\(\qquad W\)</span> = diag(<span class="math inline">\(\mu\)</span>) <br><br>
<span class="math inline">\(\qquad z\)</span> = <span class="math inline">\(\eta + \frac{y - \mu}{\mu} - \text{offset}\)</span> <br><br>
<span class="math inline">\(\qquad \beta = (X^{T}WX)^{-1}X^{T}Wz\)</span><br>
<br> <span class="math inline">\(\qquad \eta = X\beta + \text{offset}\)</span><br>
<br> <span class="math inline">\(\qquad \mu = exp(\eta)\)</span><br>
<br> $ <em>{0} = $ <br><br>
$ = 2 (yLn(y/) - (y-))$ <br><br>
$ = | - </em>{0}|$ <br></p>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">IRLS pre-processing and setup. </span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy <span class="im">import</span> create_engine</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.random <span class="im">import</span> RandomState</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> special</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.linalg <span class="im">import</span> inv</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="dv">10000</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">50000</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>, precision<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>pd.options.mode.chained_assignment <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>dforiginal      <span class="op">=</span> pd.read_csv(<span class="st">"U:/Repos/LTC/Incidence_Model/Datasets/dfgrpd.csv"</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>cat_fields      <span class="op">=</span> [<span class="st">"GENDER"</span>, <span class="st">"AGE_CATEGORY"</span>]</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>dfinit_         <span class="op">=</span> dforiginal[cat_fields <span class="op">+</span> [<span class="st">"INCIDENCE_MNTH"</span>, <span class="st">"EXPOSURE"</span>]]</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>dfinit          <span class="op">=</span> pd.get_dummies(dfinit_, columns<span class="op">=</span>cat_fields, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>dfinit.columns  <span class="op">=</span> [i.upper() <span class="cf">for</span> i <span class="kw">in</span> dfinit.columns]</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>response_fields <span class="op">=</span> [<span class="st">"INCIDENCE_MNTH"</span>, <span class="st">"EXPOSURE"</span>]</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>design_fields   <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(dfinit.columns).difference(<span class="bu">set</span>(response_fields)))</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>dfgrpd          <span class="op">=</span> dfinit.groupby(design_fields, as_index<span class="op">=</span><span class="va">False</span>).<span class="bu">sum</span>()</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>offset          <span class="op">=</span> dfgrpd.EXPOSURE.values.reshape(dfgrpd.EXPOSURE.values.size, <span class="dv">1</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>Xinit           <span class="op">=</span> dfgrpd[design_fields]</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>Xintercept      <span class="op">=</span> np.ones(Xinit.shape[<span class="dv">0</span>]).reshape(Xinit.shape[<span class="dv">0</span>], <span class="dv">1</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>X               <span class="op">=</span> np.hstack([Xintercept, Xinit])</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>y               <span class="op">=</span> dfgrpd.INCIDENCE_MNTH.values.reshape(Xinit.shape[<span class="dv">0</span>], <span class="dv">1</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> deviance(y, mu):</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute Poisson deviance.</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    y  <span class="op">=</span> y.ravel().tolist()</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> mu.ravel().tolist()</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> f(yi, mui):</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(yi <span class="op">*</span> np.log(yi <span class="op">/</span> mui) <span class="op">-</span> (yi <span class="op">-</span> mui))</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.asarray([<span class="dv">0</span> <span class="cf">if</span> (i<span class="op">==</span><span class="dv">0</span> <span class="kw">or</span> j<span class="op">==</span><span class="dv">0</span>) <span class="cf">else</span> f(i, j)  <span class="cf">for</span> i, j <span class="kw">in</span> <span class="bu">zip</span>(y, mu)])</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(<span class="dv">2</span> <span class="op">*</span> v.<span class="bu">sum</span>())</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> likelihood(y, mu):</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute Poisson likelihood.</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> y <span class="op">*</span> np.log(mu) <span class="op">-</span> mu <span class="op">-</span> np.log(special.factorial(y))</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(np.exp(v).<span class="bu">sum</span>())</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>                                     </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loglikelihood(y, mu):</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute Poisson log-likelihood.</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    y  <span class="op">=</span> y.ravel()</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> mu.ravel()</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> f(yi, mui):</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(yi <span class="op">*</span> np.log(mui) <span class="op">-</span> mui <span class="op">-</span> np.log(special.factorial(yi)))</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.asarray([<span class="dv">0</span> <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span> <span class="cf">else</span> f(i, j) <span class="cf">for</span> i, j <span class="kw">in</span> <span class="bu">zip</span>(y, mu)])</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(v.<span class="bu">sum</span>())</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>coeffs <span class="op">=</span> <span class="bu">list</span>()  </span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>loglik <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>devlst <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>tol    <span class="op">=</span> <span class="fl">.00001</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>ddev   <span class="op">=</span> np.Inf</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>mu0    <span class="op">=</span> (y <span class="op">+</span> y.mean()) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>eta0   <span class="op">=</span> np.log(mu0)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>mu0    <span class="op">=</span> np.exp(eta0)  </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>dev0   <span class="op">=</span> deviance(y<span class="op">=</span>y, mu<span class="op">=</span>mu0)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>llk0   <span class="op">=</span> loglikelihood(y<span class="op">=</span>y, mu<span class="op">=</span>mu0)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>fsi    <span class="op">=</span> <span class="dv">0</span>           <span class="co"># Fisher scoring iteration counter</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">Original implementation of Iterative Reweighted Least Squares (IRLS).</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">Author: James D. Triveri</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">Date  : 2019-02</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Append initial deviance, loglikelihood and parameter estimates.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>devlst.append(dev0)<span class="op">;</span> loglik.append(llk0)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> np.<span class="bu">abs</span>(ddev) <span class="op">&gt;</span> tol:</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    fsi<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute updated W, working response, coeffs, linear component and mean.</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    W   <span class="op">=</span> np.diag(np.ones(X.shape[<span class="dv">0</span>])) <span class="op">*</span> mu0</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    z   <span class="op">=</span> (eta0 <span class="op">+</span> ((y <span class="op">-</span> mu0) <span class="op">/</span> mu0) <span class="op">-</span> np.log(offset)).reshape(y.size, <span class="dv">1</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    B   <span class="op">=</span> inv((X.T <span class="op">@</span> W <span class="op">@</span> X)) <span class="op">@</span> (X.T <span class="op">@</span> W <span class="op">@</span> z)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    eta <span class="op">=</span> X <span class="op">@</span> B.reshape(B.size, <span class="dv">1</span>) <span class="op">+</span> np.log(offset)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    mu  <span class="op">=</span> np.exp(eta).reshape(eta.size, <span class="dv">1</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute updated deviance.</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    dev  <span class="op">=</span> deviance(y<span class="op">=</span>y, mu<span class="op">=</span>mu)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    llk  <span class="op">=</span> loglikelihood(y<span class="op">=</span>y, mu<span class="op">=</span>mu)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    ddev <span class="op">=</span> dev0 <span class="op">-</span> dev</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    vcov <span class="op">=</span> inv((X.T <span class="op">@</span> W <span class="op">@</span> X))</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    mu0, eta0, llk0, dev0 <span class="op">=</span> mu, eta, llk, dev</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append updated parameters, loglikelihood and deviance.</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    devlst.append(dev0)<span class="op">;</span> loglik.append(llk0)<span class="op">;</span> coeffs.append(B)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[=== Summary =====================================================]</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fisher Scoring Iterations: </span><span class="sc">{</span>fsi<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Deviance:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> <span class="bu">enumerate</span>(devlst): <span class="bu">print</span>(j)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">""</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Loglikelihood:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> <span class="bu">enumerate</span>(loglik): <span class="bu">print</span>(k)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">""</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Variance-Covariance Matrix:</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(vcov)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[=================================================================]</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summary-output-description" class="level3">
<h3 class="anchored" data-anchor-id="summary-output-description">Summary Output Description</h3>
<ul>
<li><strong><code>VARIABLE</code></strong>: The name of the estimated parameter.<br>
<br></li>
<li><strong><code>ESTIMATE</code></strong>: The parameter estimate/model coefficient resulting from the running of IRLS.<br>
<br></li>
<li><strong><code>STDERROR</code></strong>: The uncertainty in the parameter estimate.<br>
<br></li>
<li><strong><code>Z-VALUE</code></strong>: Represents the ratio of <code>ESTIMATE / STDERROR</code>.<br>
<br></li>
<li><strong><code>P(&gt;|z|)</code></strong>: Probability of observing the outcome if the coefficient was not significantly different from 0.<br>
<br></li>
</ul>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">##### Model Coefficients and Standard Errors ######</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> coeffs[<span class="op">-</span><span class="dv">1</span>].ravel()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>dfparams <span class="op">=</span> pd.DataFrame({</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"VARIABLE"</span>:[<span class="st">"INTERCEPT"</span>] <span class="op">+</span> Xinit.columns.tolist(),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ESTIMATE"</span>:coeffs[<span class="op">-</span><span class="dv">1</span>].T.ravel(),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"STDERROR"</span>:np.sqrt(np.diagonal(vcov)),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Z-VALUE"</span> :(coeffs[<span class="op">-</span><span class="dv">1</span>].T.ravel() <span class="op">/</span> np.sqrt(np.diagonal(vcov))),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"P(&gt;|z|)"</span> :stats.norm.cdf((coeffs[<span class="op">-</span><span class="dv">1</span>].T.ravel() <span class="op">/</span> np.sqrt(np.diagonal(vcov))))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>dfparams</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">##### Other Summary Statistics #####</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Deviance is approx ChiSquare with m - p df</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Computation of null deviance (intercept only model).</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>mu_null <span class="op">=</span> np.ones(y.size) <span class="op">*</span> y.ravel().mean()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>resid_deviance <span class="op">=</span> devlst[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>null_deviance <span class="op">=</span> deviance(y<span class="op">=</span>y.ravel(), mu<span class="op">=</span>mu_null)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>deviance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">##### Plot log-likelihood as a function of Fisher Scoring iteration #####</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>x0, y0 <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span><span class="bu">enumerate</span>(loglik))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>plt.scatter(x0, y0, marker<span class="op">=</span><span class="st">"o"</span>, edgecolor<span class="op">=</span><span class="st">"#000000"</span>, s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">"#FFFFFF"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Log-likelihood as a Function of Scoring Iteration"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, loc<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>plt.plot(x0, y0, color<span class="op">=</span><span class="st">"#FF0000"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Fisher Scoring Iteration"</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Log-likelihood"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">##### Plot Deviance as a function of Fisher Scoring Iteration #####</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>x1, y1 <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span><span class="bu">enumerate</span>(devlst))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>plt.scatter(x1, y1, marker<span class="op">=</span><span class="st">"o"</span>, edgecolor<span class="op">=</span><span class="st">"#000000"</span>, s<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">"#FFFFFF"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Poisson Deviance as a Function of Scoring Iteration"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, loc<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>plt.plot(x1, y1, color<span class="op">=</span><span class="st">"#FF0000"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Fisher Scoring Iteration"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Deviance"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">##### Statsmodels Poisson GLM fit #####</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>keep_fields  <span class="op">=</span> [<span class="st">"GENDER"</span>, <span class="st">"AGE_CATEGORY"</span>, <span class="st">"INCIDENCE_MNTH"</span>, <span class="st">"EXPOSURE"</span>]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>dfmodel      <span class="op">=</span> dforiginal[keep_fields]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>dfgrpd2      <span class="op">=</span> dfmodel.groupby([<span class="st">"GENDER"</span>, <span class="st">"AGE_CATEGORY"</span>], as_index<span class="op">=</span><span class="va">False</span>).<span class="bu">sum</span>()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>formula_expr <span class="op">=</span> <span class="st">"INCIDENCE_MNTH ~ C(GENDER) + C(AGE_CATEGORY)"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>poisson_mdl  <span class="op">=</span> smf.glm(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    formula<span class="op">=</span>formula_expr, data<span class="op">=</span>dfgrpd2, </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    family<span class="op">=</span>sm.families.Poisson(link<span class="op">=</span>sm.families.links.log),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    exposure<span class="op">=</span>dfgrpd2[<span class="st">"EXPOSURE"</span>]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    ).fit()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind reference to estimated model coefficients.</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> poisson_mdl.params</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>summ   <span class="op">=</span> poisson_mdl.summary()</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>poisson_mdl.deviance</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#poisson_mdl.null_deviance</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>(poisson_mdl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>yy     <span class="op">=</span> dfgrpd2.INCIDENCE_MNTH.values <span class="op">/</span> dfgrpd2.EXPOSURE.values</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>munull <span class="op">=</span> yy.mean()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>loglikelihood(y<span class="op">=</span>yy, mu<span class="op">=</span>munull)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.jtrive\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>