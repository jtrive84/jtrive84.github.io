<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-11-05">
<meta name="description" content="The bootstrap chain ladder from scratch using Pandas">

<title>The Bootstrap Chain Ladder from Scratch using Pandas – The Pleasure of Finding Things Out: A blog by James Triveri</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">The Pleasure of Finding Things Out: A blog by James Triveri</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jtrive84/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jamestriveri/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">The Bootstrap Chain Ladder from Scratch using Pandas</h1>
                  <div>
        <div class="description">
          The bootstrap chain ladder from scratch using Pandas
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">Actuarial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 5, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>The bootstrap chain ladder is a statistical technique used in actuarial reserving to project future claim liabilities based on historical data. It builds upon the chain ladder method, but the chain ladder method by itself does not provide a measure of the uncertainty in its projections, which is where the bootstrap technique comes in. The bootstrap chain ladder provides an empirical distribution of reserve estimates, which can be used to quantify the uncertainty and variability around the estimates generated by the chain ladder.</p>
<p>The bootstrap chain ladder works by repeatedly resampling residuals from the original chain ladder model and creating a series of simulated datasets, each of which mimics the original data in its pattern of claims development. The most commonly used approach was originally outlined by England and Verrall in <a href="https://www.actuaries.org.uk/system/files/documents/pdf/sm0201.pdf"><em>Stochastic Claims Reserving in General Insurance</em></a>, which notably described a technique that can be used to incorporate process variance, allowing for the quantification of the full prediction error of the total needed reserve.</p>
<p>The bootstrap chain ladder is simple from a technical standpoint, but it is worth highlighting the DataFrame operations required to implement the full algorithm. The code used here leverages the Pandas library, but a future post will reproduce the full estimator pipeline using Polars.</p>
<p>Much of what follows is a direct implementation of Appendix 3 from <em>Two Approaches to Calculating Correlated Reserve Indications Across Multiple Lines of Business</em>, Kirshner, et. al.&nbsp;Also, many of the DataFrame operations exhibited here can be implemented more efficiently, but the goal of this article was to present the bootstrap chain ladder with maximal clarity rather than focusing on optimal performance.</p>
<p>The steps to perform the bootstrap chain ladder:</p>
<ol type="1">
<li><p>Transform loss data into cumulative triangle representation.</p></li>
<li><p>Calculate all-year volume weighted age-to-age factors.</p></li>
<li><p>Calculate the cumulative fitted triangle by applying backwards recursion, beginning with the observed cumulative losses from the latest diagonal.</p></li>
<li><p>Calculate the unscaled Pearson residuals, <span class="math inline">\(r_{p}\)</span>, degrees of freedom <span class="math inline">\(DF\)</span> and scale parameter <span class="math inline">\(\phi\)</span>.</p></li>
<li><p>Calculate the adjusted Pearson residuals, defined as <span class="math inline">\(r_{p}^{{adj}} = \sqrt{\frac{n}{DF}} \times r_{p}\)</span>.</p></li>
<li><p>For each bootstrap sample (1…1000):</p>
<ol type="i">
<li><p>Generate a sample from the adjusted Pearson residuals <span class="math inline">\(r_{p}^{{adj}}\)</span> with replacement.</p></li>
<li><p>Using the sampled adjusted Pearson residuals and fitted incremental triangle <span class="math inline">\(m\)</span>, construct the triangle of sampled incremental losses <span class="math inline">\(I_{i} = m + \hat{r}_{p}^{adj} \sqrt{m}\)</span>, where <span class="math inline">\(\hat{r}_{p}^{adj}\)</span> represents a sample with replacement from the adjusted Pearson residuals and <span class="math inline">\(m\)</span> the fitted incremental triangle.</p></li>
<li><p>Create a cumulative triangle using the result from ii., and project future losses using the chain ladder method.</p></li>
<li><p>Incorporate process variance by simulating each future projected incremental loss from a gamma distribution parameterized with mean equal to the projected loss value and variance the loss value times <span class="math inline">\(\phi\)</span>.</p></li>
<li><p>Cumulate the incremental losses, then compute the total needed reserve as the ultimate projected value minus the latest cumulative loss amount by origin period.</p></li>
</ol></li>
<li><p>Compute desired quantiles of interest from predictive distribution of bootstrap samples.</p></li>
</ol>
<p><br></p>
<p>In what follows each step is demonstrated, along with exhibits to visually assess the distribution of future losses.</p>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext watermark</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>, precision<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.precision"</span>, <span class="dv">5</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>pd.options.mode.chained_assignment <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="va">None</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(action<span class="op">=</span><span class="st">"ignore"</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>watermark <span class="op">--</span>python <span class="op">--</span>conda <span class="op">--</span>hostname <span class="op">--</span>machine <span class="op">--</span>iversions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Python implementation: CPython
Python version       : 3.11.10
IPython version      : 8.28.0

conda environment: py311

Compiler    : MSC v.1941 64 bit (AMD64)
OS          : Windows
Release     : 10
Machine     : AMD64
Processor   : Intel64 Family 6 Model 170 Stepping 4, GenuineIntel
CPU cores   : 22
Architecture: 64bit

Hostname: JTRIZPC11

numpy     : 2.1.0
pandas    : 2.2.2
matplotlib: 3.9.2
</code></pre>
</div>
</div>
<p>Begin by loading the data from GitHub and transforming it into an incremental triangle:</p>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load RAA dataset. </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> pd.read_csv(<span class="st">"https://gist.githubusercontent.com/jtrive84/976c80786a6e97cce7483e306562f85b/raw/06a5c8b1f823fbe2b6da15f90a672517fa5b4571/RAA.csv"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> dfraa.sort_values(by<span class="op">=</span>[<span class="st">"ORIGIN"</span>, <span class="st">"DEV"</span>])</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>tri0 <span class="op">=</span> dfraa.pivot(index<span class="op">=</span><span class="st">"ORIGIN"</span>, columns<span class="op">=</span><span class="st">"DEV"</span>).rename_axis(<span class="va">None</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>tri0.columns <span class="op">=</span> tri0.columns.droplevel(<span class="dv">0</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>tri0.columns.name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Original incremental loss triangle:"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>tri0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original incremental loss triangle:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>5012.0</td>
<td>3257.0</td>
<td>2638.0</td>
<td>898.0</td>
<td>1734.0</td>
<td>2642.0</td>
<td>1828.0</td>
<td>599.0</td>
<td>54.0</td>
<td>172.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>106.0</td>
<td>4179.0</td>
<td>1111.0</td>
<td>5270.0</td>
<td>3116.0</td>
<td>1817.0</td>
<td>-103.0</td>
<td>673.0</td>
<td>535.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>3410.0</td>
<td>5582.0</td>
<td>4881.0</td>
<td>2268.0</td>
<td>2594.0</td>
<td>3479.0</td>
<td>649.0</td>
<td>603.0</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>5655.0</td>
<td>5900.0</td>
<td>4211.0</td>
<td>5500.0</td>
<td>2159.0</td>
<td>2658.0</td>
<td>984.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>1092.0</td>
<td>8473.0</td>
<td>6271.0</td>
<td>6333.0</td>
<td>3786.0</td>
<td>225.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>1513.0</td>
<td>4932.0</td>
<td>5257.0</td>
<td>1233.0</td>
<td>2917.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>557.0</td>
<td>3463.0</td>
<td>6926.0</td>
<td>1368.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>1351.0</td>
<td>5596.0</td>
<td>6165.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>3133.0</td>
<td>2262.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>2063.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>A number of functions are defined that will be used throughout the remainder of the article:</p>
<ul>
<li><p><code>to_cum</code>: Accepts an incremental triangle and returns a cumulative triangle.</p></li>
<li><p><code>to_incr</code>: Accepts a cumulative triangle and returns an incremental triangle.</p></li>
<li><p><code>get_a2a_factors</code>: Accepts a cumulative triangle and returns the all-year volume weighted age-to-age factors.</p></li>
<li><p><code>get_latest</code>: Accepts a triangle and returns the value at the latest development period by origin.</p></li>
<li><p><code>square_tri</code>: Accepts a cumulative triangle and set of age-to-age factors and projects future losses, populating the lower-right of the original cumulative triangle.</p></li>
</ul>
<p><br></p>
<p>For <code>get_a2a_factors</code>, <code>get_latest</code> and <code>square_tri</code>, a few simplifying assumptions have been made:</p>
<ol type="1">
<li>The triangles under consideration have an equal number of development and origin periods.</li>
<li>Development periods are sequential starting with 1.</li>
<li>No tail factor is included.</li>
</ol>
<div id="cell-6" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_cum(tri: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Accepts a DataFrame structured as an incremental triangle and </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    returns a cumulative triangle.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    tri : pd.DataFrame</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Incremental triangle.</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Cumulative triangle</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tri.cumsum(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_incr(tri: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Accepts a DataFrame structured as an cumulative triangle and </span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">    returns an incremental triangle.</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">    tri : pd.DataFrame</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co">        Cumulative triangle.</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co">        Incremental triangle.       </span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    tri_incr <span class="op">=</span> tri.diff(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    tri_incr.iloc[:, <span class="dv">0</span>] <span class="op">=</span> tri.iloc[:, <span class="dv">0</span>]</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tri_incr</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_a2a_factors(tri: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate all-year volume weighted age-to-age factors. </span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="co">    tri : pd.DataFrame</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="co">        Cumulative triangle.</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.Series</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="co">        All-year volume weighted age-to-age factors.</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    all_devps <span class="op">=</span> tri.columns.tolist()</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    min_origin, max_origin <span class="op">=</span> tri.index.<span class="bu">min</span>(), tri.index.<span class="bu">max</span>()</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    dps0, dps1 <span class="op">=</span> all_devps[:<span class="op">-</span><span class="dv">1</span>], all_devps[<span class="dv">1</span>:]  </span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    a2a_headers <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>ii<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>jj<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> ii, jj <span class="kw">in</span> <span class="bu">zip</span>(dps0, dps1)]</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    a2a <span class="op">=</span> []</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> dp1, dp0 <span class="kw">in</span> <span class="bu">zip</span>(dps1[::<span class="op">-</span><span class="dv">1</span>], dps0[::<span class="op">-</span><span class="dv">1</span>]):</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        vals1 <span class="op">=</span> tri.loc[min_origin:(max_origin <span class="op">-</span> dp0), dp1].<span class="bu">sum</span>()</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        vals0 <span class="op">=</span> tri.loc[min_origin:(max_origin <span class="op">-</span> dp0), dp0].<span class="bu">sum</span>()</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        a2a.append((vals1 <span class="op">/</span> vals0).item())</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series(data<span class="op">=</span>a2a[::<span class="op">-</span><span class="dv">1</span>], index<span class="op">=</span>a2a_headers)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_latest(tri: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a><span class="co">    Return the value at the latest development period by origin. </span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="co">    tri : pd.DataFrame</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a><span class="co">        Cumulative or incremental triangle.</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.Series</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    nbr_devps <span class="op">=</span> tri.shape[<span class="dv">1</span>]</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> [tri.iat[ii, nbr_devps <span class="op">-</span> ii <span class="op">-</span> <span class="dv">1</span>].item() <span class="cf">for</span> ii <span class="kw">in</span> <span class="bu">range</span>(nbr_devps)]</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series(data<span class="op">=</span>latest, index<span class="op">=</span>tri.index, name<span class="op">=</span><span class="st">"latest"</span>)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> square_tri(tri: pd.DataFrame, a2a: pd.Series) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a><span class="co">    Project future losses for `tri` using `a2a`.</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a><span class="co">    tri : pd.DataFrame</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a><span class="co">        Cumulative triangle.</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a><span class="co">    a2a: pd.Series</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a><span class="co">        Age-to-age factors.</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a><span class="co">        Original triangle with projected future losses. </span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    nbr_devps <span class="op">=</span> tri.shape[<span class="dv">1</span>]</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nbr_devps):</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps <span class="op">-</span> r_idx, nbr_devps):</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>            tri.iat[r_idx, c_idx] <span class="op">=</span> tri.iat[r_idx, c_idx <span class="op">-</span> <span class="dv">1</span>]  <span class="op">*</span> a2a.iat[c_idx <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tri</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Use <code>to_cum</code> to get a cumulative triangle:</p>
<div id="cell-8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ctri0 <span class="op">=</span> to_cum(tri0)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Original cumulative triangle:"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>ctri0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original cumulative triangle:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>5012.0</td>
<td>8269.0</td>
<td>10907.0</td>
<td>11805.0</td>
<td>13539.0</td>
<td>16181.0</td>
<td>18009.0</td>
<td>18608.0</td>
<td>18662.0</td>
<td>18834.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>106.0</td>
<td>4285.0</td>
<td>5396.0</td>
<td>10666.0</td>
<td>13782.0</td>
<td>15599.0</td>
<td>15496.0</td>
<td>16169.0</td>
<td>16704.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>3410.0</td>
<td>8992.0</td>
<td>13873.0</td>
<td>16141.0</td>
<td>18735.0</td>
<td>22214.0</td>
<td>22863.0</td>
<td>23466.0</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>5655.0</td>
<td>11555.0</td>
<td>15766.0</td>
<td>21266.0</td>
<td>23425.0</td>
<td>26083.0</td>
<td>27067.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>1092.0</td>
<td>9565.0</td>
<td>15836.0</td>
<td>22169.0</td>
<td>25955.0</td>
<td>26180.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>1513.0</td>
<td>6445.0</td>
<td>11702.0</td>
<td>12935.0</td>
<td>15852.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>557.0</td>
<td>4020.0</td>
<td>10946.0</td>
<td>12314.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>1351.0</td>
<td>6947.0</td>
<td>13112.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>3133.0</td>
<td>5395.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>2063.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>Calculate the all-year volume weighted age-to-age factors</p>
<p><span class="math display">\[
\begin{aligned}
  f_{k} &amp;= \frac{\sum_{i=1}^{n-k}
C_{i,k+1}}{\sum_{i=1}^{n-k}C_{i,k}}
\end{aligned},
\]</span></p>
<p>for development period <span class="math inline">\(i\)</span>.</p>
<div id="cell-10" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>a2a <span class="op">=</span> get_a2a_factors(ctri0)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All-year volume weighted age-to-age factors:"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>a2a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>All-year volume weighted age-to-age factors:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>1-2     2.99936
2-3     1.62352
3-4     1.27089
4-5     1.17167
5-6     1.11338
6-7     1.04193
7-8     1.03326
8-9     1.01694
9-10    1.00922
dtype: float64</code></pre>
</div>
</div>
<p><br></p>
<p>Although not required here, age-to-ultimate factors can be obtained as follows:</p>
<div id="cell-12" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>a2u <span class="op">=</span> np.cumprod(a2a[::<span class="op">-</span><span class="dv">1</span>])[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Age-to-ultimate factors:"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>a2u</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Age-to-ultimate factors:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>1-2     8.92023
2-3     2.97405
3-4     1.83185
4-5     1.44139
5-6     1.23020
6-7     1.10492
7-8     1.06045
8-9     1.02631
9-10    1.00922
dtype: float64</code></pre>
</div>
</div>
<p><br></p>
<p>Calculate the cumulative fitted triangle by applying backwards recursion, beginning with the observed cumulative losses from the latest diagonal.</p>
<div id="cell-14" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>nbr_devps <span class="op">=</span> ctri0.shape[<span class="dv">1</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create empty triangle with same shape as tri0. </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>ctri <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>tri0.columns, index<span class="op">=</span>tri0.index, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, origin <span class="kw">in</span> <span class="bu">enumerate</span>(ctri0.index):</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine latest development period.</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    latest_devp <span class="op">=</span> nbr_devps <span class="op">-</span> idx</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set latest diagonal of tri to same value as in tri0.</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    ctri.at[origin, latest_devp] <span class="op">=</span> ctri0.at[origin, latest_devp]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use backward recursion to un-develop triangle using a2a. </span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> devp <span class="kw">in</span> <span class="bu">range</span>(latest_devp <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        ctri.at[origin, devp] <span class="op">=</span> (ctri.at[origin, devp <span class="op">+</span> <span class="dv">1</span>] <span class="op">/</span> a2a.iloc[devp <span class="op">-</span> <span class="dv">1</span>]).astype(<span class="bu">float</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fitted cumulative triangle:"</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>ctri</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitted cumulative triangle:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>2111.37961</td>
<td>6332.78471</td>
<td>10281.42007</td>
<td>13066.53458</td>
<td>15309.72711</td>
<td>17045.61877</td>
<td>17760.42062</td>
<td>18351.19533</td>
<td>18662.0</td>
<td>18834.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>1889.85559</td>
<td>5668.35472</td>
<td>9202.70287</td>
<td>11695.60570</td>
<td>13703.44452</td>
<td>15257.20801</td>
<td>15897.01351</td>
<td>16425.80467</td>
<td>16704.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>2699.85868</td>
<td>8097.84449</td>
<td>13147.03479</td>
<td>16708.41026</td>
<td>19576.82046</td>
<td>21796.53602</td>
<td>22710.56587</td>
<td>23466.00000</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>3217.75667</td>
<td>9651.20632</td>
<td>15668.95306</td>
<td>19913.48622</td>
<td>23332.12666</td>
<td>25977.63719</td>
<td>27067.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>3242.82263</td>
<td>9726.38811</td>
<td>15791.01241</td>
<td>20068.60999</td>
<td>23513.88125</td>
<td>26180.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>2186.16501</td>
<td>6557.09292</td>
<td>10645.58956</td>
<td>13529.35325</td>
<td>15852.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>1989.77995</td>
<td>5968.06372</td>
<td>9689.28724</td>
<td>12314.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>2692.66398</td>
<td>8076.26500</td>
<td>13112.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>1798.71787</td>
<td>5395.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>2063.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>Calculate the unscaled Pearson residuals, <span class="math inline">\(r_{p}\)</span>, degrees of freedom <span class="math inline">\(DF\)</span> and scale parameter <span class="math inline">\(\phi\)</span>.</p>
<p>The unscaled Pearson residuals are defined as</p>
<p><span class="math display">\[
r_{p} = \frac{I - m}{\sqrt{m}},
\]</span></p>
<p>where <span class="math inline">\(I\)</span> represents actual incremental losses and <span class="math inline">\(m\)</span> fitted incremental losses.</p>
<p>To get incremental representations of <code>ctri0</code> and <code>ctri</code>, do:</p>
<div id="cell-16" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Actual incremental triangle.</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>tri0 <span class="op">=</span> to_incr(ctri0)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Actual incremental triangle tri0:"</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>tri0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Actual incremental triangle tri0:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>5012.0</td>
<td>3257.0</td>
<td>2638.0</td>
<td>898.0</td>
<td>1734.0</td>
<td>2642.0</td>
<td>1828.0</td>
<td>599.0</td>
<td>54.0</td>
<td>172.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>106.0</td>
<td>4179.0</td>
<td>1111.0</td>
<td>5270.0</td>
<td>3116.0</td>
<td>1817.0</td>
<td>-103.0</td>
<td>673.0</td>
<td>535.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>3410.0</td>
<td>5582.0</td>
<td>4881.0</td>
<td>2268.0</td>
<td>2594.0</td>
<td>3479.0</td>
<td>649.0</td>
<td>603.0</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>5655.0</td>
<td>5900.0</td>
<td>4211.0</td>
<td>5500.0</td>
<td>2159.0</td>
<td>2658.0</td>
<td>984.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>1092.0</td>
<td>8473.0</td>
<td>6271.0</td>
<td>6333.0</td>
<td>3786.0</td>
<td>225.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>1513.0</td>
<td>4932.0</td>
<td>5257.0</td>
<td>1233.0</td>
<td>2917.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>557.0</td>
<td>3463.0</td>
<td>6926.0</td>
<td>1368.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>1351.0</td>
<td>5596.0</td>
<td>6165.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>3133.0</td>
<td>2262.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>2063.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-17" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted incremental triangle.</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>tri <span class="op">=</span> to_incr(ctri)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fitted incremental triangle tri:"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>tri</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitted incremental triangle tri:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>2111.37961</td>
<td>4221.40510</td>
<td>3948.63536</td>
<td>2785.11450</td>
<td>2243.19253</td>
<td>1735.89167</td>
<td>714.80185</td>
<td>590.77471</td>
<td>310.80467</td>
<td>172.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>1889.85559</td>
<td>3778.49913</td>
<td>3534.34815</td>
<td>2492.90283</td>
<td>2007.83882</td>
<td>1553.76350</td>
<td>639.80549</td>
<td>528.79116</td>
<td>278.19533</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>2699.85868</td>
<td>5397.98581</td>
<td>5049.19030</td>
<td>3561.37547</td>
<td>2868.41020</td>
<td>2219.71556</td>
<td>914.02985</td>
<td>755.43413</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>3217.75667</td>
<td>6433.44965</td>
<td>6017.74674</td>
<td>4244.53316</td>
<td>3418.64044</td>
<td>2645.51053</td>
<td>1089.36281</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>3242.82263</td>
<td>6483.56548</td>
<td>6064.62430</td>
<td>4277.59759</td>
<td>3445.27126</td>
<td>2666.11875</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>2186.16501</td>
<td>4370.92792</td>
<td>4088.49664</td>
<td>2883.76369</td>
<td>2322.64675</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>1989.77995</td>
<td>3978.28376</td>
<td>3721.22352</td>
<td>2624.71276</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>2692.66398</td>
<td>5383.60102</td>
<td>5035.73500</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>1798.71787</td>
<td>3596.28213</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>2063.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>The unscaled Pearson residuals are then calculated element-wise:</p>
<div id="cell-19" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>r_us <span class="op">=</span> (tri0 <span class="op">-</span> tri) <span class="op">/</span> tri.<span class="bu">abs</span>().<span class="bu">map</span>(np.sqrt)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unscaled Pearson residuals:"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>r_us</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unscaled Pearson residuals:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>63.12592</td>
<td>-14.84332</td>
<td>-20.85731</td>
<td>-35.75829</td>
<td>-10.75100</td>
<td>21.74797</td>
<td>41.63702</td>
<td>0.33841</td>
<td>-14.56663</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>-41.03414</td>
<td>6.51544</td>
<td>-40.76253</td>
<td>55.62095</td>
<td>24.73082</td>
<td>6.67811</td>
<td>-29.36643</td>
<td>6.27119</td>
<td>15.39671</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>13.66703</td>
<td>2.50458</td>
<td>-2.36696</td>
<td>-21.67284</td>
<td>-5.12365</td>
<td>26.72854</td>
<td>-8.76627</td>
<td>-5.54605</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>42.96574</td>
<td>-6.65076</td>
<td>-23.29058</td>
<td>19.27038</td>
<td>-21.54368</td>
<td>0.24282</td>
<td>-3.19228</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>-37.76965</td>
<td>24.70715</td>
<td>2.65007</td>
<td>31.42656</td>
<td>5.80493</td>
<td>-47.27692</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>-14.39727</td>
<td>8.48656</td>
<td>18.27461</td>
<td>-30.74009</td>
<td>12.33255</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>-32.12011</td>
<td>-8.16956</td>
<td>52.53574</td>
<td>-24.52986</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>-25.85548</td>
<td>2.89478</td>
<td>15.91345</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>31.46054</td>
<td>-22.24953</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>0.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p><span class="math inline">\(DF = n - p\)</span>, where <span class="math inline">\(n\)</span> is the number of populated cells in the original triangle and <span class="math inline">\(p\)</span> the number of parameters in the chain ladder model (10 for origin period and 9 for development period):</p>
<div id="cell-21" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> tri0.count().<span class="bu">sum</span>().item()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> tri0.index.shape[<span class="dv">0</span>] <span class="op">+</span> tri0.columns.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>DF <span class="op">=</span> n <span class="op">-</span> p</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Degrees of freedom: </span><span class="sc">{</span>DF<span class="sc">}</span><span class="ss">."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Degrees of freedom: 36.</code></pre>
</div>
</div>
<p><br></p>
<p>The scale parameter <span class="math inline">\(\phi\)</span> is the sum of the squared unscaled Pearson residuals over the degrees of freedom:</p>
<div id="cell-23" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> ((r_us<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>().<span class="bu">sum</span>() <span class="op">/</span> DF).item()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Scale parameter: </span><span class="sc">{</span>phi<span class="sc">:.3f}</span><span class="ss">."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Scale parameter: 983.635.</code></pre>
</div>
</div>
<p><br></p>
<p>Calculate the adjusted Pearson residuals, <span class="math inline">\(r_{p}^{{adj}}\)</span>, defined as:</p>
<p><span class="math display">\[
r_{p}^{{adj}} = \sqrt{\frac{n}{DF}} \times r_{p}
\]</span></p>
<div id="cell-25" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>r_adj <span class="op">=</span> np.sqrt(n <span class="op">/</span> DF) <span class="op">*</span> r_us </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Adjusted Pearson residuals:"</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>r_adj</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Adjusted Pearson residuals:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>78.02573</td>
<td>-18.34683</td>
<td>-25.78033</td>
<td>-44.19843</td>
<td>-13.28859</td>
<td>26.88122</td>
<td>51.46473</td>
<td>0.41828</td>
<td>-18.00484</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>-50.71956</td>
<td>8.05330</td>
<td>-50.38384</td>
<td>68.74933</td>
<td>30.56811</td>
<td>8.25437</td>
<td>-36.29788</td>
<td>7.75140</td>
<td>19.03085</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>16.89291</td>
<td>3.09575</td>
<td>-2.92564</td>
<td>-26.78834</td>
<td>-6.33300</td>
<td>33.03735</td>
<td>-10.83539</td>
<td>-6.85510</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>53.10708</td>
<td>-8.22056</td>
<td>-28.78793</td>
<td>23.81883</td>
<td>-26.62870</td>
<td>0.30014</td>
<td>-3.94576</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>-46.68454</td>
<td>30.53886</td>
<td>3.27557</td>
<td>38.84427</td>
<td>7.17509</td>
<td>-58.43584</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>-17.79550</td>
<td>10.48967</td>
<td>22.58802</td>
<td>-37.99576</td>
<td>15.24345</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>-39.70151</td>
<td>-10.09784</td>
<td>64.93591</td>
<td>-30.31972</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>-31.95823</td>
<td>3.57805</td>
<td>19.66955</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>38.88627</td>
<td>-27.50115</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>0.00000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>(From this point each subsequent step is repeated up to the desired number of bootstrap samples.)</p>
<p>Generate a sample from the adjusted Pearson residuals with replacement:</p>
<div id="cell-27" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Set random seed for reproducibility.</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span><span class="dv">516</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Represent adjusted residuals as Numpy array with nans and 0s removed.</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> r_adj.iloc[:<span class="op">-</span><span class="dv">1</span>, :<span class="op">-</span><span class="dv">1</span>].astype(<span class="bu">float</span>).values.flatten()</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> r[np.logical_and(<span class="op">~</span>np.isnan(r), r <span class="op">!=</span> <span class="dv">0</span>)]</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample tri0.shape[0] * tri0.shape[1] values at each iteration, but only</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># keep values in upper left portion of triangle. Use mask to determine </span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># which values to retain.</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> <span class="op">~</span>np.isnan(tri0)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample with replacement from adjusted residuals. </span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>s_r <span class="op">=</span> rng.choice(r, size<span class="op">=</span>mask.shape, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace 0s with nans.</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>s_r <span class="op">=</span> (mask <span class="op">*</span> s_r).replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sample with replacement from adjusted Pearson residuals:"</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>s_r</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample with replacement from adjusted Pearson residuals:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>-50.38384</td>
<td>-13.28859</td>
<td>7.17509</td>
<td>30.53886</td>
<td>26.88122</td>
<td>-18.34683</td>
<td>-58.43584</td>
<td>33.03735</td>
<td>10.48967</td>
<td>7.17509</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>-10.09784</td>
<td>8.25437</td>
<td>-26.78834</td>
<td>0.41828</td>
<td>78.02573</td>
<td>-58.43584</td>
<td>38.84427</td>
<td>-30.31972</td>
<td>19.66955</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>-27.50115</td>
<td>38.84427</td>
<td>-58.43584</td>
<td>-6.33300</td>
<td>7.17509</td>
<td>-27.50115</td>
<td>0.41828</td>
<td>-50.71956</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>-44.19843</td>
<td>8.05330</td>
<td>-37.99576</td>
<td>-27.50115</td>
<td>38.84427</td>
<td>-25.78033</td>
<td>-30.31972</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>19.03085</td>
<td>-3.94576</td>
<td>-26.78834</td>
<td>-2.92564</td>
<td>38.88627</td>
<td>7.75140</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>30.56811</td>
<td>-27.50115</td>
<td>26.88122</td>
<td>8.25437</td>
<td>38.84427</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>-39.70151</td>
<td>-17.79550</td>
<td>-18.34683</td>
<td>-10.83539</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>22.58802</td>
<td>-18.00484</td>
<td>3.09575</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>-25.78033</td>
<td>-26.78834</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>0.41828</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>Using the sampled adjusted Pearson residuals and fitted incremental triangle <span class="math inline">\(m\)</span>, construct the triangle of sampled incremental losses <span class="math inline">\({I_{i}}\)</span>:</p>
<p><span class="math display">\[
I_{i} = m + \hat{r}_{p}^{adj} \sqrt{m},
\]</span></p>
<p>where <span class="math inline">\(\hat{r}_{p}^{adj}\)</span> represents a sample with replacement from the adjusted Pearson residuals and <span class="math inline">\(m\)</span> the fitted incremental triangle:</p>
<div id="cell-29" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>tri_ii <span class="op">=</span> tri <span class="op">+</span> s_r <span class="op">*</span> tri.<span class="bu">map</span>(np.sqrt)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Triangle of sampled incremental loss tri_ii:"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>tri_ii</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Triangle of sampled incremental loss tri_ii:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>-203.74517</td>
<td>3358.01441</td>
<td>4399.50467</td>
<td>4396.77782</td>
<td>3516.35018</td>
<td>971.48866</td>
<td>-847.52570</td>
<td>1393.77594</td>
<td>495.73396</td>
<td>266.10038</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>1450.87736</td>
<td>4285.89089</td>
<td>1941.77093</td>
<td>2513.78729</td>
<td>5504.08697</td>
<td>-749.64897</td>
<td>1622.34716</td>
<td>-168.42480</td>
<td>606.26754</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>1270.89430</td>
<td>8251.91283</td>
<td>896.87689</td>
<td>3183.43918</td>
<td>3252.69020</td>
<td>924.03021</td>
<td>926.67577</td>
<td>-638.60120</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>710.58877</td>
<td>7079.39510</td>
<td>3070.25824</td>
<td>2452.83086</td>
<td>5689.83169</td>
<td>1319.51149</td>
<td>88.64530</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>4326.54913</td>
<td>6165.85019</td>
<td>3978.46348</td>
<td>4086.25126</td>
<td>5727.75635</td>
<td>3066.35794</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>3615.42117</td>
<td>2552.74443</td>
<td>5807.31796</td>
<td>3327.02883</td>
<td>4194.70163</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>218.81653</td>
<td>2855.85695</td>
<td>2602.03318</td>
<td>2069.59441</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>3864.77654</td>
<td>4062.53149</td>
<td>5255.41826</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>705.34074</td>
<td>1989.81179</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>2081.99854</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>Create a cumulative triangle, and project future losses using the chain ladder method:</p>
<div id="cell-31" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create cumulative triangle from sampled incremental losses.</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>ctri_ii <span class="op">=</span> to_cum(tri_ii)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Get age-to-age factors for sampled cumulative triangle.</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>a2a_ii <span class="op">=</span> get_a2a_factors(ctri_ii)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # Square ctri_ii, populating the lower-right side using a2a_ii.</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>ctri_ii_sqrd <span class="op">=</span> square_tri(ctri_ii, a2a_ii)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Completed sampled triangle ctri_ii_sqrd:"</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>ctri_ii_sqrd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Completed sampled triangle ctri_ii_sqrd:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>-203.74517</td>
<td>3154.26925</td>
<td>7553.77392</td>
<td>11950.55173</td>
<td>15466.90192</td>
<td>16438.39058</td>
<td>15590.86488</td>
<td>16984.64083</td>
<td>17480.37479</td>
<td>17746.47517</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>1450.87736</td>
<td>5736.76825</td>
<td>7678.53919</td>
<td>10192.32648</td>
<td>15696.41345</td>
<td>14946.76448</td>
<td>16569.11164</td>
<td>16400.68684</td>
<td>17006.95438</td>
<td>17265.84797</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>1270.89430</td>
<td>9522.80713</td>
<td>10419.68402</td>
<td>13603.12320</td>
<td>16855.81340</td>
<td>17779.84361</td>
<td>18706.51938</td>
<td>18067.91819</td>
<td>18664.31410</td>
<td>18948.43736</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>710.58877</td>
<td>7789.98388</td>
<td>10860.24211</td>
<td>13313.07297</td>
<td>19002.90466</td>
<td>20322.41615</td>
<td>20411.06145</td>
<td>20646.50502</td>
<td>21328.01636</td>
<td>21652.68865</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>4326.54913</td>
<td>10492.39932</td>
<td>14470.86280</td>
<td>18557.11406</td>
<td>24284.87042</td>
<td>27351.22836</td>
<td>28055.85376</td>
<td>28379.48074</td>
<td>29316.24646</td>
<td>29762.52204</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>3615.42117</td>
<td>6168.16560</td>
<td>11975.48356</td>
<td>15302.51239</td>
<td>19497.21402</td>
<td>20678.43364</td>
<td>21211.15375</td>
<td>21455.82646</td>
<td>22164.05234</td>
<td>22501.45144</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>218.81653</td>
<td>3074.67348</td>
<td>5676.70666</td>
<td>7746.30107</td>
<td>10351.36885</td>
<td>10978.49639</td>
<td>11261.32564</td>
<td>11391.22612</td>
<td>11767.23406</td>
<td>11946.36440</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>3864.77654</td>
<td>7927.30803</td>
<td>13182.72628</td>
<td>17413.95519</td>
<td>23270.23849</td>
<td>24680.04309</td>
<td>25315.85312</td>
<td>25607.87393</td>
<td>26453.15290</td>
<td>26855.84416</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>705.34074</td>
<td>2695.15253</td>
<td>4093.68628</td>
<td>5407.62721</td>
<td>7226.20298</td>
<td>7663.99541</td>
<td>7861.43612</td>
<td>7952.11854</td>
<td>8214.60650</td>
<td>8339.65588</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>2081.99854</td>
<td>7378.73207</td>
<td>11207.60842</td>
<td>14804.88834</td>
<td>19783.74693</td>
<td>20982.32586</td>
<td>21522.87488</td>
<td>21771.14332</td>
<td>22489.77736</td>
<td>22832.13491</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>So far we’ve accounted for parameter variance, but not process variance. In order to obtain the full prediction error, we need to incorporate process variance into our estimates. This is accomplished by simulating incremental projected losses from a gamma distribution. For each cell in the lower right of the completed triangle, we randomly sample from a gamma distribution with mean equal to the projected incremental loss in that cell, and variance equal to the value in that cell times <span class="math inline">\(\phi\)</span>. For example, consider the following squared incremental triangle:</p>
<pre><code>      1  2  3  4  5  6  7  8  9  10
1991  84 27  6  6  3  0  2 -1 -0  2
1992 109 33  7  2  4  4  1 -1  1  2
1993  86 28  8  4  3  2 -0  1  0  2
1994 113 32  1  4  3  2 -1 -0  0  2
1995  86 26  6  3  2  2  0 -0  0  2
1996 107 39  7  4  4  2  1 -0  0  2
1997  72 26  2  3  2  2  0 -0  0  1
1998  77 21  3  3  2  2  0 -0  0  1
1999  74 28  4  3  2  2  0 -0  0  1
2000  54 17  3  2  2  1  0 -0  0  1</code></pre>
<p><br></p>
<p>Values to the right of the main diagonal represent projected future losses. For the loss at origin = 2000 and development period = 2, the projected incremental loss is 17. We would therefore sample from a gamma distribution parameterized as follows:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.random <span class="im">import</span> gamma</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Computed above. </span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> <span class="fl">.798</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Value at intersection of origin=2000 and development period = 2.</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> <span class="dv">17</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine shape and scale from mean and variance.</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>shape <span class="op">=</span> mu<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> (phi <span class="op">*</span> mu)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>scale <span class="op">=</span> (phi <span class="op">*</span> mu) <span class="op">/</span> mu</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate sample from gamma distribution.</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>rng.gamma(shape<span class="op">=</span>shape, scale<span class="op">=</span>scale, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="co"># array([19.29149])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<p>We take advantage of the fact that for the gamma distribution, the shape parameter <span class="math inline">\(\alpha = E[X]^{2} / \mathrm{Var}[X]\)</span> and scale <span class="math inline">\(\theta = \mathrm{Var}[X] / E[X]\)</span>. In essence, we are simulating future incremental losses from a series a gamma distributions, each with parameterization based on the chain ladder-derived future incremental losses. To handle cases in which a projected incremental loss might be negative, we take the absolute value of the projected loss when determining <span class="math inline">\(\alpha_{ij}\)</span> and <span class="math inline">\(\theta_{ij}\)</span> for origin period <span class="math inline">\(i\)</span>, development period <span class="math inline">\(j\)</span>, where <span class="math inline">\(2 \leq i \leq n\)</span> and <span class="math inline">\(j \geq n - i + 2\)</span>.</p>
<div id="cell-33" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">Incorporation of process variance. </span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.set_option('display.float_format', '{:.2f}'.format)</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.random <span class="im">import</span> gamma</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get sampled squared incremental triangle.</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>tri_ii_sqrd <span class="op">=</span> to_incr(ctri_ii_sqrd)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nbr_devps):</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> c_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps <span class="op">-</span> r_idx, nbr_devps):</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get mean and variance from incremental loss value.</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> np.<span class="bu">abs</span>(tri_ii_sqrd.iat[r_idx, c_idx].item())</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> m <span class="op">*</span> phi</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine shape and scale parameters. </span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>        shape <span class="op">=</span> m<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> v</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>        scale <span class="op">=</span> v <span class="op">/</span> m</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update value at [r_idx, c_idx] with sample from gamma distribution.</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>        tri_ii_sqrd.iat[r_idx, c_idx] <span class="op">=</span> rng.gamma(shape<span class="op">=</span>shape, scale<span class="op">=</span>scale, size<span class="op">=</span><span class="dv">1</span>).item()</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sampled incremental triangle w/ process variance:"</span>)</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>tri_ii_sqrd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sampled incremental triangle w/ process variance:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1981</td>
<td>-203.74517</td>
<td>3358.01441</td>
<td>4399.50467</td>
<td>4396.77782</td>
<td>3516.35018</td>
<td>971.48866</td>
<td>-847.52570</td>
<td>1393.77594</td>
<td>495.73396</td>
<td>266.10038</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1982</td>
<td>1450.87736</td>
<td>4285.89089</td>
<td>1941.77093</td>
<td>2513.78729</td>
<td>5504.08697</td>
<td>-749.64897</td>
<td>1622.34716</td>
<td>-168.42480</td>
<td>606.26754</td>
<td>0.00564</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1983</td>
<td>1270.89430</td>
<td>8251.91283</td>
<td>896.87689</td>
<td>3183.43918</td>
<td>3252.69020</td>
<td>924.03021</td>
<td>926.67577</td>
<td>-638.60120</td>
<td>234.75693</td>
<td>1.54909</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1984</td>
<td>710.58877</td>
<td>7079.39510</td>
<td>3070.25824</td>
<td>2452.83086</td>
<td>5689.83169</td>
<td>1319.51149</td>
<td>88.64530</td>
<td>0.81938</td>
<td>138.50517</td>
<td>140.97113</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1985</td>
<td>4326.54913</td>
<td>6165.85019</td>
<td>3978.46348</td>
<td>4086.25126</td>
<td>5727.75635</td>
<td>3066.35794</td>
<td>375.74168</td>
<td>20.52462</td>
<td>624.28700</td>
<td>115.89744</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1986</td>
<td>3615.42117</td>
<td>2552.74443</td>
<td>5807.31796</td>
<td>3327.02883</td>
<td>4194.70163</td>
<td>218.81315</td>
<td>10.16396</td>
<td>14.27299</td>
<td>306.61617</td>
<td>371.23650</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1987</td>
<td>218.81653</td>
<td>2855.85695</td>
<td>2602.03318</td>
<td>2069.59441</td>
<td>5116.03482</td>
<td>160.27811</td>
<td>418.30086</td>
<td>0.00003</td>
<td>14.95452</td>
<td>1.75255</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1988</td>
<td>3864.77654</td>
<td>4062.53149</td>
<td>5255.41826</td>
<td>1226.24633</td>
<td>3936.24691</td>
<td>2824.74743</td>
<td>827.32061</td>
<td>4.35813</td>
<td>84.72082</td>
<td>387.91986</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1989</td>
<td>705.34074</td>
<td>1989.81179</td>
<td>1215.04136</td>
<td>619.78260</td>
<td>3797.39110</td>
<td>796.30572</td>
<td>8.32738</td>
<td>2.07908</td>
<td>0.25043</td>
<td>83.89140</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1990</td>
<td>2081.99854</td>
<td>3260.84269</td>
<td>1892.69935</td>
<td>2777.31515</td>
<td>1124.31564</td>
<td>720.69074</td>
<td>10.07638</td>
<td>7.82743</td>
<td>299.71757</td>
<td>0.78279</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>From this point, we proceed exactly as if performing a standard chain ladder analysis: Cumulate incremental losses, then compute the total needed reserve as the ultimate projected value minus the latest cumulative loss amount by origin period:</p>
<div id="cell-35" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>ctri_ii_sqrd <span class="op">=</span> to_cum(tri_ii_sqrd)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>latest <span class="op">=</span> get_latest(ctri_ii_sqrd)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>ibnr <span class="op">=</span> ctri_ii_sqrd.iloc[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> latest</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"IBNR for sampled triangle:"</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>ibnr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>IBNR for sampled triangle:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>1981        0.00000
1982        0.00564
1983      236.30602
1984      280.29567
1985     1136.45073
1986      921.10277
1987     5711.32089
1988     9291.56009
1989     6523.06907
1990    10094.26775
dtype: float64</code></pre>
</div>
</div>
<p>The preceding steps are repeated for the desired number of bootstrap samples, resulting in the predictive distribution of total needed reserve by origin period and in aggregate.</p>
<p><br></p>
<section id="bringing-it-all-together" class="level3">
<h3 class="anchored" data-anchor-id="bringing-it-all-together">Bringing it All Together</h3>
<p>The steps outlined above are combined in the next cell to run 1000 bootstrap samples, generating the predictive distribution of reserves. We also present code to visualize the predictive distribution by origin period and in aggregate.</p>
<div id="cell-37" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.random <span class="im">import</span> gamma</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Set random seed for reproducibility.</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span><span class="dv">516</span>)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of bootstrap samples.</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>nbr_samples <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Load tabular incremental losses. Convert to incremental triangle. </span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> pd.read_csv(<span class="st">"https://gist.githubusercontent.com/jtrive84/976c80786a6e97cce7483e306562f85b/raw/06a5c8b1f823fbe2b6da15f90a672517fa5b4571/RAA.csv"</span>)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>dfraa <span class="op">=</span> dfraa.sort_values(by<span class="op">=</span>[<span class="st">"ORIGIN"</span>, <span class="st">"DEV"</span>])</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>tri0 <span class="op">=</span> dfraa.pivot(index<span class="op">=</span><span class="st">"ORIGIN"</span>, columns<span class="op">=</span><span class="st">"DEV"</span>).rename_axis(<span class="va">None</span>)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>tri0.columns <span class="op">=</span> tri0.columns.droplevel(<span class="dv">0</span>)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>nbr_devps <span class="op">=</span> tri0.shape[<span class="dv">1</span>]</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> <span class="op">~</span>np.isnan(tri0)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Create cumulative triangle from original losses.</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>ctri0 <span class="op">=</span> to_cum(tri0)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co"># All-year volume-weighted age-to-age factors.</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>a2a <span class="op">=</span> get_a2a_factors(ctri0)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative fitted triangle via backwards recursion.</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>ctri <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>tri0.columns, index<span class="op">=</span>tri0.index, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, origin <span class="kw">in</span> <span class="bu">enumerate</span>(ctri0.index):</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine latest development period.</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    latest_devp <span class="op">=</span> nbr_devps <span class="op">-</span> idx</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set latest diagonal of tri to same value as in tri0.</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    ctri.at[origin, latest_devp] <span class="op">=</span> ctri0.at[origin, latest_devp]</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use backward recursion to un-develop triangle using a2a. </span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> devp <span class="kw">in</span> <span class="bu">range</span>(latest_devp <span class="op">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>        ctri.at[origin, devp] <span class="op">=</span> ctri.at[origin, devp <span class="op">+</span> <span class="dv">1</span>] <span class="op">/</span> a2a.iloc[devp <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Incremental fitted triangle.</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>tri <span class="op">=</span> to_incr(ctri)</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Unscaled Pearson residuals.</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>r_us <span class="op">=</span> (tri0 <span class="op">-</span> tri) <span class="op">/</span> tri.<span class="bu">abs</span>().<span class="bu">map</span>(np.sqrt)</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Degrees of freedom.</span></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> tri0.count().<span class="bu">sum</span>().item()</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> tri0.index.shape[<span class="dv">0</span>] <span class="op">+</span> tri0.columns.shape[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>DF <span class="op">=</span> n <span class="op">-</span> p</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale parameter.</span></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> ((r_us<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>().<span class="bu">sum</span>() <span class="op">/</span> DF).item()</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjusted Pearson residuals.</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>r_adj <span class="op">=</span> np.sqrt(n <span class="op">/</span> DF) <span class="op">*</span> r_us </span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sampling distribution from adjusted Pearson residuals. Remove</span></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a><span class="co"># nans and 0s. </span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> r_adj.iloc[:<span class="op">-</span><span class="dv">1</span>, :<span class="op">-</span><span class="dv">1</span>].astype(<span class="bu">float</span>).values.flatten()</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> r[np.logical_and(<span class="op">~</span>np.isnan(r), r <span class="op">!=</span> <span class="dv">0</span>)]</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample tri0.shape[0] * tri0.shape[1] values at each iteration, but only</span></span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a><span class="co"># keep values in upper left portion of triangle. Use mask to determine </span></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a><span class="co"># which values to retain.</span></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>sqrd_ctris <span class="op">=</span> []</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii <span class="kw">in</span> <span class="bu">range</span>(nbr_samples):</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample with replacement from adjusted residuals. </span></span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>    s_r <span class="op">=</span> rng.choice(r, size<span class="op">=</span>mask.shape, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace 0s with nans.</span></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>    s_r <span class="op">=</span> (mask <span class="op">*</span> s_r).replace(<span class="dv">0</span>, np.nan)</span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sampled incremental triangle.</span></span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>    tri_ii <span class="op">=</span> tri <span class="op">+</span> s_r <span class="op">*</span> tri.<span class="bu">map</span>(np.sqrt)</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sampled cumulative triangle.</span></span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>    ctri_ii <span class="op">=</span> to_cum(tri_ii)</span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Age-to-age factors for sampled cumulative triangle.</span></span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a>    a2a_ii <span class="op">=</span> get_a2a_factors(ctri_ii)</span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sampled squared cumulative triangle.</span></span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a>    ctri_ii_sqrd <span class="op">=</span> square_tri(ctri_ii, a2a_ii)</span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sampled squared incremental triangle.</span></span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>    tri_ii_sqrd <span class="op">=</span> to_incr(ctri_ii_sqrd)</span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Incorporate process variance.</span></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> r_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nbr_devps):</span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c_idx <span class="kw">in</span> <span class="bu">range</span>(nbr_devps <span class="op">-</span> r_idx, nbr_devps):</span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get mean and variance from incremental loss value.</span></span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a>            m <span class="op">=</span> np.<span class="bu">abs</span>(tri_ii_sqrd.iat[r_idx, c_idx].item())</span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a>            v <span class="op">=</span> m <span class="op">*</span> phi</span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Determine shape and scale parameters. </span></span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a>            shape <span class="op">=</span> m<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> v</span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a>            scale <span class="op">=</span> v <span class="op">/</span> m</span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update value at [r_idx, c_idx] with sample from gamma distribution.</span></span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a>            tri_ii_sqrd.iat[r_idx, c_idx] <span class="op">=</span> rng.gamma(shape<span class="op">=</span>shape, scale<span class="op">=</span>scale, size<span class="op">=</span><span class="dv">1</span>).item()</span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a>    ctri_ii_sqrd2 <span class="op">=</span> to_cum(tri_ii_sqrd)</span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep Sampled squared triangle.</span></span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a>    sqrd_ctris.append(ctri_ii_sqrd2)</span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Obtaining predictive distribution of reserves and ultimates from <code>sqrd_ctris</code>.</p>
<div id="cell-39" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>ultimates, reserves <span class="op">=</span> [], []</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii, ctri <span class="kw">in</span> <span class="bu">enumerate</span>(sqrd_ctris):</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    ult <span class="op">=</span> (</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        ctri.iloc[:, <span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        .rename({<span class="st">"index"</span>: <span class="st">"origin"</span>, <span class="dv">10</span>: <span class="st">"ult"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    ult[<span class="st">"n"</span>] <span class="op">=</span> ii</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    ultimates.append(ult)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> get_latest(ctri)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    ibnr <span class="op">=</span> (</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>        (ctri.iloc[:, <span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> latest).astype(<span class="bu">float</span>)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>        .rename({<span class="st">"index"</span>: <span class="st">"origin"</span>, <span class="dv">0</span>: <span class="st">"ibnr"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    ibnr[<span class="st">"n"</span>] <span class="op">=</span> ii</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    reserves.append(ibnr)</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>dfults <span class="op">=</span> pd.concat(ultimates).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>dfibnr <span class="op">=</span> pd.concat(reserves).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Using <code>dfults</code> and <code>dfibnr</code>, we create a summary of mean ultimate, mean IBNR, standard error of IBNR as well as 75th and 95th percentiles of the predictive distribution of reserves:</p>
<div id="cell-41" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Latest cumulative loss amount by origin.</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>latest <span class="op">=</span> (</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    get_latest(ctri0)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"index"</span>: <span class="st">"origin"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean ultimate by origin.</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>ult_mean <span class="op">=</span> (</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    dfults.groupby(<span class="st">"origin"</span>)[<span class="st">"ult"</span>].mean()</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ult"</span>: <span class="st">"ult_mean"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>ibnr_mean <span class="op">=</span>  (</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    dfibnr.groupby(<span class="st">"origin"</span>)[<span class="st">"ibnr"</span>].mean()</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ibnr"</span>: <span class="st">"ibnr_mean"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard error of reserve distribution by origin. </span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>ibnr_se <span class="op">=</span> (</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    dfibnr.groupby(<span class="st">"origin"</span>)[<span class="st">"ibnr"</span>].std(ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ibnr"</span>: <span class="st">"ibnr_se"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 75th percentile of reserve distribution by origin. </span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>ibnr_75 <span class="op">=</span> (</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    dfibnr.groupby(<span class="st">"origin"</span>)[<span class="st">"ibnr"</span>].quantile(<span class="fl">.75</span>)</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ibnr"</span>: <span class="st">"ibnr_75th"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile of reserve distribution by origin. </span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>ibnr_95 <span class="op">=</span> (</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    dfibnr.groupby(<span class="st">"origin"</span>)[<span class="st">"ibnr"</span>].quantile(<span class="fl">.95</span>)</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"ibnr"</span>: <span class="st">"ibnr_95th"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into a single DataFrame.</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>bcl_summary <span class="op">=</span> <span class="bu">reduce</span>(</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> df1, df2: df1.merge(df2, on<span class="op">=</span><span class="st">"origin"</span>, how<span class="op">=</span><span class="st">"left"</span>),</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    (latest, ult_mean, ibnr_mean, ibnr_se, ibnr_75, ibnr_95)</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Set ult_mean for earliest origin period to latest.</span></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>bcl_summary.at[<span class="dv">0</span>, <span class="st">"ult_mean"</span>] <span class="op">=</span> bcl_summary.at[<span class="dv">0</span>, <span class="st">"latest"</span>]</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Boostrap chain ladder summary by origin:"</span>)</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>bcl_summary.<span class="bu">round</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Boostrap chain ladder summary by origin:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">origin</th>
<th data-quarto-table-cell-role="th">latest</th>
<th data-quarto-table-cell-role="th">ult_mean</th>
<th data-quarto-table-cell-role="th">ibnr_mean</th>
<th data-quarto-table-cell-role="th">ibnr_se</th>
<th data-quarto-table-cell-role="th">ibnr_75th</th>
<th data-quarto-table-cell-role="th">ibnr_95th</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1981</td>
<td>18834.0</td>
<td>18834.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1982</td>
<td>16704.0</td>
<td>16656.0</td>
<td>317.0</td>
<td>625.0</td>
<td>344.0</td>
<td>1511.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1983</td>
<td>23466.0</td>
<td>24708.0</td>
<td>1032.0</td>
<td>1182.0</td>
<td>1489.0</td>
<td>3412.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1984</td>
<td>27067.0</td>
<td>29353.0</td>
<td>2297.0</td>
<td>1881.0</td>
<td>3089.0</td>
<td>6149.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1985</td>
<td>26180.0</td>
<td>29833.0</td>
<td>3414.0</td>
<td>2300.0</td>
<td>4627.0</td>
<td>7669.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>1986</td>
<td>15852.0</td>
<td>20111.0</td>
<td>4056.0</td>
<td>2354.0</td>
<td>5471.0</td>
<td>8261.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1987</td>
<td>12314.0</td>
<td>18474.0</td>
<td>5997.0</td>
<td>3381.0</td>
<td>7956.0</td>
<td>11957.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>1988</td>
<td>13112.0</td>
<td>24511.0</td>
<td>11401.0</td>
<td>4810.0</td>
<td>14397.0</td>
<td>20429.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1989</td>
<td>5395.0</td>
<td>16590.0</td>
<td>11195.0</td>
<td>6314.0</td>
<td>14628.0</td>
<td>22886.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>1990</td>
<td>2063.0</td>
<td>19705.0</td>
<td>17697.0</td>
<td>13470.0</td>
<td>25418.0</td>
<td>43102.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>While results by origin can be useful, typically actuaries are more interested in the aggregate view. To get aggregate results, we first group by simulation number, then proceed as in the prior cell:</p>
<div id="cell-43" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate bootstrap chain ladder results.</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>agg_ults <span class="op">=</span> dfults.groupby(<span class="st">"n"</span>)[<span class="st">"ult"</span>].<span class="bu">sum</span>()</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>agg_ibnr <span class="op">=</span> dfibnr.groupby(<span class="st">"n"</span>)[<span class="st">"ibnr"</span>].<span class="bu">sum</span>()</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>dsumm <span class="op">=</span> {</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latest"</span>: [latest[<span class="st">"latest"</span>].<span class="bu">sum</span>().item()],</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ult_mean"</span>: [agg_ults.mean().item()],</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ibnr_mean"</span>: [agg_ibnr.mean().item()],</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ibnr_se"</span>: [agg_ibnr.std(ddof<span class="op">=</span><span class="dv">1</span>).item()],</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ibnr_75th"</span>: [agg_ibnr.quantile(<span class="fl">.75</span>).item()],</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ibnr_95th"</span>: [agg_ibnr.quantile(<span class="fl">.95</span>).item()]</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>bcl_summary_total <span class="op">=</span> pd.DataFrame().from_dict(dsumm, orient<span class="op">=</span><span class="st">"columns"</span>)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>bcl_summary_total.index <span class="op">=</span> [<span class="st">"total"</span>]</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Boostrap chain ladder summary in total:"</span>)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>bcl_summary_total.<span class="bu">round</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Boostrap chain ladder summary in total:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">latest</th>
<th data-quarto-table-cell-role="th">ult_mean</th>
<th data-quarto-table-cell-role="th">ibnr_mean</th>
<th data-quarto-table-cell-role="th">ibnr_se</th>
<th data-quarto-table-cell-role="th">ibnr_75th</th>
<th data-quarto-table-cell-role="th">ibnr_95th</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">total</td>
<td>160987.0</td>
<td>218945.0</td>
<td>57408.0</td>
<td>19025.0</td>
<td>69557.0</td>
<td>91763.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
</section>
<section id="visualizing-bootstrap-chain-ladder-results" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-bootstrap-chain-ladder-results">Visualizing Bootstrap Chain Ladder Results</h2>
<p>We can visualize actuals and predictions together by origin out to ultimate with 90% prediction intervals for each forecast period. Starting with <code>sqrd_tris</code>, we transform the data to make it easier for plotting:</p>
<div id="cell-45" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>dflist <span class="op">=</span> []</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tri <span class="kw">in</span> sqrd_ctris:</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    dftri <span class="op">=</span> (</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        tri</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        .rename({<span class="st">"index"</span>: <span class="st">"origin"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        .melt(id_vars<span class="op">=</span><span class="st">"origin"</span>, var_name<span class="op">=</span><span class="st">"dev"</span>, value_name<span class="op">=</span><span class="st">"bcl_value"</span>)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    dflist.append(dftri)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    pd.concat(dflist)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"origin"</span>, <span class="st">"dev"</span>])</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute mean, 5th and 95th percentile of prediction interval for each forecast period.</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"origin"</span>, <span class="st">"dev"</span>], as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">"bcl_value"</span>]</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>    .agg({</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bcl_mean"</span>: <span class="kw">lambda</span> v: v.mean(), </span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bcl_95th"</span>: <span class="kw">lambda</span> v: v.quantile(<span class="fl">.95</span>),</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"bcl_5th"</span>: <span class="kw">lambda</span> v: v.quantile(<span class="fl">.05</span>)</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach actual values from original cumulative triangle.</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>dfctri0 <span class="op">=</span> (</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>    ctri0</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    .rename_axis(<span class="va">None</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>    .rename({<span class="st">"index"</span>: <span class="st">"origin"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>    .melt(id_vars<span class="op">=</span><span class="st">"origin"</span>, var_name<span class="op">=</span><span class="st">"dev"</span>, value_name<span class="op">=</span><span class="st">"actual_value"</span>)</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.merge(dfctri0, on<span class="op">=</span>[<span class="st">"origin"</span>, <span class="st">"dev"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a><span class="co"># If actual_value is nan, then dev is a prediction for that origin. Otherwise</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="co"># it is an actual value. </span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"actual_devp_ind"</span>] <span class="op">=</span> df[<span class="st">"actual_value"</span>].<span class="bu">map</span>(<span class="kw">lambda</span> v: <span class="dv">1</span> <span class="cf">if</span> <span class="kw">not</span> np.isnan(v) <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"value"</span>] <span class="op">=</span> df.<span class="bu">apply</span>(<span class="kw">lambda</span> r: r.bcl_mean <span class="cf">if</span> r.actual_devp_ind<span class="op">==</span><span class="dv">0</span> <span class="cf">else</span> r.actual_value, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>df.tail(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">origin</th>
<th data-quarto-table-cell-role="th">dev</th>
<th data-quarto-table-cell-role="th">bcl_mean</th>
<th data-quarto-table-cell-role="th">bcl_95th</th>
<th data-quarto-table-cell-role="th">bcl_5th</th>
<th data-quarto-table-cell-role="th">actual_value</th>
<th data-quarto-table-cell-role="th">actual_devp_ind</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">90</td>
<td>1990</td>
<td>1</td>
<td>2007.64245</td>
<td>4475.13715</td>
<td>-225.44698</td>
<td>2063.0</td>
<td>1</td>
<td>2063.00000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">91</td>
<td>1990</td>
<td>2</td>
<td>6411.97786</td>
<td>16077.09339</td>
<td>55.49594</td>
<td>NaN</td>
<td>0</td>
<td>6411.97786</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92</td>
<td>1990</td>
<td>3</td>
<td>10426.91522</td>
<td>25457.57282</td>
<td>480.91586</td>
<td>NaN</td>
<td>0</td>
<td>10426.91522</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93</td>
<td>1990</td>
<td>4</td>
<td>13338.07408</td>
<td>32439.26914</td>
<td>760.56725</td>
<td>NaN</td>
<td>0</td>
<td>13338.07408</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">94</td>
<td>1990</td>
<td>5</td>
<td>15634.70194</td>
<td>37986.93978</td>
<td>916.68155</td>
<td>NaN</td>
<td>0</td>
<td>15634.70194</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">95</td>
<td>1990</td>
<td>6</td>
<td>17448.74348</td>
<td>41542.91512</td>
<td>1175.72687</td>
<td>NaN</td>
<td>0</td>
<td>17448.74348</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">96</td>
<td>1990</td>
<td>7</td>
<td>18163.22153</td>
<td>43856.27381</td>
<td>1217.23798</td>
<td>NaN</td>
<td>0</td>
<td>18163.22153</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">97</td>
<td>1990</td>
<td>8</td>
<td>18840.41438</td>
<td>45536.31744</td>
<td>1285.16070</td>
<td>NaN</td>
<td>0</td>
<td>18840.41438</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">98</td>
<td>1990</td>
<td>9</td>
<td>19316.41732</td>
<td>46515.62726</td>
<td>1348.81827</td>
<td>NaN</td>
<td>0</td>
<td>19316.41732</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">99</td>
<td>1990</td>
<td>10</td>
<td>19705.03950</td>
<td>47359.46502</td>
<td>1398.32997</td>
<td>NaN</td>
<td>0</td>
<td>19705.03950</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<p>Actuals with forecasts by origin year with 90% prediction intervals:</p>
<div id="cell-47" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> MaxNLocator</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>fill_color <span class="op">=</span> <span class="st">"#FFC04C"</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume 9 origin periods (no distribution of fully-developed oldest origin period)</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> [(<span class="dv">0</span>, <span class="dv">0</span>), (<span class="dv">0</span>, <span class="dv">1</span>), (<span class="dv">0</span>, <span class="dv">2</span>), (<span class="dv">1</span>, <span class="dv">0</span>), (<span class="dv">1</span>, <span class="dv">1</span>), (<span class="dv">1</span>, <span class="dv">2</span>), (<span class="dv">2</span>, <span class="dv">0</span>), (<span class="dv">2</span>, <span class="dv">1</span>), (<span class="dv">2</span>, <span class="dv">2</span>)]</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>origin_periods <span class="op">=</span> tri0.index[<span class="dv">1</span>:].tolist()</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), tight_layout<span class="op">=</span><span class="va">True</span>, sharex<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ii, jj), origin <span class="kw">in</span> <span class="bu">zip</span>(indices, origin_periods):</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    dforigin <span class="op">=</span> df[df.origin<span class="op">==</span>origin]</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_title(<span class="ss">f"</span><span class="sc">{</span>origin<span class="sc">}</span><span class="ss">"</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get last actual development period for origin.</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    last_actual_devp <span class="op">=</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">1</span>].dev.<span class="bu">max</span>()</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Actual values.</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    act_dev <span class="op">=</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">1</span>].dev.tolist()</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    act_val <span class="op">=</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">1</span>].value.tolist()</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predicted values.</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    pred_dev <span class="op">=</span> [last_actual_devp] <span class="op">+</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">0</span>].dev.tolist()</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    pred_val <span class="op">=</span> [act_val[<span class="op">-</span><span class="dv">1</span>]] <span class="op">+</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">0</span>].value.tolist()</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5th and 95th percentiles.</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    pred_5th <span class="op">=</span> [act_val[<span class="op">-</span><span class="dv">1</span>]] <span class="op">+</span>  dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">0</span>].bcl_5th.tolist()</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    pred_95th <span class="op">=</span> [act_val[<span class="op">-</span><span class="dv">1</span>]] <span class="op">+</span> dforigin[dforigin.actual_devp_ind<span class="op">==</span><span class="dv">0</span>].bcl_95th.tolist()</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].plot(</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>        pred_dev, pred_val, <span class="st">"o"</span>, markersize<span class="op">=</span><span class="dv">7</span>, color<span class="op">=</span><span class="st">"#1d2951"</span>, markerfacecolor<span class="op">=</span><span class="st">"#FFFFFF"</span>, </span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>        markeredgecolor<span class="op">=</span><span class="st">"#1d2951"</span>, markeredgewidth<span class="op">=</span><span class="fl">.35</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">1.</span>, label<span class="op">=</span><span class="st">"predicted"</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].plot(</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>        act_dev, act_val, <span class="st">"o"</span>, markersize<span class="op">=</span><span class="dv">7</span>, color<span class="op">=</span><span class="st">"#1d2951"</span>, markerfacecolor<span class="op">=</span><span class="st">"#1d2951"</span>, </span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>         markeredgecolor<span class="op">=</span><span class="st">"#1d2951"</span>, markeredgewidth<span class="op">=</span><span class="fl">.35</span>, linestyle<span class="op">=</span><span class="st">"-"</span>, linewidth<span class="op">=</span><span class="fl">1.</span>, label<span class="op">=</span><span class="st">"actual"</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].plot(</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>        pred_dev, pred_95th, color<span class="op">=</span><span class="st">"#000000"</span>, linestyle<span class="op">=</span><span class="st">":"</span>,  <span class="co"># color="#FFFFB2",</span></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">.75</span>, label<span class="op">=</span><span class="st">"95th percentile"</span></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].plot(</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>        pred_dev, pred_5th, color<span class="op">=</span><span class="st">"#000000"</span>, linestyle<span class="op">=</span><span class="st">"-."</span>,  <span class="co"># color="#FFFFB2",</span></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">.75</span>, label<span class="op">=</span><span class="st">"5th percentile"</span></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].fill_between(pred_dev, pred_5th, pred_95th, color<span class="op">=</span>fill_color, alpha<span class="op">=</span><span class="fl">.50</span>)</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].xaxis.set_major_formatter(mpl.ticker.StrMethodFormatter(<span class="st">"</span><span class="sc">{x:,.0f}</span><span class="st">"</span>))</span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].get_yaxis().set_major_formatter(mpl.ticker.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="bu">format</span>(<span class="bu">int</span>(x), <span class="st">','</span>)))</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].xaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].yaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].grid(<span class="va">True</span>)   </span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_axisbelow(<span class="va">True</span>) </span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].legend(loc<span class="op">=</span><span class="st">"upper left"</span>, fancybox<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="dv">1</span>, fontsize<span class="op">=</span><span class="st">"x-small"</span>)</span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Bootstrap chain ladder forecasts with 90% prediction interval"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bootstrap-chainladder-pandas_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>As expected, the prediction intervals grow wider for origin periods with fewer development periods of actual data to account for the greater uncertainty in ultimate projections.</p>
<p>Second, an exhibit with a separate histogram per facet can be used to visualize the distribution of IBNR generated by the bootstrap chain ladder:</p>
<div id="cell-49" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Color for each histogram.</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>hist_color <span class="op">=</span> <span class="st">"#5473ff"</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume 9 origin periods (no distribution of fully-developed oldest origin period)</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> [(<span class="dv">0</span>, <span class="dv">0</span>), (<span class="dv">0</span>, <span class="dv">1</span>), (<span class="dv">0</span>, <span class="dv">2</span>), (<span class="dv">1</span>, <span class="dv">0</span>), (<span class="dv">1</span>, <span class="dv">1</span>), (<span class="dv">1</span>, <span class="dv">2</span>), (<span class="dv">2</span>, <span class="dv">0</span>), (<span class="dv">2</span>, <span class="dv">1</span>), (<span class="dv">2</span>, <span class="dv">2</span>)]</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>origin_periods <span class="op">=</span> tri0.index[<span class="dv">1</span>:].tolist()</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>), tight_layout<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ii, jj), origin <span class="kw">in</span> <span class="bu">zip</span>(indices, origin_periods):</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_title(<span class="bu">str</span>(origin), fontsize<span class="op">=</span><span class="dv">8</span>, weight<span class="op">=</span><span class="st">"normal"</span>)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].hist(</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>        dfibnr[dfibnr.origin<span class="op">==</span>origin].ibnr, <span class="dv">20</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>hist_color, edgecolor<span class="op">=</span><span class="st">"#FFFFFF"</span>, linewidth<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ax[ii, jj].yaxis.set_major_formatter(mpl.ticker.StrMethodFormatter("{x:,.0f}"))</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_yticklabels([])</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].xaxis.set_major_formatter(mpl.ticker.StrMethodFormatter(<span class="st">"</span><span class="sc">{x:,.0f}</span><span class="st">"</span>))</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"minor"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"minor"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].xaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].yaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].grid(<span class="va">True</span>)   </span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>    ax[ii, jj].set_axisbelow(<span class="va">True</span>) </span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Boostrap chain ladder: IBNR by origin"</span>, fontsize<span class="op">=</span><span class="dv">9</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bootstrap-chainladder-pandas_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>Finally, we can create a similar exhibit for the aggregate distribution of IBNR, with vertical lines added at the 50th, 75th, 95th and 99th percentile of total needed reserve:</p>
<div id="cell-51" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>hist_color <span class="op">=</span> <span class="st">"#5473ff"</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>dfibnr_total <span class="op">=</span> dfibnr.groupby(<span class="st">"n"</span>, as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">"ibnr"</span>].<span class="bu">sum</span>()</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>ibnr_total <span class="op">=</span> dfibnr_total[<span class="st">"ibnr"</span>].values</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>ibnr_50 <span class="op">=</span> np.quantile(ibnr_total, <span class="fl">.50</span>).item()</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>ibnr_75 <span class="op">=</span> np.quantile(ibnr_total, <span class="fl">.75</span>).item()</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>ibnr_95 <span class="op">=</span> np.quantile(ibnr_total, <span class="fl">.95</span>).item()</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>ibnr_99 <span class="op">=</span> np.quantile(ibnr_total, <span class="fl">.99</span>).item()</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="fl">7.5</span>, <span class="fl">5.25</span>), tight_layout<span class="op">=</span><span class="va">True</span>) </span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Bootstrap chain ladder: total IBNR"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>ax.hist(</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    ibnr_total, <span class="dv">27</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span>hist_color, </span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">"#FFFFFF"</span>, linewidth<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 50th percentile.</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>ax.axvline(ibnr_50, color<span class="op">=</span><span class="st">"#000000"</span>, linewidth<span class="op">=</span><span class="fl">1.25</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>ax.annotate(</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r"$p_</span><span class="sc">{{</span><span class="vs">50</span><span class="sc">}}</span><span class="vs"> = </span><span class="sc">{:,.0f}</span><span class="vs">$"</span>.<span class="bu">format</span>(ibnr_50), xycoords<span class="op">=</span><span class="st">"data"</span>, xy<span class="op">=</span>(ibnr_50, <span class="fl">2e-5</span>),</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">90</span>, weight<span class="op">=</span><span class="st">"normal"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    textcoords<span class="op">=</span><span class="st">"offset pixels"</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 75th percentile.</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>ax.axvline(ibnr_75, color<span class="op">=</span><span class="st">"#000000"</span>, linewidth<span class="op">=</span><span class="fl">1.25</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>ax.annotate(</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r"$p_</span><span class="sc">{{</span><span class="vs">75</span><span class="sc">}}</span><span class="vs"> = </span><span class="sc">{:,.0f}</span><span class="vs">$"</span>.<span class="bu">format</span>(ibnr_75), xycoords<span class="op">=</span><span class="st">"data"</span>, xy<span class="op">=</span>(ibnr_75, <span class="fl">2e-5</span>),</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">90</span>, weight<span class="op">=</span><span class="st">"normal"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    textcoords<span class="op">=</span><span class="st">"offset pixels"</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile.</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>ax.axvline(ibnr_95, color<span class="op">=</span><span class="st">"#000000"</span>, linewidth<span class="op">=</span><span class="fl">1.25</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>ax.annotate(</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r"$p_</span><span class="sc">{{</span><span class="vs">95</span><span class="sc">}}</span><span class="vs"> = </span><span class="sc">{:,.0f}</span><span class="vs">$"</span>.<span class="bu">format</span>(ibnr_95), xycoords<span class="op">=</span><span class="st">"data"</span>, xy<span class="op">=</span>(ibnr_95, <span class="fl">2e-5</span>),</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">90</span>, weight<span class="op">=</span><span class="st">"normal"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>    textcoords<span class="op">=</span><span class="st">"offset pixels"</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 99th percentile.</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>ax.axvline(ibnr_99, color<span class="op">=</span><span class="st">"#000000"</span>, linewidth<span class="op">=</span><span class="fl">1.25</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>ax.annotate(</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r"$p_</span><span class="sc">{{</span><span class="vs">99</span><span class="sc">}}</span><span class="vs"> = </span><span class="sc">{:,.0f}</span><span class="vs">$"</span>.<span class="bu">format</span>(ibnr_99), xycoords<span class="op">=</span><span class="st">"data"</span>, xy<span class="op">=</span>(ibnr_99, <span class="fl">2e-5</span>),</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">11</span>, rotation<span class="op">=</span><span class="dv">90</span>, weight<span class="op">=</span><span class="st">"normal"</span>, color<span class="op">=</span><span class="st">"#000000"</span>, xytext<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">0</span>), </span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>    textcoords<span class="op">=</span><span class="st">"offset pixels"</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ax[ii, jj].yaxis.set_major_formatter(mpl.ticker.StrMethodFormatter("{x:,.0f}"))</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels([])</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_formatter(mpl.ticker.StrMethodFormatter(<span class="st">"</span><span class="sc">{x:,.0f}</span><span class="st">"</span>))</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>ax.tick_params(axis<span class="op">=</span><span class="st">"x"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a><span class="co"># ax.tick_params(axis="x", which="minor", direction='in', labelsize=8)</span></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a>ax.tick_params(axis<span class="op">=</span><span class="st">"y"</span>, which<span class="op">=</span><span class="st">"major"</span>, direction<span class="op">=</span><span class="st">'in'</span>, labelsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ax.tick_params(axis="y", which="minor", direction='in', labelsize=8)</span></span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_ticks_position(<span class="st">"none"</span>)</span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>)   </span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>ax.set_axisbelow(<span class="va">True</span>) </span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="bootstrap-chainladder-pandas_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><br></p>
<p>Existing third-party Python libraries such as <a href="https://trikit.github.io/trikit-docs/quickstart.html">trikit</a> expose a number of models that can be used to estimate outstanding claim liabilities, but it can be helpful to see in detail how these estimates are obtained. Other loss reserving techniques will be explored in future posts.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.jtrive\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>